import{u as Ur,a as Dr,b as Mr,i as ie,c as Fr,d as zr,e as wt,w as rs,g as Cs,f as vs,h as Ts,C as Is,j as Vr,k as Kr,B as Qe,X as As,Y as Ns,l as Hr,m as x,R as Jr,T as Wr,L as Gr,n as ft}from"./generateCategoricalChart.CFXWUMdx.js";import{R as D,r as Ee}from"./index.DJO9vBfz.js";class v extends Error{code;rawCode;constructor(e,s,r,n){s!==void 0&&(e=`${s}: ${e}`),super(e,{cause:n}),this.code=s,this.rawCode=r,this.name="LibsqlError"}}function Yr(t){const e=Zr.exec(t);if(e===null)throw new v("The URL is not in a valid format","URL_INVALID");const s=e.groups,r=s.scheme,n=s.authority!==void 0?Xr(s.authority):void 0,i=de(s.path),o=s.query!==void 0?tn(s.query):void 0,a=s.fragment!==void 0?de(s.fragment):void 0;return{scheme:r,authority:n,path:i,query:o,fragment:a}}const Zr=(()=>{const t="(?<scheme>[A-Za-z][A-Za-z.+-]*)",e="(?<authority>[^/?#]*)",s="(?<path>[^?#]*)",r="(?<query>[^#]*)",n="(?<fragment>.*)";return new RegExp(`^${t}:(//${e})?${s}(\\?${r})?(#${n})?$`,"su")})();function Xr(t){const e=en.exec(t);if(e===null)throw new v("The authority part of the URL is not in a valid format","URL_INVALID");const s=e.groups,r=de(s.host_br??s.host),n=s.port?parseInt(s.port,10):void 0,i=s.username!==void 0?{username:de(s.username),password:s.password!==void 0?de(s.password):void 0}:void 0;return{host:r,port:n,userinfo:i}}const en=new RegExp("^((?<username>[^:]*)(:(?<password>.*))?@)?((?<host>[^:\\[\\]]*)|(\\[(?<host_br>[^\\[\\]]*)\\]))(:(?<port>[0-9]*))?$","su");function tn(t){const e=t.split("&"),s=[];for(const r of e){if(r==="")continue;let n,i;const o=r.indexOf("=");o<0?(n=r,i=""):(n=r.substring(0,o),i=r.substring(o+1)),s.push({key:de(n.replaceAll("+"," ")),value:de(i.replaceAll("+"," "))})}return{pairs:s}}function de(t){try{return decodeURIComponent(t)}catch(e){throw e instanceof URIError?new v(`URL component has invalid percent encoding: ${e}`,"URL_INVALID",void 0,e):e}}function gt(t,e,s){if(e===void 0)throw new v(`URL with scheme ${JSON.stringify(t+":")} requires authority (the "//" part)`,"URL_INVALID");const r=`${t}:`,n=sn(e.host),i=rn(e.port),a=`//${nn(e.userinfo)}${n}${i}`;let l=s.split("/").map(encodeURIComponent).join("/");return l!==""&&!l.startsWith("/")&&(l="/"+l),new URL(`${r}${a}${l}`)}function sn(t){return t.includes(":")?`[${encodeURI(t)}]`:encodeURI(t)}function rn(t){return t!==void 0?`:${t}`:""}function nn(t){if(t===void 0)return"";const e=encodeURIComponent(t.username),s=t.password!==void 0?`:${encodeURIComponent(t.password)}`:"";return`${e}${s}@`}const Os="3.7.7",on=Os,Ae=typeof Buffer=="function",ns=typeof TextDecoder=="function"?new TextDecoder:void 0,is=typeof TextEncoder=="function"?new TextEncoder:void 0,an="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Be=Array.prototype.slice.call(an),He=(t=>{let e={};return t.forEach((s,r)=>e[s]=r),e})(Be),ln=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,B=String.fromCharCode.bind(String),os=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),$s=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),Ls=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),Es=t=>{let e,s,r,n,i="";const o=t.length%3;for(let a=0;a<t.length;){if((s=t.charCodeAt(a++))>255||(r=t.charCodeAt(a++))>255||(n=t.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=s<<16|r<<8|n,i+=Be[e>>18&63]+Be[e>>12&63]+Be[e>>6&63]+Be[e&63]}return o?i.slice(0,o-3)+"===".substring(o):i},Pt=typeof btoa=="function"?t=>btoa(t):Ae?t=>Buffer.from(t,"binary").toString("base64"):Es,St=Ae?t=>Buffer.from(t).toString("base64"):t=>{let s=[];for(let r=0,n=t.length;r<n;r+=4096)s.push(B.apply(null,t.subarray(r,r+4096)));return Pt(s.join(""))},Ye=(t,e=!1)=>e?$s(St(t)):St(t),un=t=>{if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?B(192|e>>>6)+B(128|e&63):B(224|e>>>12&15)+B(128|e>>>6&63)+B(128|e&63)}else{var e=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return B(240|e>>>18&7)+B(128|e>>>12&63)+B(128|e>>>6&63)+B(128|e&63)}},cn=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,Ps=t=>t.replace(cn,un),as=Ae?t=>Buffer.from(t,"utf8").toString("base64"):is?t=>St(is.encode(t)):t=>Pt(Ps(t)),_e=(t,e=!1)=>e?$s(as(t)):as(t),ls=t=>_e(t,!0),hn=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,dn=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),s=e-65536;return B((s>>>10)+55296)+B((s&1023)+56320);case 3:return B((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return B((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},Qs=t=>t.replace(hn,dn),Bs=t=>{if(t=t.replace(/\s+/g,""),!ln.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,s="",r,n;for(let i=0;i<t.length;)e=He[t.charAt(i++)]<<18|He[t.charAt(i++)]<<12|(r=He[t.charAt(i++)])<<6|(n=He[t.charAt(i++)]),s+=r===64?B(e>>16&255):n===64?B(e>>16&255,e>>8&255):B(e>>16&255,e>>8&255,e&255);return s},Qt=typeof atob=="function"?t=>atob(Ls(t)):Ae?t=>Buffer.from(t,"base64").toString("binary"):Bs,js=Ae?t=>os(Buffer.from(t,"base64")):t=>os(Qt(t).split("").map(e=>e.charCodeAt(0))),ks=t=>js(Us(t)),fn=Ae?t=>Buffer.from(t,"base64").toString("utf8"):ns?t=>ns.decode(js(t)):t=>Qs(Qt(t)),Us=t=>Ls(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),xt=t=>fn(Us(t)),pn=t=>{if(typeof t!="string")return!1;const e=t.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(e)||!/[^\s0-9a-zA-Z\-_]/.test(e)},Ds=t=>({value:t,enumerable:!1,writable:!0,configurable:!0}),Ms=function(){const t=(e,s)=>Object.defineProperty(String.prototype,e,Ds(s));t("fromBase64",function(){return xt(this)}),t("toBase64",function(e){return _e(this,e)}),t("toBase64URI",function(){return _e(this,!0)}),t("toBase64URL",function(){return _e(this,!0)}),t("toUint8Array",function(){return ks(this)})},Fs=function(){const t=(e,s)=>Object.defineProperty(Uint8Array.prototype,e,Ds(s));t("toBase64",function(e){return Ye(this,e)}),t("toBase64URI",function(){return Ye(this,!0)}),t("toBase64URL",function(){return Ye(this,!0)})},mn=()=>{Ms(),Fs()},Bt={version:Os,VERSION:on,atob:Qt,atobPolyfill:Bs,btoa:Pt,btoaPolyfill:Es,fromBase64:xt,toBase64:_e,encode:_e,encodeURI:ls,encodeURL:ls,utob:Ps,btou:Qs,decode:xt,isValid:pn,fromUint8Array:Ye,toUint8Array:ks,extendString:Ms,extendUint8Array:Fs,extendBuiltins:mn},De="https://github.com/libsql/libsql-client-ts#supported-urls";function qt(t){if(t==="write")return"BEGIN IMMEDIATE";if(t==="read")return"BEGIN TRANSACTION READONLY";if(t==="deferred")return"BEGIN DEFERRED";throw RangeError('Unknown transaction mode, supported values are "write", "read" and "deferred"')}class yn{columns;columnTypes;rows;rowsAffected;lastInsertRowid;constructor(e,s,r,n,i){this.columns=e,this.columnTypes=s,this.rows=r,this.rowsAffected=n,this.lastInsertRowid=i}toJSON(){return{columns:this.columns,columnTypes:this.columnTypes,rows:this.rows.map(bn),rowsAffected:this.rowsAffected,lastInsertRowid:this.lastInsertRowid!==void 0?""+this.lastInsertRowid:null}}}function bn(t){return Array.prototype.map.call(t,wn)}function wn(t){return typeof t=="bigint"?""+t:t instanceof ArrayBuffer?Bt.fromUint8Array(new Uint8Array(t)):t}function gn(t,e){if(typeof t!="object")throw new TypeError(`Expected client configuration as object, got ${typeof t}`);let s=t.tls,r=t.authToken,n=t.encryptionKey,i=t.syncUrl,o=t.syncInterval;const a=""+(t.intMode??"number");if(a!=="number"&&a!=="bigint"&&a!=="string")throw new TypeError(`Invalid value for intMode, expected "number", "bigint" or "string",             got ${JSON.stringify(a)}`);if(t.url===":memory:")return{path:":memory:",scheme:"file",syncUrl:i,syncInterval:o,intMode:a,fetch:t.fetch,tls:!1,authToken:void 0,encryptionKey:void 0,authority:void 0};const l=Yr(t.url);for(const{key:m,value:y}of l.query?.pairs??[])if(m==="authToken")r=y||void 0;else if(m==="tls")if(y==="0")s=!1;else if(y==="1")s=!0;else throw new v(`Unknown value for the "tls" query argument: ${JSON.stringify(y)}. Supported values are "0" and "1"`,"URL_INVALID");else throw new v(`Unknown URL query parameter ${JSON.stringify(m)}`,"URL_PARAM_NOT_SUPPORTED");const u=l.scheme.toLowerCase();let h;if(u==="libsql")if(s===!1){if(l.authority?.port===void 0)throw new v('A "libsql:" URL with ?tls=0 must specify an explicit port',"URL_INVALID");h="http"}else h="https";else if(u==="http"||u==="ws")h=u,s??=!1;else if(u==="https"||u==="wss"||u==="file")h=u;else throw new v(`The client supports only "libsql:", "wss:", "ws:", "https:", "http:" and "file:" URLs, got ${JSON.stringify(l.scheme+":")}. For more information, please read ${De}`,"URL_SCHEME_NOT_SUPPORTED");if(l.fragment!==void 0)throw new v(`URL fragments are not supported: ${JSON.stringify("#"+l.fragment)}`,"URL_INVALID");return{scheme:h,tls:s??!0,authority:l.authority,path:l.path,authToken:r,encryptionKey:n,syncUrl:i,syncInterval:o,intMode:a,fetch:t.fetch}}let Se;typeof WebSocket<"u"?Se=WebSocket:typeof global<"u"?Se=global.WebSocket:typeof window<"u"?Se=window.WebSocket:typeof self<"u"&&(Se=self.WebSocket);class zs{constructor(){this.intMode="number"}intMode}class O extends Error{constructor(e){super(e),this.name="ClientError"}}class q extends O{constructor(e){super(e),this.name="ProtoError"}}class Vs extends O{code;proto;constructor(e,s){super(e),this.name="ResponseError",this.code=s.code,this.proto=s,this.stack=void 0}}class W extends O{constructor(e,s){s!==void 0?(super(`${e}: ${s}`),this.cause=s):super(e),this.name="ClosedError"}}class Ks extends O{constructor(e){super(e),this.name="WebSocketUnsupportedError"}}class _t extends O{constructor(e){super(e),this.name="WebSocketError"}}class Hs extends O{status;constructor(e,s){super(e),this.status=s,this.name="HttpServerError"}}class Ce extends O{constructor(e){super(e),this.name="ProtocolVersionError"}}class ae extends O{constructor(e){super(e),this.name="InternalError"}}class Ne extends O{constructor(e){super(e),this.name="MisuseError"}}function Z(t){if(typeof t=="string")return t;throw Oe(t,"string")}function X(t){if(t!=null){if(typeof t=="string")return t;throw Oe(t,"string or null")}}function fe(t){if(typeof t=="number")return t;throw Oe(t,"number")}function Me(t){if(typeof t=="boolean")return t;throw Oe(t,"boolean")}function Xe(t){if(Array.isArray(t))return t;throw Oe(t,"array")}function k(t){if(t!==null&&typeof t=="object"&&!Array.isArray(t))return t;throw Oe(t,"object")}function le(t,e){return Xe(t).map(s=>e(k(s)))}function Oe(t,e){if(t===void 0)return new q(`Expected ${e}, but the property was missing`);let s=typeof t;return t===null?s="null":Array.isArray(t)&&(s="array"),new q(`Expected ${e}, received ${s}`)}function jt(t,e){return e(k(t))}class Sn{#e;#t;constructor(e){this.#e=e,this.#t=!1}begin(){this.#e.push("{"),this.#t=!0}end(){this.#e.push("}"),this.#t=!1}#s(e){this.#t?(this.#e.push('"'),this.#t=!1):this.#e.push(',"'),this.#e.push(e),this.#e.push('":')}string(e,s){this.#s(e),this.#e.push(JSON.stringify(s))}stringRaw(e,s){this.#s(e),this.#e.push('"'),this.#e.push(s),this.#e.push('"')}number(e,s){this.#s(e),this.#e.push(""+s)}boolean(e,s){this.#s(e),this.#e.push(s?"true":"false")}object(e,s,r){this.#s(e),this.begin(),r(this,s),this.end()}arrayObjects(e,s,r){this.#s(e),this.#e.push("[");for(let n=0;n<s.length;++n)n!==0&&this.#e.push(","),this.begin(),r(this,s[n]),this.end();this.#e.push("]")}}function Js(t,e){const s=[],r=new Sn(s);return r.begin(),e(r,t),r.end(),s.join("")}const ke=0,Rt=1,Ct=2,xn=5;class qn{#e;#t;#s;constructor(e){this.#e=e,this.#t=new DataView(e.buffer,e.byteOffset,e.byteLength),this.#s=0}varint(){let e=0;for(let s=0;;s+=7){const r=this.#e[this.#s++];if(e|=(r&127)<<s,!(r&128))break}return e}varintBig(){let e=0n;for(let s=0n;;s+=7n){const r=this.#e[this.#s++];if(e|=BigInt(r&127)<<s,!(r&128))break}return e}bytes(e){const s=new Uint8Array(this.#e.buffer,this.#e.byteOffset+this.#s,e);return this.#s+=e,s}double(){const e=this.#t.getFloat64(this.#s,!0);return this.#s+=8,e}skipVarint(){for(;this.#e[this.#s++]&128;);}skip(e){this.#s+=e}eof(){return this.#s>=this.#e.byteLength}}class _n{#e;#t;constructor(e){this.#e=e,this.#t=-1}setup(e){this.#t=e}#s(e){if(this.#t!==e)throw new q(`Expected wire type ${e}, got ${this.#t}`);this.#t=-1}bytes(){this.#s(Ct);const e=this.#e.varint();return this.#e.bytes(e)}string(){return new TextDecoder().decode(this.bytes())}message(e){return ot(this.bytes(),e)}int32(){return this.#s(ke),this.#e.varint()}uint32(){return this.int32()}bool(){return this.int32()!==0}uint64(){return this.#s(ke),this.#e.varintBig()}sint64(){const e=this.uint64();return e>>1n^-(e&1n)}double(){return this.#s(Rt),this.#e.double()}maybeSkip(){if(!(this.#t<0)){if(this.#t===ke)this.#e.skipVarint();else if(this.#t===Rt)this.#e.skip(8);else if(this.#t===Ct){const e=this.#e.varint();this.#e.skip(e)}else if(this.#t===xn)this.#e.skip(4);else throw new q(`Unexpected wire type ${this.#t}`);this.#t=-1}}}function ot(t,e){const s=new qn(t),r=new _n(s);let n=e.default();for(;!s.eof();){const i=s.varint(),o=i>>3,a=i&7;r.setup(a);const l=e[o];if(l!==void 0){const u=l(r,n);u!==void 0&&(n=u)}r.maybeSkip()}return n}class kt{#e;#t;#s;#r;constructor(){this.#e=new ArrayBuffer(256),this.#t=new Uint8Array(this.#e),this.#s=new DataView(this.#e),this.#r=0}#i(e){if(this.#r+e<=this.#e.byteLength)return;let s=this.#e.byteLength;for(;s<this.#r+e;)s*=2;const r=new ArrayBuffer(s),n=new Uint8Array(r),i=new DataView(r);n.set(new Uint8Array(this.#e,0,this.#r)),this.#e=r,this.#t=n,this.#s=i}#n(e){this.#i(5),e=0|e;do{let s=e&127;e>>>=7,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#o(e){this.#i(10),e=e&0xffffffffffffffffn;do{let s=Number(e&0x7fn);e>>=7n,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#a(e,s){this.#n(e<<3|s)}bytes(e,s){this.#a(e,Ct),this.#n(s.byteLength),this.#i(s.byteLength),this.#t.set(s,this.#r),this.#r+=s.byteLength}string(e,s){this.bytes(e,new TextEncoder().encode(s))}message(e,s,r){const n=new kt;r(n,s),this.bytes(e,n.data())}int32(e,s){this.#a(e,ke),this.#n(s)}uint32(e,s){this.int32(e,s)}bool(e,s){this.int32(e,s?1:0)}sint64(e,s){this.#a(e,ke),this.#o(s<<1n^s>>63n)}double(e,s){this.#a(e,Rt),this.#i(8),this.#s.setFloat64(this.#r,s,!0),this.#r+=8}data(){return new Uint8Array(this.#e,0,this.#r)}}function Ws(t,e){const s=new kt;return e(s,t),s.data()}class je{#e;#t;constructor(){this.#e=new Set,this.#t=new Set}alloc(){for(const s of this.#t)return this.#t.delete(s),this.#e.add(s),this.#e.has(this.#e.size-1)||this.#t.add(this.#e.size-1),s;const e=this.#e.size;return this.#e.add(e),e}free(e){if(!this.#e.delete(e))throw new ae("Freeing an id that is not allocated");this.#t.delete(this.#e.size),e<this.#e.size&&this.#t.add(e)}}function $(t,e){throw new ae(e)}function Ue(t){if(t===null)return null;if(typeof t=="string")return t;if(typeof t=="number"){if(!Number.isFinite(t))throw new RangeError("Only finite numbers (not Infinity or NaN) can be passed as arguments");return t}else if(typeof t=="bigint"){if(t<Rn||t>Cn)throw new RangeError("This bigint value is too large to be represented as a 64-bit integer and passed as argument");return t}else{if(typeof t=="boolean")return t?1n:0n;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(t instanceof Uint8Array)return t;if(t instanceof Date)return+t.valueOf();if(typeof t=="object")return""+t.toString();throw new TypeError("Unsupported type of value")}}const Rn=-9223372036854775808n,Cn=9223372036854775807n;function Gs(t,e){if(t===null)return null;if(typeof t=="number")return t;if(typeof t=="string")return t;if(typeof t=="bigint")if(e==="number"){const s=Number(t);if(!Number.isSafeInteger(s))throw new RangeError("Received integer which is too large to be safely represented as a JavaScript number");return s}else{if(e==="bigint")return t;if(e==="string")return""+t;throw new Ne("Invalid value for IntMode")}else{if(t instanceof Uint8Array)return t.slice().buffer;throw t===void 0?new q("Received unrecognized type of Value"):$(t,"Impossible type of Value")}}function ze(t){return{affectedRowCount:t.affectedRowCount,lastInsertRowid:t.lastInsertRowid,columnNames:t.cols.map(e=>e.name),columnDecltypes:t.cols.map(e=>e.decltype)}}function Ys(t,e){const s=ze(t),r=t.rows.map(n=>er(s.columnNames,n,e));return{...s,rows:r}}function Zs(t,e){const s=ze(t);let r;return t.rows.length>0&&(r=er(s.columnNames,t.rows[0],e)),{...s,row:r}}function Xs(t,e){const s=ze(t);let r;return t.rows.length>0&&s.columnNames.length>0&&(r=Gs(t.rows[0][0],e)),{...s,value:r}}function er(t,e,s){const r={};Object.defineProperty(r,"length",{value:e.length});for(let n=0;n<e.length;++n){const i=Gs(e[n],s);Object.defineProperty(r,n,{value:i});const o=t[n];o!==void 0&&!Object.hasOwn(r,o)&&Object.defineProperty(r,o,{value:i,enumerable:!0})}return r}function ve(t){return new Vs(t.message,t)}class Ut{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}_getSqlId(e){if(this.#e!==e)throw new Ne("Attempted to use SQL text opened with other object");if(this.#s!==void 0)throw new W("SQL text is closed",this.#s);return this.#t}close(){this._setClosed(new O("SQL text was manually closed"))}_setClosed(e){this.#s===void 0&&(this.#s=e,this.#e._closeSql(this.#t))}get closed(){return this.#s!==void 0}}function vt(t,e){return e instanceof Ut?{sqlId:e._getSqlId(t)}:{sql:""+e}}class et{#e;#t;constructor(){this.#e=[],this.#t=[]}get length(){return this.#e.length+this.#t.length}push(e){this.#e.push(e)}shift(){return this.#t.length===0&&this.#e.length>0&&(this.#t=this.#e.reverse(),this.#e=[]),this.#t.pop()}first(){return this.#t.length!==0?this.#t[this.#t.length-1]:this.#e[0]}}let Tt=class{sql;_args;_namedArgs;constructor(e){this.sql=e,this._args=[],this._namedArgs=new Map}bindIndexes(e){this._args.length=0;for(const s of e)this._args.push(Ue(s));return this}bindIndex(e,s){if(e!==(e|0)||e<=0)throw new RangeError("Index of a positional argument must be positive integer");for(;this._args.length<e;)this._args.push(null);return this._args[e-1]=Ue(s),this}bindName(e,s){return this._namedArgs.set(e,Ue(s)),this}unbindAll(){return this._args.length=0,this._namedArgs.clear(),this}};function tr(t,e,s){let r,n=[],i=[];if(e instanceof Tt){r=e.sql,n=e._args;for(const[l,u]of e._namedArgs.entries())i.push({name:l,value:u})}else Array.isArray(e)?(r=e[0],Array.isArray(e[1])?n=e[1].map(l=>Ue(l)):i=Object.entries(e[1]).map(([l,u])=>({name:l,value:Ue(u)}))):r=e;const{sql:o,sqlId:a}=vt(t,r);return{sql:o,sqlId:a,args:n,namedArgs:i,wantRows:s}}let vn=class{_stream;#e;_steps;#t;constructor(e,s){this._stream=e,this.#e=s,this._steps=[],this.#t=!1}step(){return new An(this)}execute(){if(this.#t)throw new Ne("This batch has already been executed");this.#t=!0;const e={steps:this._steps.map(s=>s.proto)};return this.#e?In(this._stream,this._steps,e):Tn(this._stream,this._steps,e)}};function Tn(t,e,s){return t._batch(s).then(r=>{for(let n=0;n<e.length;++n){const i=r.stepResults.get(n),o=r.stepErrors.get(n);e[n].callback(i,o)}})}async function In(t,e,s){const r=await t._openCursor(s);try{let n=0,i,o=[];for(;;){const a=await r.next();if(a===void 0)break;if(a.type==="step_begin"){if(a.step<n||a.step>=e.length)throw new q("Server produced StepBeginEntry for unexpected step");if(i!==void 0)throw new q("Server produced StepBeginEntry before terminating previous step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0);n=a.step+1,i=a,o=[]}else if(a.type==="step_end"){if(i===void 0)throw new q("Server produced StepEndEntry but no step is active");const l={cols:i.cols,rows:o,affectedRowCount:a.affectedRowCount,lastInsertRowid:a.lastInsertRowid};e[i.step].callback(l,void 0),i=void 0,o=[]}else if(a.type==="step_error"){if(i===void 0){if(a.step>=e.length)throw new q("Server produced StepErrorEntry for unexpected step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0)}else{if(a.step!==i.step)throw new q("Server produced StepErrorEntry for unexpected step");i=void 0,o=[]}e[a.step].callback(void 0,a.error),n=a.step+1}else if(a.type==="row"){if(i===void 0)throw new q("Server produced RowEntry but no step is active");o.push(a.row)}else throw a.type==="error"?ve(a.error):a.type==="none"?new q("Server produced unrecognized CursorEntry"):$(a,"Impossible CursorEntry")}if(i!==void 0)throw new q("Server closed Cursor before terminating active step");for(let a=n;a<e.length;++a)e[a].callback(void 0,void 0)}finally{r.close()}}let An=class{_batch;#e;_index;constructor(e){this._batch=e,this.#e=[],this._index=void 0}condition(e){return this.#e.push(e._proto),this}query(e){return this.#t(e,!0,Ys)}queryRow(e){return this.#t(e,!0,Zs)}queryValue(e){return this.#t(e,!0,Xs)}run(e){return this.#t(e,!1,ze)}#t(e,s,r){if(this._index!==void 0)throw new Ne("This BatchStep has already been added to the batch");const n=tr(this._batch._stream._sqlOwner(),e,s);let i;this.#e.length===0?i=void 0:this.#e.length===1?i=this.#e[0]:i={type:"and",conds:this.#e.slice()};const o={stmt:n,condition:i};return new Promise((a,l)=>{const u=(h,m)=>{h!==void 0&&m!==void 0?l(new q("Server returned both result and error")):m!==void 0?l(ve(m)):a(h!==void 0?r(h,this._batch._stream.intMode):void 0)};this._index=this._batch._steps.length,this._batch._steps.push({proto:o,callback:u})})}},z=class ce{_batch;_proto;constructor(e,s){this._batch=e,this._proto=s}static ok(e){return new ce(e._batch,{type:"ok",step:us(e)})}static error(e){return new ce(e._batch,{type:"error",step:us(e)})}static not(e){return new ce(e._batch,{type:"not",cond:e._proto})}static and(e,s){for(const r of s)cs(e,r);return new ce(e,{type:"and",conds:s.map(r=>r._proto)})}static or(e,s){for(const r of s)cs(e,r);return new ce(e,{type:"or",conds:s.map(r=>r._proto)})}static isAutocommit(e){return e._stream.client()._ensureVersion(3,"BatchCond.isAutocommit()"),new ce(e,{type:"is_autocommit"})}};function us(t){if(t._index===void 0)throw new Ne("Cannot add a condition referencing a step that has not been added to the batch");return t._index}function cs(t,e){if(e._batch!==t)throw new Ne("Cannot mix BatchCond objects for different Batch objects")}function Nn(t){return{paramNames:t.params.map(e=>e.name),columns:t.cols,isExplain:t.isExplain,isReadonly:t.isReadonly}}class sr{constructor(e){this.intMode=e}query(e){return this.#e(e,!0,Ys)}queryRow(e){return this.#e(e,!0,Zs)}queryValue(e){return this.#e(e,!0,Xs)}run(e){return this.#e(e,!1,ze)}#e(e,s,r){const n=tr(this._sqlOwner(),e,s);return this._execute(n).then(i=>r(i,this.intMode))}batch(e=!1){return new vn(this,e)}describe(e){const s=vt(this._sqlOwner(),e);return this._describe(s).then(Nn)}sequence(e){const s=vt(this._sqlOwner(),e);return this._sequence(s)}intMode}class rr{}const On=1e3,$n=10;class Ln extends rr{#e;#t;#s;#r;#i;#n;#o;constructor(e,s,r){super(),this.#e=e,this.#t=s,this.#s=r,this.#r=new et,this.#i=new et,this.#n=void 0,this.#o=!1}async next(){for(;;){if(this.#n!==void 0)throw new W("Cursor is closed",this.#n);for(;!this.#o&&this.#i.length<$n;)this.#i.push(this.#a());const e=this.#r.shift();if(this.#o||e!==void 0)return e;await this.#i.shift().then(s=>{if(s!==void 0){for(const r of s.entries)this.#r.push(r);this.#o||=s.done}})}}#a(){return this.#t._sendCursorRequest(this,{type:"fetch_cursor",cursorId:this.#s,maxCount:On}).then(e=>e,e=>{this._setClosed(e)})}_setClosed(e){this.#n===void 0&&(this.#n=e,this.#t._sendCursorRequest(this,{type:"close_cursor",cursorId:this.#s}).catch(()=>{}),this.#t._cursorClosed(this))}close(){this._setClosed(new O("Cursor was manually closed"))}get closed(){return this.#n!==void 0}}class Dt extends sr{#e;#t;#s;#r;#i;#n;static open(e){const s=e._streamIdAlloc.alloc(),r=new Dt(e,s),n=()=>{},i=a=>r.#u(a),o={type:"open_stream",streamId:s};return e._sendRequest(o,{responseCallback:n,errorCallback:i}),r}constructor(e,s){super(e.intMode),this.#e=e,this.#t=s,this.#s=new et,this.#r=void 0,this.#i=!1,this.#n=void 0}client(){return this.#e}_sqlOwner(){return this.#e}_execute(e){return this.#o({type:"execute",streamId:this.#t,stmt:e}).then(s=>s.result)}_batch(e){return this.#o({type:"batch",streamId:this.#t,batch:e}).then(s=>s.result)}_describe(e){return this.#e._ensureVersion(2,"describe()"),this.#o({type:"describe",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#e._ensureVersion(2,"sequence()"),this.#o({type:"sequence",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#o({type:"get_autocommit",streamId:this.#t}).then(e=>e.isAutocommit)}#o(e){return new Promise((s,r)=>{this.#a({type:"request",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return this.#e._ensureVersion(3,"cursor"),new Promise((s,r)=>{this.#a({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_sendCursorRequest(e,s){if(e!==this.#r)throw new ae("Cursor not associated with the stream attempted to execute a request");return new Promise((r,n)=>{this.#n!==void 0?n(new W("Stream is closed",this.#n)):this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})})}_cursorClosed(e){if(e!==this.#r)throw new ae("Cursor was closed, but it was not associated with the stream");this.#r=void 0,this.#l()}#a(e){this.#n!==void 0?e.errorCallback(new W("Stream is closed",this.#n)):this.#i?e.errorCallback(new W("Stream is closing",void 0)):(this.#s.push(e),this.#l())}#l(){for(;;){const e=this.#s.first();if(e===void 0&&this.#r===void 0&&this.#i){this.#u(new O("Stream was gracefully closed"));break}else if(e?.type==="request"&&this.#r===void 0){const{request:s,responseCallback:r,errorCallback:n}=e;this.#s.shift(),this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}else if(e?.type==="cursor"&&this.#r===void 0){const{batch:s,cursorCallback:r}=e;this.#s.shift();const n=this.#e._cursorIdAlloc.alloc(),i=new Ln(this.#e,this,n),o={type:"open_cursor",streamId:this.#t,cursorId:n,batch:s},a=()=>{},l=u=>i._setClosed(u);this.#e._sendRequest(o,{responseCallback:a,errorCallback:l}),this.#r=i,r(i)}else break}}#u(e){if(this.#n!==void 0)return;for(this.#n=e,this.#r!==void 0&&this.#r._setClosed(e);;){const i=this.#s.shift();if(i!==void 0)i.errorCallback(e);else break}const s={type:"close_stream",streamId:this.#t},r=()=>this.#e._streamIdAlloc.free(this.#t),n=()=>{};this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}close(){this.#u(new O("Stream was manually closed"))}closeGracefully(){this.#i=!0,this.#l()}get closed(){return this.#n!==void 0||this.#i}}function Mt(t,e){e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId),t.arrayObjects("args",e.args,nr),t.arrayObjects("named_args",e.namedArgs,En),t.boolean("want_rows",e.wantRows)}function En(t,e){t.string("name",e.name),t.object("value",e.value,nr)}function tt(t,e){t.arrayObjects("steps",e.steps,Pn)}function Pn(t,e){e.condition!==void 0&&t.object("condition",e.condition,It),t.object("stmt",e.stmt,Mt)}function It(t,e){if(t.stringRaw("type",e.type),e.type==="ok"||e.type==="error")t.number("step",e.step);else if(e.type==="not")t.object("cond",e.cond,It);else if(e.type==="and"||e.type==="or")t.arrayObjects("conds",e.conds,It);else if(e.type!=="is_autocommit")throw $(e,"Impossible type of BatchCond")}function nr(t,e){if(e===null)t.stringRaw("type","null");else if(typeof e=="bigint")t.stringRaw("type","integer"),t.stringRaw("value",""+e);else if(typeof e=="number")t.stringRaw("type","float"),t.number("value",e);else if(typeof e=="string")t.stringRaw("type","text"),t.string("value",e);else if(e instanceof Uint8Array)t.stringRaw("type","blob"),t.stringRaw("base64",Bt.fromUint8Array(e));else if(e!==void 0)throw $(e,"Impossible type of Value")}function Qn(t,e){if(t.stringRaw("type",e.type),e.type==="hello")e.jwt!==void 0&&t.string("jwt",e.jwt);else if(e.type==="request")t.number("request_id",e.requestId),t.object("request",e.request,Bn);else throw $(e,"Impossible type of ClientMsg")}function Bn(t,e){if(t.stringRaw("type",e.type),e.type==="open_stream")t.number("stream_id",e.streamId);else if(e.type==="close_stream")t.number("stream_id",e.streamId);else if(e.type==="execute")t.number("stream_id",e.streamId),t.object("stmt",e.stmt,Mt);else if(e.type==="batch")t.number("stream_id",e.streamId),t.object("batch",e.batch,tt);else if(e.type==="open_cursor")t.number("stream_id",e.streamId),t.number("cursor_id",e.cursorId),t.object("batch",e.batch,tt);else if(e.type==="close_cursor")t.number("cursor_id",e.cursorId);else if(e.type==="fetch_cursor")t.number("cursor_id",e.cursorId),t.number("max_count",e.maxCount);else if(e.type==="sequence")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type==="get_autocommit")t.number("stream_id",e.streamId);else throw $(e,"Impossible type of Request")}function Ft(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId);for(const s of e.args)t.message(3,s,ir);for(const s of e.namedArgs)t.message(4,s,jn);t.bool(5,e.wantRows)}function jn(t,e){t.string(1,e.name),t.message(2,e.value,ir)}function at(t,e){for(const s of e.steps)t.message(1,s,kn)}function kn(t,e){e.condition!==void 0&&t.message(1,e.condition,zt),t.message(2,e.stmt,Ft)}function zt(t,e){if(e.type==="ok")t.uint32(1,e.step);else if(e.type==="error")t.uint32(2,e.step);else if(e.type==="not")t.message(3,e.cond,zt);else if(e.type==="and")t.message(4,e.conds,hs);else if(e.type==="or")t.message(5,e.conds,hs);else if(e.type==="is_autocommit")t.message(6,void 0,or);else throw $(e,"Impossible type of BatchCond")}function hs(t,e){for(const s of e)t.message(1,s,zt)}function ir(t,e){if(e===null)t.message(1,void 0,or);else if(typeof e=="bigint")t.sint64(2,e);else if(typeof e=="number")t.double(3,e);else if(typeof e=="string")t.string(4,e);else if(e instanceof Uint8Array)t.bytes(5,e);else if(e!==void 0)throw $(e,"Impossible type of Value")}function or(t,e){}function Un(t,e){if(e.type==="hello")t.message(1,e,Dn);else if(e.type==="request")t.message(2,e,Mn);else throw $(e,"Impossible type of ClientMsg")}function Dn(t,e){e.jwt!==void 0&&t.string(1,e.jwt)}function Mn(t,e){t.int32(1,e.requestId);const s=e.request;if(s.type==="open_stream")t.message(2,s,Fn);else if(s.type==="close_stream")t.message(3,s,zn);else if(s.type==="execute")t.message(4,s,Vn);else if(s.type==="batch")t.message(5,s,Kn);else if(s.type==="open_cursor")t.message(6,s,Hn);else if(s.type==="close_cursor")t.message(7,s,Jn);else if(s.type==="fetch_cursor")t.message(8,s,Wn);else if(s.type==="sequence")t.message(9,s,Gn);else if(s.type==="describe")t.message(10,s,Yn);else if(s.type==="store_sql")t.message(11,s,Zn);else if(s.type==="close_sql")t.message(12,s,Xn);else if(s.type==="get_autocommit")t.message(13,s,ei);else throw $(s,"Impossible type of Request")}function Fn(t,e){t.int32(1,e.streamId)}function zn(t,e){t.int32(1,e.streamId)}function Vn(t,e){t.int32(1,e.streamId),t.message(2,e.stmt,Ft)}function Kn(t,e){t.int32(1,e.streamId),t.message(2,e.batch,at)}function Hn(t,e){t.int32(1,e.streamId),t.int32(2,e.cursorId),t.message(3,e.batch,at)}function Jn(t,e){t.int32(1,e.cursorId)}function Wn(t,e){t.int32(1,e.cursorId),t.uint32(2,e.maxCount)}function Gn(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function Yn(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function Zn(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function Xn(t,e){t.int32(1,e.sqlId)}function ei(t,e){t.int32(1,e.streamId)}function Te(t){const e=Z(t.message),s=X(t.code);return{message:e,code:s}}function Vt(t){const e=le(t.cols,ar),s=Xe(t.rows).map(o=>le(o,hr)),r=fe(t.affected_row_count),n=X(t.last_insert_rowid),i=n!==void 0?BigInt(n):void 0;return{cols:e,rows:s,affectedRowCount:r,lastInsertRowid:i}}function ar(t){const e=X(t.name),s=X(t.decltype);return{name:e,decltype:s}}function lr(t){const e=new Map;Xe(t.step_results).forEach((r,n)=>{r!==null&&e.set(n,Vt(k(r)))});const s=new Map;return Xe(t.step_errors).forEach((r,n)=>{r!==null&&s.set(n,Te(k(r)))}),{stepResults:e,stepErrors:s}}function ur(t){const e=Z(t.type);if(e==="step_begin"){const s=fe(t.step),r=le(t.cols,ar);return{type:"step_begin",step:s,cols:r}}else if(e==="step_end"){const s=fe(t.affected_row_count),r=X(t.last_insert_rowid),n=r!==void 0?BigInt(r):void 0;return{type:"step_end",affectedRowCount:s,lastInsertRowid:n}}else if(e==="step_error"){const s=fe(t.step),r=Te(k(t.error));return{type:"step_error",step:s,error:r}}else{if(e==="row")return{type:"row",row:le(t.row,hr)};if(e==="error")return{type:"error",error:Te(k(t.error))};throw new q("Unexpected type of CursorEntry")}}function cr(t){const e=le(t.params,ti),s=le(t.cols,si),r=Me(t.is_explain),n=Me(t.is_readonly);return{params:e,cols:s,isExplain:r,isReadonly:n}}function ti(t){return{name:X(t.name)}}function si(t){const e=Z(t.name),s=X(t.decltype);return{name:e,decltype:s}}function hr(t){const e=Z(t.type);if(e==="null")return null;if(e==="integer"){const s=Z(t.value);return BigInt(s)}else{if(e==="float")return fe(t.value);if(e==="text")return Z(t.value);if(e==="blob")return Bt.toUint8Array(Z(t.base64));throw new q("Unexpected type of Value")}}function ri(t){const e=Z(t.type);if(e==="hello_ok")return{type:"hello_ok"};if(e==="hello_error")return{type:"hello_error",error:Te(k(t.error))};if(e==="response_ok"){const s=fe(t.request_id),r=ni(k(t.response));return{type:"response_ok",requestId:s,response:r}}else if(e==="response_error"){const s=fe(t.request_id),r=Te(k(t.error));return{type:"response_error",requestId:s,error:r}}else throw new q("Unexpected type of ServerMsg")}function ni(t){const e=Z(t.type);if(e==="open_stream")return{type:"open_stream"};if(e==="close_stream")return{type:"close_stream"};if(e==="execute")return{type:"execute",result:Vt(k(t.result))};if(e==="batch")return{type:"batch",result:lr(k(t.result))};if(e==="open_cursor")return{type:"open_cursor"};if(e==="close_cursor")return{type:"close_cursor"};if(e==="fetch_cursor"){const s=le(t.entries,ur),r=Me(t.done);return{type:"fetch_cursor",entries:s,done:r}}else{if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:cr(k(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Me(t.is_autocommit)};throw new q("Unexpected type of Response")}}const ee={default(){return{message:"",code:void 0}},1(t,e){e.message=t.string()},2(t,e){e.code=t.string()}},Ie={default(){return{cols:[],rows:[],affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.cols.push(t.message(dr))},2(t,e){e.rows.push(t.message(fr))},3(t,e){e.affectedRowCount=Number(t.uint64())},4(t,e){e.lastInsertRowid=t.sint64()}},dr={default(){return{name:void 0,decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},fr={default(){return[]},1(t,e){e.push(t.message(di))}},st={default(){return{stepResults:new Map,stepErrors:new Map}},1(t,e){const[s,r]=t.message(ii);e.stepResults.set(s,r)},2(t,e){const[s,r]=t.message(oi);e.stepErrors.set(s,r)}},ii={default(){return[0,Ie.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(Ie)}},oi={default(){return[0,ee.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(ee)}},pr={default(){return{type:"none"}},1(t){return t.message(ai)},2(t){return t.message(li)},3(t){return t.message(ui)},4(t){return{type:"row",row:t.message(fr)}},5(t){return{type:"error",error:t.message(ee)}}},ai={default(){return{type:"step_begin",step:0,cols:[]}},1(t,e){e.step=t.uint32()},2(t,e){e.cols.push(t.message(dr))}},li={default(){return{type:"step_end",affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.affectedRowCount=t.uint32()},2(t,e){e.lastInsertRowid=t.uint64()}},ui={default(){return{type:"step_error",step:0,error:ee.default()}},1(t,e){e.step=t.uint32()},2(t,e){e.error=t.message(ee)}},rt={default(){return{params:[],cols:[],isExplain:!1,isReadonly:!1}},1(t,e){e.params.push(t.message(ci))},2(t,e){e.cols.push(t.message(hi))},3(t,e){e.isExplain=t.bool()},4(t,e){e.isReadonly=t.bool()}},ci={default(){return{name:void 0}},1(t,e){e.name=t.string()}},hi={default(){return{name:"",decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},di={default(){},1(t){return null},2(t){return t.sint64()},3(t){return t.double()},4(t){return t.string()},5(t){return t.bytes()}},fi={default(){return{type:"none"}},1(t){return{type:"hello_ok"}},2(t){return t.message(pi)},3(t){return t.message(yi)},4(t){return t.message(mi)}},pi={default(){return{type:"hello_error",error:ee.default()}},1(t,e){e.error=t.message(ee)}},mi={default(){return{type:"response_error",requestId:0,error:ee.default()}},1(t,e){e.requestId=t.int32()},2(t,e){e.error=t.message(ee)}},yi={default(){return{type:"response_ok",requestId:0,response:{type:"none"}}},1(t,e){e.requestId=t.int32()},2(t,e){e.response={type:"open_stream"}},3(t,e){e.response={type:"close_stream"}},4(t,e){e.response=t.message(bi)},5(t,e){e.response=t.message(wi)},6(t,e){e.response={type:"open_cursor"}},7(t,e){e.response={type:"close_cursor"}},8(t,e){e.response=t.message(gi)},9(t,e){e.response={type:"sequence"}},10(t,e){e.response=t.message(Si)},11(t,e){e.response={type:"store_sql"}},12(t,e){e.response={type:"close_sql"}},13(t,e){e.response=t.message(xi)}},bi={default(){return{type:"execute",result:Ie.default()}},1(t,e){e.result=t.message(Ie)}},wi={default(){return{type:"batch",result:st.default()}},1(t,e){e.result=t.message(st)}},gi={default(){return{type:"fetch_cursor",entries:[],done:!1}},1(t,e){e.entries.push(t.message(pr))},2(t,e){e.done=t.bool()}},Si={default(){return{type:"describe",result:rt.default()}},1(t,e){e.result=t.message(rt)}},xi={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},qi=new Map([["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]),mr=new Map([["hrana3-protobuf",{version:3,encoding:"protobuf"}],["hrana3",{version:3,encoding:"json"}],["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]);let _i=class extends zs{#e;#t;#s;#r;#i;#n;#o;#a;#l;_streamIdAlloc;_cursorIdAlloc;#u;constructor(e,s){super(),this.#e=e,this.#t=[],this.#s=!1,this.#r=void 0,this.#i=!1,this.#n=void 0,this.#o=!1,this.#a=new Map,this.#l=new je,this._streamIdAlloc=new je,this._cursorIdAlloc=new je,this.#u=new je,this.#e.binaryType="arraybuffer",this.#e.addEventListener("open",()=>this.#p()),this.#e.addEventListener("close",r=>this.#f(r)),this.#e.addEventListener("error",r=>this.#m(r)),this.#e.addEventListener("message",r=>this.#b(r)),this.#h({type:"hello",jwt:s})}#h(e){if(this.#r!==void 0)throw new ae("Trying to send a message on a closed client");if(this.#s)this.#d(e);else{const s=()=>this.#d(e),r=()=>{};this.#t.push({openCallback:s,errorCallback:r})}}#p(){const e=this.#e.protocol;if(e===void 0){this.#c(new O("The `WebSocket.protocol` property is undefined. This most likely means that the WebSocket implementation provided by the environment is broken. If you are using Miniflare 2, please update to Miniflare 3, which fixes this problem."));return}else if(e==="")this.#n={version:1,encoding:"json"};else if(this.#n=mr.get(e),this.#n===void 0){this.#c(new q(`Unrecognized WebSocket subprotocol: ${JSON.stringify(e)}`));return}for(const s of this.#t)s.openCallback();this.#t.length=0,this.#s=!0}#d(e){const s=this.#n.encoding;if(s==="json"){const r=Js(e,Qn);this.#e.send(r)}else if(s==="protobuf"){const r=Ws(e,Un);this.#e.send(r)}else throw $(s,"Impossible encoding")}getVersion(){return new Promise((e,s)=>{if(this.#o=!0,this.#r!==void 0)s(this.#r);else if(this.#s)e(this.#n.version);else{const r=()=>e(this.#n.version);this.#t.push({openCallback:r,errorCallback:s})}})}_ensureVersion(e,s){if(this.#n===void 0||!this.#o)throw new Ce(`${s} is supported only on protocol version ${e} and higher, but the version supported by the WebSocket server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this.#n.version<e)throw new Ce(`${s} is supported on protocol version ${e} and higher, but the WebSocket server only supports version ${this.#n.version}`)}_sendRequest(e,s){if(this.#r!==void 0){s.errorCallback(new W("Client is closed",this.#r));return}const r=this.#l.alloc();this.#a.set(r,{...s,type:e.type}),this.#h({type:"request",requestId:r,request:e})}#m(e){const r=e.message??"WebSocket was closed due to an error";this.#c(new _t(r))}#f(e){let s=`WebSocket was closed with code ${e.code}`;e.reason&&(s+=`: ${e.reason}`),this.#c(new _t(s))}#c(e){if(this.#r===void 0){this.#r=e;for(const s of this.#t)s.errorCallback(e);this.#t.length=0;for(const[s,r]of this.#a.entries())r.errorCallback(e),this.#l.free(s);this.#a.clear(),this.#e.close()}}#b(e){if(this.#r===void 0)try{let s;const r=this.#n.encoding;if(r==="json"){if(typeof e.data!="string"){this.#e.close(3003,"Only text messages are accepted with JSON encoding"),this.#c(new q("Received non-text message from server with JSON encoding"));return}s=jt(JSON.parse(e.data),ri)}else if(r==="protobuf"){if(!(e.data instanceof ArrayBuffer)){this.#e.close(3003,"Only binary messages are accepted with Protobuf encoding"),this.#c(new q("Received non-binary message from server with Protobuf encoding"));return}s=ot(new Uint8Array(e.data),fi)}else throw $(r,"Impossible encoding");this.#y(s)}catch(s){this.#e.close(3007,"Could not handle message"),this.#c(s)}}#y(e){if(e.type==="none")throw new q("Received an unrecognized ServerMsg");if(e.type==="hello_ok"||e.type==="hello_error"){if(this.#i)throw new q("Received a duplicated hello response");if(this.#i=!0,e.type==="hello_error")throw ve(e.error);return}else if(!this.#i)throw new q("Received a non-hello message before a hello response");if(e.type==="response_ok"){const s=e.requestId,r=this.#a.get(s);if(this.#a.delete(s),r===void 0)throw new q("Received unexpected OK response");this.#l.free(s);try{if(r.type!==e.response.type)throw console.dir({responseState:r,msg:e}),new q("Received unexpected type of response");r.responseCallback(e.response)}catch(n){throw r.errorCallback(n),n}}else if(e.type==="response_error"){const s=e.requestId,r=this.#a.get(s);if(this.#a.delete(s),r===void 0)throw new q("Received unexpected error response");this.#l.free(s),r.errorCallback(ve(e.error))}else throw $(e,"Impossible ServerMsg type")}openStream(){return Dt.open(this)}storeSql(e){this._ensureVersion(2,"storeSql()");const s=this.#u.alloc(),r=new Ut(this,s),n=()=>{},i=a=>r._setClosed(a),o={type:"store_sql",sqlId:s,sql:e};return this._sendRequest(o,{responseCallback:n,errorCallback:i}),r}_closeSql(e){if(this.#r!==void 0)return;const s=()=>this.#u.free(e),r=i=>this.#c(i),n={type:"close_sql",sqlId:e};this._sendRequest(n,{responseCallback:s,errorCallback:r})}close(){this.#c(new O("Client was manually closed"))}get closed(){return this.#r!==void 0}};const Ri=fetch,yr=Request,Ci=Headers;let xe;if(typeof queueMicrotask<"u")xe=queueMicrotask;else{const t=Promise.resolve();xe=e=>{t.then(e)}}class vi{#e;#t;#s;constructor(e){this.#e=new Uint8Array(new ArrayBuffer(e)),this.#t=0,this.#s=0}get length(){return this.#s-this.#t}data(){return this.#e.slice(this.#t,this.#s)}push(e){this.#r(e.byteLength),this.#e.set(e,this.#s),this.#s+=e.byteLength}#r(e){if(this.#s+e<=this.#e.byteLength)return;const s=this.#s-this.#t;if(s+e<=this.#e.byteLength&&2*this.#s>=this.#e.byteLength)this.#e.copyWithin(0,this.#t,this.#s);else{let r=this.#e.byteLength;do r*=2;while(s+e>r);const n=new Uint8Array(new ArrayBuffer(r));n.set(this.#e.slice(this.#t,this.#s),0),this.#e=n}this.#s=s,this.#t=0}shift(e){this.#t+=e}}function Ti(t){const e=X(t.baton),s=X(t.base_url),r=le(t.results,Ii);return{baton:e,baseUrl:s,results:r}}function Ii(t){const e=Z(t.type);if(e==="ok")return{type:"ok",response:Ai(k(t.response))};if(e==="error")return{type:"error",error:Te(k(t.error))};throw new q("Unexpected type of StreamResult")}function Ai(t){const e=Z(t.type);if(e==="close")return{type:"close"};if(e==="execute")return{type:"execute",result:Vt(k(t.result))};if(e==="batch")return{type:"batch",result:lr(k(t.result))};if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:cr(k(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Me(t.is_autocommit)};throw new q("Unexpected type of StreamResponse")}function Ni(t){const e=X(t.baton),s=X(t.base_url);return{baton:e,baseUrl:s}}const Oi={default(){return{baton:void 0,baseUrl:void 0,results:[]}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()},3(t,e){e.results.push(t.message($i))}},$i={default(){return{type:"none"}},1(t){return{type:"ok",response:t.message(Li)}},2(t){return{type:"error",error:t.message(ee)}}},Li={default(){return{type:"none"}},1(t){return{type:"close"}},2(t){return t.message(Ei)},3(t){return t.message(Pi)},4(t){return{type:"sequence"}},5(t){return t.message(Qi)},6(t){return{type:"store_sql"}},7(t){return{type:"close_sql"}},8(t){return t.message(Bi)}},Ei={default(){return{type:"execute",result:Ie.default()}},1(t,e){e.result=t.message(Ie)}},Pi={default(){return{type:"batch",result:st.default()}},1(t,e){e.result=t.message(st)}},Qi={default(){return{type:"describe",result:rt.default()}},1(t,e){e.result=t.message(rt)}},Bi={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},ji={default(){return{baton:void 0,baseUrl:void 0}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()}};class ki extends rr{#e;#t;#s;#r;#i;#n;constructor(e,s){super(),this.#e=e,this.#t=s,this.#s=void 0,this.#r=new vi(16*1024),this.#i=void 0,this.#n=!1}async open(e){if(e.body===null)throw new q("No response body for cursor request");this.#s=e.body.getReader();const s=await this.#o(Ni,ji);if(s===void 0)throw new q("Empty response to cursor request");return s}next(){return this.#o(ur,pr)}close(){this._setClosed(new O("Cursor was manually closed"))}_setClosed(e){this.#i===void 0&&(this.#i=e,this.#e._cursorClosed(this),this.#s!==void 0&&this.#s.cancel())}get closed(){return this.#i!==void 0}async#o(e,s){for(;;){if(this.#n)return;if(this.#i!==void 0)throw new W("Cursor is closed",this.#i);if(this.#t==="json"){const i=this.#a();if(i!==void 0){const o=new TextDecoder().decode(i),a=JSON.parse(o);return jt(a,e)}}else if(this.#t==="protobuf"){const i=this.#l();if(i!==void 0)return ot(i,s)}else throw $(this.#t,"Impossible encoding");if(this.#s===void 0)throw new ae("Attempted to read from HTTP cursor before it was opened");const{value:r,done:n}=await this.#s.read();if(n&&this.#r.length===0)this.#n=!0;else{if(n)throw new q("Unexpected end of cursor stream");this.#r.push(r)}}}#a(){const e=this.#r.data(),r=e.indexOf(10);if(r<0)return;const n=e.slice(0,r);return this.#r.shift(r+1),n}#l(){const e=this.#r.data();let s=0,r=0;for(;;){if(r>=e.byteLength)return;const i=e[r];if(s|=(i&127)<<7*r,r+=1,!(i&128))break}if(e.byteLength<r+s)return;const n=e.slice(r,r+s);return this.#r.shift(r+s),n}}function Ui(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.arrayObjects("requests",e.requests,Di)}function Di(t,e){if(t.stringRaw("type",e.type),e.type!=="close"){if(e.type==="execute")t.object("stmt",e.stmt,Mt);else if(e.type==="batch")t.object("batch",e.batch,tt);else if(e.type==="sequence")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type!=="get_autocommit")throw $(e,"Impossible type of StreamRequest")}}function Mi(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.object("batch",e.batch,tt)}function Fi(t,e){e.baton!==void 0&&t.string(1,e.baton);for(const s of e.requests)t.message(2,s,zi)}function zi(t,e){if(e.type==="close")t.message(1,e,Vi);else if(e.type==="execute")t.message(2,e,Ki);else if(e.type==="batch")t.message(3,e,Hi);else if(e.type==="sequence")t.message(4,e,Ji);else if(e.type==="describe")t.message(5,e,Wi);else if(e.type==="store_sql")t.message(6,e,Gi);else if(e.type==="close_sql")t.message(7,e,Yi);else if(e.type==="get_autocommit")t.message(8,e,Zi);else throw $(e,"Impossible type of StreamRequest")}function Vi(t,e){}function Ki(t,e){t.message(1,e.stmt,Ft)}function Hi(t,e){t.message(1,e.batch,at)}function Ji(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function Wi(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function Gi(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function Yi(t,e){t.int32(1,e.sqlId)}function Zi(t,e){}function Xi(t,e){e.baton!==void 0&&t.string(1,e.baton),t.message(2,e.batch,at)}class eo extends sr{#e;#t;#s;#r;#i;#n;#o;#a;#l;#u;#h;#p;constructor(e,s,r,n){super(e.intMode),this.#e=e,this.#t=s.toString(),this.#s=r,this.#r=n,this.#i=void 0,this.#n=new et,this.#o=!1,this.#l=!1,this.#u=!1,this.#h=void 0,this.#p=new je}client(){return this.#e}_sqlOwner(){return this}storeSql(e){const s=this.#p.alloc();return this.#d({type:"store_sql",sqlId:s,sql:e}).then(()=>{},r=>this._setClosed(r)),new Ut(this,s)}_closeSql(e){this.#h===void 0&&this.#d({type:"close_sql",sqlId:e}).then(()=>this.#p.free(e),s=>this._setClosed(s))}_execute(e){return this.#d({type:"execute",stmt:e}).then(s=>s.result)}_batch(e){return this.#d({type:"batch",batch:e}).then(s=>s.result)}_describe(e){return this.#d({type:"describe",sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#d({type:"sequence",sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#d({type:"get_autocommit"}).then(e=>e.isAutocommit)}#d(e){return new Promise((s,r)=>{this.#m({type:"pipeline",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return new Promise((s,r)=>{this.#m({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_cursorClosed(e){if(e!==this.#a)throw new ae("Cursor was closed, but it was not associated with the stream");this.#a=void 0,xe(()=>this.#f())}close(){this._setClosed(new O("Stream was manually closed"))}closeGracefully(){this.#l=!0,xe(()=>this.#f())}get closed(){return this.#h!==void 0||this.#l}_setClosed(e){if(this.#h===void 0){for(this.#h=e,this.#a!==void 0&&this.#a._setClosed(e),this.#e._streamClosed(this);;){const s=this.#n.shift();if(s!==void 0)s.errorCallback(e);else break}(this.#i!==void 0||this.#o)&&!this.#u&&(this.#n.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0,xe(()=>this.#f()))}}#m(e){if(this.#h!==void 0)throw new W("Stream is closed",this.#h);if(this.#l)throw new W("Stream is closing",void 0);this.#n.push(e),xe(()=>this.#f())}#f(){if(this.#o||this.#a!==void 0)return;if(this.#l&&this.#n.length===0){this._setClosed(new O("Stream was gracefully closed"));return}const e=this.#e._endpoint;if(e===void 0){this.#e._endpointPromise.then(()=>this.#f(),r=>this._setClosed(r));return}const s=this.#n.shift();if(s!==void 0)if(s.type==="pipeline"){const r=[s];for(;;){const n=this.#n.first();if(n!==void 0&&n.type==="pipeline")r.push(n),this.#n.shift();else if(n===void 0&&this.#l&&!this.#u){r.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0;break}else break}this.#c(e,r)}else if(s.type==="cursor")this.#b(e,s);else throw $(s,"Impossible type of QueueEntry")}#c(e,s){this.#y(()=>this.#g(s,e),r=>so(r,e.encoding),r=>r.baton,r=>r.baseUrl,r=>to(s,r),r=>s.forEach(n=>n.errorCallback(r)))}#b(e,s){const r=new ki(this,e.encoding);this.#a=r,this.#y(()=>this.#S(s,e),n=>r.open(n),n=>n.baton,n=>n.baseUrl,n=>s.cursorCallback(r),n=>s.errorCallback(n))}#y(e,s,r,n,i,o){let a;try{const l=e(),u=this.#r;a=u(l)}catch(l){a=Promise.reject(l)}this.#o=!0,a.then(l=>l.ok?s(l):ro(l).then(u=>{throw u})).then(l=>{this.#i=r(l),this.#t=n(l)??this.#t,i(l)}).catch(l=>{this._setClosed(l),o(l)}).finally(()=>{this.#o=!1,this.#f()})}#g(e,s){return this.#w(new URL(s.pipelinePath,this.#t),{baton:this.#i,requests:e.map(r=>r.request)},s.encoding,Ui,Fi)}#S(e,s){if(s.cursorPath===void 0)throw new Ce(`Cursors are supported only on protocol version 3 and higher, but the HTTP server only supports version ${s.version}.`);return this.#w(new URL(s.cursorPath,this.#t),{baton:this.#i,batch:e.batch},s.encoding,Mi,Xi)}#w(e,s,r,n,i){let o,a;if(r==="json")o=Js(s,n),a="application/json";else if(r==="protobuf")o=Ws(s,i),a="application/x-protobuf";else throw $(r,"Impossible encoding");const l=new Ci;return l.set("content-type",a),this.#s!==void 0&&l.set("authorization",`Bearer ${this.#s}`),new yr(e.toString(),{method:"POST",headers:l,body:o})}}function to(t,e){if(e.results.length!==t.length)throw new q("Server returned unexpected number of pipeline results");for(let s=0;s<t.length;++s){const r=e.results[s],n=t[s];if(r.type==="ok"){if(r.response.type!==n.request.type)throw new q("Received unexpected type of response");n.responseCallback(r.response)}else if(r.type==="error")n.errorCallback(ve(r.error));else throw r.type==="none"?new q("Received unrecognized type of StreamResult"):$(r,"Received impossible type of StreamResult")}}async function so(t,e){if(e==="json"){const s=await t.json();return jt(s,Ti)}else if(e==="protobuf"){const s=await t.arrayBuffer();return ot(new Uint8Array(s),Oi)}else throw $(e,"Impossible encoding")}async function ro(t){const e=t.headers.get("content-type")??"text/plain";if(e==="application/json"){const r=await t.json();if("message"in r)return ve(r)}let s=`Server returned HTTP status ${t.status}`;if(e==="text/plain"){const r=(await t.text()).trim();r!==""&&(s+=`: ${r}`)}return t.status===404&&(s+=". It seems that the libsql server is outdated, please try updating the database."),new Hs(s,t.status)}const no=[{versionPath:"v3-protobuf",pipelinePath:"v3-protobuf/pipeline",cursorPath:"v3-protobuf/cursor",version:3,encoding:"protobuf"}],At={versionPath:"v2",pipelinePath:"v2/pipeline",cursorPath:void 0,version:2,encoding:"json"};let io=class extends zs{#e;#t;#s;#r;#i;_endpointPromise;_endpoint;constructor(e,s,r,n=2){super(),this.#e=e,this.#t=s,this.#s=r??Ri,this.#r=void 0,this.#i=new Set,n==3?(this._endpointPromise=oo(this.#s,this.#e),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i))):(this._endpointPromise=Promise.resolve(At),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i)))}async getVersion(){return this._endpoint!==void 0?this._endpoint.version:(await this._endpointPromise).version}_ensureVersion(e,s){if(!(e<=At.version)){if(this._endpoint===void 0)throw new Ce(`${s} is supported only on protocol version ${e} and higher, but the version supported by the HTTP server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this._endpoint.version<e)throw new Ce(`${s} is supported only on protocol version ${e} and higher, but the HTTP server only supports version ${this._endpoint.version}.`)}}openStream(){if(this.#r!==void 0)throw new W("Client is closed",this.#r);const e=new eo(this,this.#e,this.#t,this.#s);return this.#i.add(e),e}_streamClosed(e){this.#i.delete(e)}close(){this.#n(new O("Client was manually closed"))}get closed(){return this.#r!==void 0}#n(e){if(this.#r===void 0){this.#r=e;for(const s of Array.from(this.#i))s._setClosed(new W("Client was closed",e))}}};async function oo(t,e){const s=t;for(const r of no){const n=new URL(r.versionPath,e),i=new yr(n.toString(),{method:"GET"}),o=await s(i);if(await o.arrayBuffer(),o.ok)return r}return At}function br(t,e,s=2){if(typeof Se>"u")throw new Ks("WebSockets are not supported in this environment");var r=void 0;s==3?r=Array.from(mr.keys()):r=Array.from(qi.keys());const n=new Se(t,r);return new _i(n,e)}function ao(t,e,s,r=2){return new io(t instanceof URL?t:new URL(t),e,s,r)}class wr{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}execute(e){return this.batch([e]).then(s=>s[0])}async batch(e){const s=this._getStream();if(s.closed)throw new v("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{const r=e.map(Fe);let n;if(this.#s===void 0){this._getSqlCache().apply(r);const o=s.batch(this.#t>=3),a=o.step(),l=a.run(qt(this.#e));let u=a;n=r.map(h=>{const m=o.step().condition(z.ok(u));this.#t>=3&&m.condition(z.not(z.isAutocommit(o)));const y=m.query(h);return y.catch(()=>{}),u=m,y}),this.#s=o.execute().then(()=>l).then(()=>{});try{await this.#s}catch(h){throw this.close(),h}}else{this.#t<3&&await this.#s,this._getSqlCache().apply(r);const o=s.batch(this.#t>=3);let a;n=r.map(l=>{const u=o.step();a!==void 0&&u.condition(z.ok(a)),this.#t>=3&&u.condition(z.not(z.isAutocommit(o)));const h=u.query(l);return h.catch(()=>{}),a=u,h}),await o.execute()}const i=[];for(const o of n){const a=await o;if(a===void 0)throw new v("Statement in a transaction was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");i.push(lt(a))}return i}catch(r){throw E(r)}}async executeMultiple(e){const s=this._getStream();if(s.closed)throw new v("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{if(this.#s===void 0){this.#s=s.run(qt(this.#e)).then(()=>{});try{await this.#s}catch(r){throw this.close(),r}}else await this.#s;await s.sequence(e)}catch(r){throw E(r)}}async rollback(){try{const e=this._getStream();if(e.closed||this.#s===void 0)return;const s=e.run("ROLLBACK").catch(r=>{throw E(r)});e.closeGracefully(),await s}catch(e){throw E(e)}finally{this.close()}}async commit(){try{const e=this._getStream();if(e.closed)throw new v("Cannot commit the transaction because it is already closed","TRANSACTION_CLOSED");if(this.#s!==void 0)await this.#s;else return;const s=e.run("COMMIT").catch(r=>{throw E(r)});e.closeGracefully(),await s}catch(e){throw E(e)}finally{this.close()}}}async function gr(t,e,s,r){const n=s.step(),i=n.run(qt(t));let o=n;const a=r.map(y=>{const f=s.step().condition(z.ok(o));e>=3&&f.condition(z.not(z.isAutocommit(s)));const b=f.query(y);return o=f,b}),l=s.step().condition(z.ok(o));e>=3&&l.condition(z.not(z.isAutocommit(s)));const u=l.run("COMMIT");s.step().condition(z.not(z.ok(l))).run("ROLLBACK").catch(y=>{}),await s.execute();const m=[];await i;for(const y of a){const f=await y;if(f===void 0)throw new v("Statement in a batch was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");m.push(lt(f))}return await u,m}function Fe(t){if(typeof t=="string")return new Tt(t);const e=new Tt(t.sql);if(Array.isArray(t.args))e.bindIndexes(t.args);else for(const[s,r]of Object.entries(t.args))e.bindName(s,r);return e}function lt(t){const e=t.columnNames.map(o=>o??""),s=t.columnDecltypes.map(o=>o??""),r=t.rows,n=t.affectedRowCount,i=t.lastInsertRowid!==void 0?t.lastInsertRowid:void 0;return new yn(e,s,r,n,i)}function E(t){if(t instanceof O){const e=Sr(t);return new v(t.message,e,void 0,t)}return t}function Sr(t){return t instanceof Vs&&t.code!==void 0?t.code:t instanceof q?"HRANA_PROTO_ERROR":t instanceof W?t.cause instanceof O?Sr(t.cause):"HRANA_CLOSED_ERROR":t instanceof _t?"HRANA_WEBSOCKET_ERROR":t instanceof Hs?"SERVER_ERROR":t instanceof Ce?"PROTOCOL_VERSION_ERROR":t instanceof ae?"INTERNAL_ERROR":"UNKNOWN"}class Kt{#e;#t;capacity;constructor(e,s){this.#e=e,this.#t=new lo,this.capacity=s}apply(e){if(this.capacity<=0)return;const s=new Set;for(const r of e){if(typeof r.sql!="string")continue;const n=r.sql;let i=this.#t.get(n);if(i===void 0){for(;this.#t.size+1>this.capacity;){const[o,a]=this.#t.peekLru();if(s.has(a))break;a.close(),this.#t.delete(o)}this.#t.size+1<=this.capacity&&(i=this.#e.storeSql(n),this.#t.set(n,i))}i!==void 0&&(r.sql=i,s.add(i))}}}class lo{#e;constructor(){this.#e=new Map}get(e){const s=this.#e.get(e);return s!==void 0&&(this.#e.delete(e),this.#e.set(e,s)),s}set(e,s){this.#e.set(e,s)}peekLru(){for(const e of this.#e.entries())return e}delete(e){this.#e.delete(e)}get size(){return this.#e.size}}function uo(t){if(t.scheme!=="wss"&&t.scheme!=="ws")throw new v(`The WebSocket client supports only "libsql:", "wss:" and "ws:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${De}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new v("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="ws"&&t.tls)throw new v('A "ws:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="wss"&&!t.tls)throw new v('A "wss:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=gt(t.scheme,t.authority,t.path);let s;try{s=br(e,t.authToken)}catch(r){if(r instanceof Ks){const n=t.scheme==="wss"?"https":"http",i=gt(n,t.authority,t.path);throw new v(`This environment does not support WebSockets, please switch to the HTTP client by using a "${n}:" URL (${JSON.stringify(i)}). For more information, please read ${De}`,"WEBSOCKETS_NOT_SUPPORTED")}throw E(r)}return new fo(s,e,t.authToken,t.intMode)}const co=60*1e3,ho=100;class fo{#e;#t;#s;#r;#i;closed;protocol;constructor(e,s,r,n){this.#e=s,this.#t=r,this.#s=n,this.#r=this.#o(e),this.#i=void 0,this.closed=!1,this.protocol="ws"}async execute(e){const s=await this.#n();try{const r=Fe(e);s.conn.sqlCache.apply([r]);const n=s.stream.query(r);return s.stream.closeGracefully(),lt(await n)}catch(r){throw E(r)}finally{this._closeStream(s)}}async batch(e,s="deferred"){const r=await this.#n();try{const n=e.map(Fe),i=await r.conn.client.getVersion();r.conn.sqlCache.apply(n);const o=r.stream.batch(i>=3);return await gr(s,i,o,n)}catch(n){throw E(n)}finally{this._closeStream(r)}}async transaction(e="write"){const s=await this.#n();try{const r=await s.conn.client.getVersion();return new po(this,s,e,r)}catch(r){throw this._closeStream(s),E(r)}}async executeMultiple(e){const s=await this.#n();try{const r=s.stream.sequence(e);s.stream.closeGracefully(),await r}catch(r){throw E(r)}finally{this._closeStream(s)}}sync(){return Promise.resolve()}async#n(){if(this.closed)throw new v("The client is closed","CLIENT_CLOSED");if(new Date().valueOf()-this.#r.openTime.valueOf()>co&&this.#i===void 0){const n=this.#o();this.#i=n,n.client.getVersion().then(i=>{this.#r!==n&&this.#r.streamStates.size===0&&this.#r.client.close(),this.#r=n,this.#i=void 0},i=>{this.#i=void 0})}if(this.#r.client.closed)try{this.#i!==void 0?this.#r=this.#i:this.#r=this.#o()}catch(n){throw E(n)}const r=this.#r;try{r.useSqlCache===void 0&&(r.useSqlCache=await r.client.getVersion()>=2,r.useSqlCache&&(r.sqlCache.capacity=ho));const n=r.client.openStream();n.intMode=this.#s;const i={conn:r,stream:n};return r.streamStates.add(i),i}catch(n){throw E(n)}}#o(e){try{return e??=br(this.#e,this.#t),{client:e,useSqlCache:void 0,sqlCache:new Kt(e,0),openTime:new Date,streamStates:new Set}}catch(s){throw E(s)}}_closeStream(e){e.stream.close();const s=e.conn;s.streamStates.delete(e),s.streamStates.size===0&&s!==this.#r&&s.client.close()}close(){this.#r.client.close(),this.closed=!0}}class po extends wr{#e;#t;constructor(e,s,r,n){super(r,n),this.#e=e,this.#t=s}_getStream(){return this.#t.stream}_getSqlCache(){return this.#t.conn.sqlCache}close(){this.#e._closeStream(this.#t)}get closed(){return this.#t.stream.closed}}function mo(t){if(t.scheme!=="https"&&t.scheme!=="http")throw new v(`The HTTP client supports only "libsql:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${De}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new v("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="http"&&t.tls)throw new v('A "http:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="https"&&!t.tls)throw new v('A "https:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=gt(t.scheme,t.authority,t.path);return new yo(e,t.authToken,t.intMode,t.fetch)}const xr=30;class yo{#e;protocol;constructor(e,s,r,n){this.#e=ao(e,s,n),this.#e.intMode=r,this.protocol="http"}async execute(e){try{const s=Fe(e);let r;const n=this.#e.openStream();try{r=n.query(s)}finally{n.closeGracefully()}return lt(await r)}catch(s){throw E(s)}}async batch(e,s="deferred"){try{const r=e.map(Fe),n=await this.#e.getVersion();let i;const o=this.#e.openStream();try{new Kt(o,xr).apply(r);const l=o.batch(!1);i=gr(s,n,l,r)}finally{o.closeGracefully()}return await i}catch(r){throw E(r)}}async transaction(e="write"){try{const s=await this.#e.getVersion();return new bo(this.#e.openStream(),e,s)}catch(s){throw E(s)}}async executeMultiple(e){try{let s;const r=this.#e.openStream();try{s=r.sequence(e)}finally{r.closeGracefully()}await s}catch(s){throw E(s)}}sync(){throw new v("sync not supported in http mode","SYNC_NOT_SUPPORTED")}close(){this.#e.close()}get closed(){return this.#e.closed}}class bo extends wr{#e;#t;constructor(e,s,r){super(s,r),this.#e=e,this.#t=new Kt(e,xr)}_getStream(){return this.#e}_getSqlCache(){return this.#t}close(){this.#e.close()}get closed(){return this.#e.closed}}function wo(t){return go(gn(t))}function go(t){if(t.scheme==="ws"||t.scheme==="wss")return uo(t);if(t.scheme==="http"||t.scheme==="https")return mo(t);throw new v(`The client that uses Web standard APIs supports only "libsql:", "wss:", "ws:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${De}`,"URL_SCHEME_NOT_SUPPORTED")}const So="libsql://metrics-nps-gastongithubb.turso.io",xo="eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3MjA0MzM2MDEsImlkIjoiYjI2MjM2YmUtYWExYS00YzY4LTk2MDktZDg3NDNhZGUxODViIn0.U3AVybGtI0-CuzB0daVpbDgEw8b3ijc9n2HhK_yvJwx5jtD_ViAqOsUJP2shasHbyqeFT0ATBASmA5RDHdihDA",qo=wo({url:So,authToken:xo}),p=Symbol.for("drizzle:entityKind");function d(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,p))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let s=t.constructor;if(s)for(;s;){if(p in s&&s[p]===e[p])return!0;s=Object.getPrototypeOf(s)}return!1}class _o{static[p]="ConsoleLogWriter";write(e){console.log(e)}}class Ro{static[p]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new _o}logQuery(e,s){const r=s.map(i=>{try{return JSON.stringify(i)}catch{return String(i)}}),n=r.length?` -- params: [${r.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}}class Co{static[p]="NoopLogger";logQuery(){}}const Ze=Symbol.for("drizzle:Name"),pt=Symbol.for("drizzle:Schema"),ds=Symbol.for("drizzle:Columns"),mt=Symbol.for("drizzle:OriginalName"),yt=Symbol.for("drizzle:BaseName"),fs=Symbol.for("drizzle:IsAlias"),ps=Symbol.for("drizzle:ExtraConfigBuilder"),qr=Symbol.for("drizzle:IsDrizzleTable");class w{static[p]="Table";static Symbol={Name:Ze,Schema:pt,OriginalName:mt,Columns:ds,BaseName:yt,IsAlias:fs,ExtraConfigBuilder:ps};[Ze];[mt];[pt];[ds];[yt];[fs]=!1;[ps]=void 0;[qr]=!0;constructor(e,s,r){this[Ze]=this[mt]=e,this[pt]=s,this[yt]=r}}function vo(t){return typeof t=="object"&&t!==null&&qr in t}function qe(t){return t[Ze]}class P{constructor(e,s){this.table=e,this.config=s,this.name=s.name,this.notNull=s.notNull,this.default=s.default,this.defaultFn=s.defaultFn,this.hasDefault=s.hasDefault,this.primary=s.primaryKey,this.isUnique=s.isUnique,this.uniqueName=s.uniqueName,this.uniqueType=s.uniqueType,this.dataType=s.dataType,this.columnType=s.columnType}static[p]="Column";name;primary;notNull;default;defaultFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}}const ms=Symbol.for("drizzle:PgInlineForeignKeys");class To extends w{static[p]="PgTable";static Symbol=Object.assign({},w.Symbol,{InlineForeignKeys:ms});[ms]=[];[w.Symbol.ExtraConfigBuilder]=void 0}class Io{static[p]="PgPrimaryKeyBuilder";columns;name;constructor(e,s){this.columns=e,this.name=s}build(e){return new Ao(e,this.columns,this.name)}}class Ao{constructor(e,s,r){this.table=e,this.columns=s,this.name=r}static[p]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[To.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}}const F=Symbol.for("drizzle:SubqueryConfig");class te{static[p]="Subquery";[F];constructor(e,s,r,n=!1){this[F]={sql:e,selection:s,alias:r,isWith:n}}}class _r extends te{static[p]="WithSubquery"}const No={startActiveSpan(t,e){return e()}},V=Symbol.for("drizzle:ViewBaseConfig");function Rr(t){return typeof t=="object"&&t!==null&&"getSQL"in t&&typeof t.getSQL=="function"}function Oo(t){const e={sql:"",params:[]};for(const s of t)e.sql+=s.sql,e.params.push(...s.params),s.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...s.typings));return e}class j{static[p]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new g([this])}}class g{constructor(e){this.queryChunks=e}static[p]="SQL";decoder=Cr;shouldInlineParams=!1;append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return No.startActiveSpan("drizzle.buildSQL",s=>{const r=this.buildQueryFromSourceParams(this.queryChunks,e);return s?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(e,s){const r=Object.assign({},s,{inlineParams:s.inlineParams||this.shouldInlineParams,paramStartIndex:s.paramStartIndex||{value:0}}),{escapeName:n,escapeParam:i,prepareTyping:o,inlineParams:a,paramStartIndex:l}=r;return Oo(e.map(u=>{if(d(u,j))return{sql:u.value.join(""),params:[]};if(d(u,Nt))return{sql:n(u.value),params:[]};if(u===void 0)return{sql:"",params:[]};if(Array.isArray(u)){const h=[new j("(")];for(const[m,y]of u.entries())h.push(y),m<u.length-1&&h.push(new j(", "));return h.push(new j(")")),this.buildQueryFromSourceParams(h,r)}if(d(u,g))return this.buildQueryFromSourceParams(u.queryChunks,{...r,inlineParams:a||u.shouldInlineParams});if(d(u,w)){const h=u[w.Symbol.Schema],m=u[w.Symbol.Name];return{sql:h===void 0?n(m):n(h)+"."+n(m),params:[]}}if(d(u,P))return{sql:n(u.table[w.Symbol.Name])+"."+n(u.name),params:[]};if(d(u,$e)){const h=u[V].schema,m=u[V].name;return{sql:h===void 0?n(m):n(h)+"."+n(m),params:[]}}if(d(u,pe)){const h=u.value===null?null:u.encoder.mapToDriverValue(u.value);if(d(h,g))return this.buildQueryFromSourceParams([h],r);if(a)return{sql:this.mapInlineParam(h,r),params:[]};let m;return o!==void 0&&(m=[o(u.encoder)]),{sql:i(l.value++,h),params:[h],typings:m}}return d(u,ut)?{sql:i(l.value++,u),params:[u]}:d(u,g.Aliased)&&u.fieldAlias!==void 0?{sql:n(u.fieldAlias),params:[]}:d(u,te)?u[F].isWith?{sql:n(u[F].alias),params:[]}:this.buildQueryFromSourceParams([new j("("),u[F].sql,new j(") "),new Nt(u[F].alias)],r):Rr(u)?this.buildQueryFromSourceParams([new j("("),u.getSQL(),new j(")")],r):a?{sql:this.mapInlineParam(u,r),params:[]}:{sql:i(l.value++,u),params:[u]}}))}mapInlineParam(e,{escapeString:s}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return s(e);if(typeof e=="object"){const r=e.toString();return s(r==="[object Object]"?JSON.stringify(e):r)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new g.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}}class Nt{constructor(e){this.value=e}static[p]="Name";brand;getSQL(){return new g([this])}}function $o(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}const Cr={mapFromDriverValue:t=>t},vr={mapToDriverValue:t=>t};({...Cr,...vr});class pe{constructor(e,s=vr){this.value=e,this.encoder=s}static[p]="Param";brand;getSQL(){return new g([this])}}function c(t,...e){const s=[];(e.length>0||t.length>0&&t[0]!=="")&&s.push(new j(t[0]));for(const[r,n]of e.entries())s.push(n,new j(t[r+1]));return new g(s)}(t=>{function e(){return new g([])}t.empty=e;function s(l){return new g(l)}t.fromList=s;function r(l){return new g([new j(l)])}t.raw=r;function n(l,u){const h=[];for(const[m,y]of l.entries())m>0&&u!==void 0&&h.push(u),h.push(y);return new g(h)}t.join=n;function i(l){return new Nt(l)}t.identifier=i;function o(l){return new ut(l)}t.placeholder=o;function a(l,u){return new pe(l,u)}t.param=a})(c||(c={}));(t=>{class e{constructor(r,n){this.sql=r,this.fieldAlias=n}static[p]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(g||(g={}));class ut{constructor(e){this.name=e}static[p]="Placeholder";getSQL(){return new g([this])}}function Je(t,e){return t.map(s=>{if(d(s,ut)){if(!(s.name in e))throw new Error(`No value for placeholder "${s.name}" was provided`);return e[s.name]}return s})}class $e{static[p]="View";[V];constructor({name:e,schema:s,selectedFields:r,query:n}){this[V]={name:e,originalName:e,schema:s,selectedFields:r,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new g([this])}}P.prototype.getSQL=function(){return new g([this])};w.prototype.getSQL=function(){return new g([this])};te.prototype.getSQL=function(){return new g([this])};function K(t,e){return $o(e)&&!Rr(t)&&!d(t,pe)&&!d(t,ut)&&!d(t,P)&&!d(t,w)&&!d(t,$e)?new pe(t,e):t}const Tr=(t,e)=>c`${t} = ${K(e,t)}`,Lo=(t,e)=>c`${t} <> ${K(e,t)}`;function Ot(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new j("("),c.join(e,new j(" and ")),new j(")")])}function Eo(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new g(e):new g([new j("("),c.join(e,new j(" or ")),new j(")")])}function Po(t){return c`not ${t}`}const Qo=(t,e)=>c`${t} > ${K(e,t)}`,Bo=(t,e)=>c`${t} >= ${K(e,t)}`,jo=(t,e)=>c`${t} < ${K(e,t)}`,ko=(t,e)=>c`${t} <= ${K(e,t)}`;function Uo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("inArray requires at least one value");return c`${t} in ${e.map(s=>K(s,t))}`}return c`${t} in ${K(e,t)}`}function Do(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("notInArray requires at least one value");return c`${t} not in ${e.map(s=>K(s,t))}`}return c`${t} not in ${K(e,t)}`}function Mo(t){return c`${t} is null`}function Fo(t){return c`${t} is not null`}function zo(t){return c`exists ${t}`}function Vo(t){return c`not exists ${t}`}function Ko(t,e,s){return c`${t} between ${K(e,t)} and ${K(s,t)}`}function Ho(t,e,s){return c`${t} not between ${K(e,t)} and ${K(s,t)}`}function Jo(t,e){return c`${t} like ${e}`}function Wo(t,e){return c`${t} not like ${e}`}function Go(t,e){return c`${t} ilike ${e}`}function Yo(t,e){return c`${t} not ilike ${e}`}function Zo(t){return c`${t} asc`}function Xo(t){return c`${t} desc`}class Ir{constructor(e,s,r){this.sourceTable=e,this.referencedTable=s,this.relationName=r,this.referencedTableName=s[w.Symbol.Name]}static[p]="Relation";referencedTableName;fieldName}class ea{constructor(e,s){this.table=e,this.config=s}static[p]="Relations"}class me extends Ir{constructor(e,s,r,n){super(e,s,r?.relationName),this.config=r,this.isNullable=n}static[p]="One";withFieldName(e){const s=new me(this.sourceTable,this.referencedTable,this.config,this.isNullable);return s.fieldName=e,s}}class ct extends Ir{constructor(e,s,r){super(e,s,r?.relationName),this.config=r}static[p]="Many";withFieldName(e){const s=new ct(this.sourceTable,this.referencedTable,this.config);return s.fieldName=e,s}}function ta(){return{and:Ot,between:Ko,eq:Tr,exists:zo,gt:Qo,gte:Bo,ilike:Go,inArray:Uo,isNull:Mo,isNotNull:Fo,like:Jo,lt:jo,lte:ko,ne:Lo,not:Po,notBetween:Ho,notExists:Vo,notLike:Wo,notIlike:Yo,notInArray:Do,or:Eo,sql:c}}function sa(){return{sql:c,asc:Zo,desc:Xo}}function ra(t,e){Object.keys(t).length===1&&"default"in t&&!d(t.default,w)&&(t=t.default);const s={},r={},n={};for(const[i,o]of Object.entries(t))if(vo(o)){const a=o[w.Symbol.Name],l=r[a];s[a]=i,n[i]={tsName:i,dbName:o[w.Symbol.Name],schema:o[w.Symbol.Schema],columns:o[w.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(const h of Object.values(o[w.Symbol.Columns]))h.primary&&n[i].primaryKey.push(h);const u=o[w.Symbol.ExtraConfigBuilder]?.(o);if(u)for(const h of Object.values(u))d(h,Io)&&n[i].primaryKey.push(...h.columns)}else if(d(o,ea)){const a=o.table[w.Symbol.Name],l=s[a],u=o.config(e(o.table));let h;for(const[m,y]of Object.entries(u))if(l){const f=n[l];f.relations[m]=y}else a in r||(r[a]={relations:{},primaryKey:h}),r[a].relations[m]=y}return{tables:n,tableNamesMap:s}}function na(t){return function(s,r){return new me(t,s,r,r?.fields.reduce((n,i)=>n&&i.notNull,!0)??!1)}}function ia(t){return function(s,r){return new ct(t,s,r)}}function oa(t,e,s){if(d(s,me)&&s.config)return{fields:s.config.fields,references:s.config.references};const r=e[s.referencedTable[w.Symbol.Name]];if(!r)throw new Error(`Table "${s.referencedTable[w.Symbol.Name]}" not found in schema`);const n=t[r];if(!n)throw new Error(`Table "${r}" not found in schema`);const i=s.sourceTable,o=e[i[w.Symbol.Name]];if(!o)throw new Error(`Table "${i[w.Symbol.Name]}" not found in schema`);const a=[];for(const l of Object.values(n.relations))(s.relationName&&s!==l&&l.relationName===s.relationName||!s.relationName&&l.referencedTable===s.sourceTable)&&a.push(l);if(a.length>1)throw s.relationName?new Error(`There are multiple relations with name "${s.relationName}" in table "${r}"`):new Error(`There are multiple relations between "${r}" and "${s.sourceTable[w.Symbol.Name]}". Please specify relation name`);if(a[0]&&d(a[0],me)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${s.fieldName}"`)}function aa(t){return{one:na(t),many:ia(t)}}function $t(t,e,s,r,n=i=>i){const i={};for(const[o,a]of r.entries())if(a.isJson){const l=e.relations[a.tsKey],u=s[o],h=typeof u=="string"?JSON.parse(u):u;i[a.tsKey]=d(l,me)?h&&$t(t,t[a.relationTableTsKey],h,a.selection,n):h.map(m=>$t(t,t[a.relationTableTsKey],m,a.selection,n))}else{const l=n(s[o]),u=a.field;let h;d(u,P)?h=u:d(u,g)?h=u.decoder:h=u.sql.decoder,i[a.tsKey]=l===null?null:h.mapFromDriverValue(l)}return i}class nt{constructor(e){this.table=e}static[p]="ColumnAliasProxyHandler";get(e,s){return s==="table"?this.table:e[s]}}class Ht{constructor(e,s){this.alias=e,this.replaceOriginalName=s}static[p]="TableAliasProxyHandler";get(e,s){if(s===w.Symbol.IsAlias)return!0;if(s===w.Symbol.Name)return this.alias;if(this.replaceOriginalName&&s===w.Symbol.OriginalName)return this.alias;if(s===V)return{...e[V],name:this.alias,isAlias:!0};if(s===w.Symbol.Columns){const n=e[w.Symbol.Columns];if(!n)return n;const i={};return Object.keys(n).map(o=>{i[o]=new Proxy(n[o],new nt(new Proxy(e,this)))}),i}const r=e[s];return d(r,P)?new Proxy(r,new nt(new Proxy(e,this))):r}}function bt(t,e){return new Proxy(t,new Ht(e,!1))}function re(t,e){return new Proxy(t,new nt(new Proxy(t.table,new Ht(e,!1))))}function Ar(t,e){return new g.Aliased(it(t.sql,e),t.fieldAlias)}function it(t,e){return c.join(t.queryChunks.map(s=>d(s,P)?re(s,e):d(s,g)?it(s,e):d(s,g.Aliased)?Ar(s,e):s))}class Y{static[p]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,s){if(s===F)return{...e[F],selection:new Proxy(e[F].selection,this)};if(s===V)return{...e[V],selectedFields:new Proxy(e[V].selectedFields,this)};if(typeof s=="symbol")return e[s];const n=(d(e,te)?e[F].selection:d(e,$e)?e[V].selectedFields:e)[s];if(d(n,g.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!n.isSelectionField)return n.sql;const i=n.clone();return i.isSelectionField=!0,i}if(d(n,g)){if(this.config.sqlBehavior==="sql")return n;throw new Error(`You tried to reference "${s}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return d(n,P)?this.config.alias?new Proxy(n,new nt(new Proxy(n.table,new Ht(this.config.alias,this.config.replaceOriginalName??!1)))):n:typeof n!="object"||n===null?n:new Proxy(n,new Y(this.config))}}class we{static[p]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(s=>(e?.(),s),s=>{throw e?.(),s})}then(e,s){return this.execute().then(e,s)}}const Lt=Symbol.for("drizzle:SQLiteInlineForeignKeys");class J extends w{static[p]="SQLiteTable";static Symbol=Object.assign({},w.Symbol,{InlineForeignKeys:Lt});[w.Symbol.Columns];[Lt]=[];[w.Symbol.ExtraConfigBuilder]=void 0}function la(t,e,s,r,n=t){const i=new J(t,r,n),o=Object.fromEntries(Object.entries(e).map(([l,u])=>{const h=u,m=h.build(i);return i[Lt].push(...h.buildForeignKeys(m,i)),[l,m]})),a=Object.assign(i,o);return a[w.Symbol.Columns]=o,a}const ua=(t,e,s)=>la(t,e);function ys(t,e,s){const r={},n=t.reduce((i,{path:o,field:a},l)=>{let u;d(a,P)?u=a:d(a,g)?u=a.decoder:u=a.sql.decoder;let h=i;for(const[m,y]of o.entries())if(m<o.length-1)y in h||(h[y]={}),h=h[y];else{const f=e[l],b=h[y]=f===null?null:u.mapFromDriverValue(f);if(s&&d(a,P)&&o.length===2){const _=o[0];_ in r?typeof r[_]=="string"&&r[_]!==qe(a.table)&&(r[_]=!1):r[_]=b===null?qe(a.table):!1}}return i},{});if(s&&Object.keys(r).length>0)for(const[i,o]of Object.entries(r))typeof o=="string"&&!s[o]&&(n[i]=null);return n}function ye(t,e){return Object.entries(t).reduce((s,[r,n])=>{if(typeof r!="string")return s;const i=e?[...e,r]:[r];return d(n,P)||d(n,g)||d(n,g.Aliased)?s.push({path:i,field:n}):d(n,w)?s.push(...ye(n[w.Symbol.Columns],i)):s.push(...ye(n,i)),s},[])}function Nr(t,e){const s=Object.keys(t),r=Object.keys(e);if(s.length!==r.length)return!1;for(const[n,i]of s.entries())if(i!==r[n])return!1;return!0}function Or(t,e){const s=Object.entries(e).filter(([,r])=>r!==void 0).map(([r,n])=>d(n,g)?[r,n]:[r,new pe(n,t[w.Symbol.Columns][r])]);if(s.length===0)throw new Error("No values to set");return Object.fromEntries(s)}function ca(t,e){for(const s of e)for(const r of Object.getOwnPropertyNames(s.prototype))r!=="constructor"&&Object.defineProperty(t.prototype,r,Object.getOwnPropertyDescriptor(s.prototype,r)||Object.create(null))}function ha(t){return t[w.Symbol.Columns]}function bs(t){return d(t,te)?t[F].alias:d(t,$e)?t[V].name:d(t,g)?void 0:t[w.Symbol.IsAlias]?t[w.Symbol.Name]:t[w.Symbol.BaseName]}class ws extends we{constructor(e,s,r,n){super(),this.table=e,this.session=s,this.dialect=r,this.config={table:e,withList:n}}static[p]="SQLiteDelete";config;where(e){return this.config.where=e,this}returning(e=this.table[J.Symbol.Columns]){return this.config.returning=ye(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}}class gs{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[p]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");const s=e.map(r=>{const n={},i=this.table[w.Symbol.Columns];for(const o of Object.keys(r)){const a=r[o];n[o]=d(a,g)?a:new pe(a,i[o])}return n});return new da(this.table,s,this.session,this.dialect,this.withList)}}class da extends we{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={table:e,values:s,withList:i}}static[p]="SQLiteInsert";config;returning(e=this.config.table[J.Symbol.Columns]){return this.config.returning=ye(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=c`do nothing`;else{const s=Array.isArray(e.target)?c`${e.target}`:c`${[e.target]}`,r=e.where?c` where ${e.where}`:c``;this.config.onConflict=c`${s} do nothing${r}`}return this}onConflictDoUpdate(e){const s=Array.isArray(e.target)?c`${e.target}`:c`${[e.target]}`,r=e.where?c` where ${e.where}`:c``,n=this.dialect.buildUpdateSet(this.config.table,Or(this.config.table,e.set));return this.config.onConflict=c`${s} do update set ${n}${r}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class Jt extends Error{static[p]="DrizzleError";constructor({message:e,cause:s}){super(e),this.name="DrizzleError",this.cause=s}}class fa extends Jt{static[p]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class pa{static[p]="ColumnBuilder";config;constructor(e,s,r){this.config={name:e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:s,columnType:r}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}}class ma{static[p]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,s){this.reference=()=>{const{name:r,columns:n,foreignColumns:i}=e();return{name:r,columns:n,foreignTable:i[0].table,foreignColumns:i}},s&&(this._onUpdate=s.onUpdate,this._onDelete=s.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new ya(e,this)}}class ya{constructor(e,s){this.table=e,this.reference=s.reference,this.onUpdate=s._onUpdate,this.onDelete=s._onDelete}static[p]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){const{name:e,columns:s,foreignColumns:r}=this.reference(),n=s.map(a=>a.name),i=r.map(a=>a.name),o=[this.table[J.Symbol.Name],...n,r[0].table[J.Symbol.Name],...i];return e??`${o.join("_")}_fk`}}function ba(t,e){return`${t[J.Symbol.Name]}_${e.join("_")}_unique`}class Wt extends pa{static[p]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,s={}){return this.foreignKeyConfigs.push({ref:e,actions:s}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}buildForeignKeys(e,s){return this.foreignKeyConfigs.map(({ref:r,actions:n})=>((i,o)=>{const a=new ma(()=>{const l=i();return{columns:[e],foreignColumns:[l]}});return o.onUpdate&&a.onUpdate(o.onUpdate),o.onDelete&&a.onDelete(o.onDelete),a.build(s)})(r,n))}}class Re extends P{constructor(e,s){s.uniqueName||(s.uniqueName=ba(e,[s.name])),super(e,s),this.table=e}static[p]="SQLiteColumn"}class Gt extends Wt{static[p]="SQLiteBaseIntegerBuilder";constructor(e,s,r){super(e,s,r),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}}class Yt extends Re{static[p]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}}class wa extends Gt{static[p]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new ga(e,this.config)}}class ga extends Yt{static[p]="SQLiteInteger"}class Sa extends Gt{static[p]="SQLiteTimestampBuilder";constructor(e,s){super(e,"date","SQLiteTimestamp"),this.config.mode=s}defaultNow(){return this.default(c`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new xa(e,this.config)}}class xa extends Yt{static[p]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){const s=e.getTime();return this.config.mode==="timestamp"?Math.floor(s/1e3):s}}class qa extends Gt{static[p]="SQLiteBooleanBuilder";constructor(e,s){super(e,"boolean","SQLiteBoolean"),this.config.mode=s}build(e){return new _a(e,this.config)}}class _a extends Yt{static[p]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}}function Pe(t,e){return e?.mode==="timestamp"||e?.mode==="timestamp_ms"?new Sa(t,e.mode):e?.mode==="boolean"?new qa(t,e.mode):new wa(t)}class Ra extends Wt{static[p]="SQLiteTextBuilder";constructor(e,s){super(e,"string","SQLiteText"),this.config.enumValues=s.enum,this.config.length=s.length}build(e){return new Ca(e,this.config)}}class Ca extends Re{static[p]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,s){super(e,s)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}}class va extends Wt{static[p]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new Ta(e,this.config)}}class Ta extends Re{static[p]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}}function Ia(t,e={}){return e.mode==="json"?new va(t):new Ra(t,e)}class $r extends $e{static[p]="SQLiteViewBase"}class Lr{static[p]="SQLiteDialect";escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;const s=[c`with `];for(const[r,n]of e.entries())s.push(c`${c.identifier(n[F].alias)} as (${n[F].sql})`),r<e.length-1&&s.push(c`, `);return s.push(c` `),c.join(s)}buildDeleteQuery({table:e,where:s,returning:r,withList:n}){const i=this.buildWithCTE(n),o=r?c` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,a=s?c` where ${s}`:void 0;return c`${i}delete from ${e}${a}${o}`}buildUpdateSet(e,s){const r=Object.entries(s),n=r.length;return c.join(r.flatMap(([i,o],a)=>{const l=e[w.Symbol.Columns][i],u=c`${c.identifier(l.name)} = ${o}`;return a<n-1?[u,c.raw(", ")]:[u]}))}buildUpdateQuery({table:e,set:s,where:r,returning:n,withList:i}){const o=this.buildWithCTE(i),a=this.buildUpdateSet(e,s),l=n?c` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,u=r?c` where ${r}`:void 0;return c`${o}update ${e} set ${a}${u}${l}`}buildSelection(e,{isSingleTable:s=!1}={}){const r=e.length,n=e.flatMap(({field:i},o)=>{const a=[];if(d(i,g.Aliased)&&i.isSelectionField)a.push(c.identifier(i.fieldAlias));else if(d(i,g.Aliased)||d(i,g)){const l=d(i,g.Aliased)?i.sql:i;s?a.push(new g(l.queryChunks.map(u=>d(u,P)?c.identifier(u.name):u))):a.push(l),d(i,g.Aliased)&&a.push(c` as ${c.identifier(i.fieldAlias)}`)}else if(d(i,P)){const l=i.table[w.Symbol.Name],u=i.name;s?a.push(c.identifier(u)):a.push(c`${c.identifier(l)}.${c.identifier(u)}`)}return o<r-1&&a.push(c`, `),a});return c.join(n)}buildSelectQuery({withList:e,fields:s,fieldsFlat:r,where:n,having:i,table:o,joins:a,orderBy:l,groupBy:u,limit:h,offset:m,distinct:y,setOperators:f}){const b=r??ye(s);for(const U of b)if(d(U.field,P)&&qe(U.field.table)!==(d(o,te)?o[F].alias:d(o,$r)?o[V].name:d(o,g)?void 0:qe(o))&&!(L=>a?.some(({alias:se})=>se===(L[w.Symbol.IsAlias]?qe(L):L[w.Symbol.BaseName])))(U.field.table)){const L=qe(U.field.table);throw new Error(`Your "${U.path.join("->")}" field references a column "${L}"."${U.field.name}", but the table "${L}" is not part of the query! Did you forget to join it?`)}const _=!a||a.length===0,C=this.buildWithCTE(e),N=y?c` distinct`:void 0,I=this.buildSelection(b,{isSingleTable:_}),A=d(o,w)&&o[w.Symbol.OriginalName]!==o[w.Symbol.Name]?c`${c.identifier(o[w.Symbol.OriginalName])} ${c.identifier(o[w.Symbol.Name])}`:o,T=[];if(a)for(const[U,L]of a.entries()){U===0&&T.push(c` `);const se=L.table;if(d(se,J)){const dt=se[J.Symbol.Name],es=se[J.Symbol.Schema],ts=se[J.Symbol.OriginalName],ss=dt===ts?void 0:L.alias;T.push(c`${c.raw(L.joinType)} join ${es?c`${c.identifier(es)}.`:void 0}${c.identifier(ts)}${ss&&c` ${c.identifier(ss)}`} on ${L.on}`)}else T.push(c`${c.raw(L.joinType)} join ${se} on ${L.on}`);U<a.length-1&&T.push(c` `)}const G=c.join(T),H=n?c` where ${n}`:void 0,S=i?c` having ${i}`:void 0,R=[];if(l)for(const[U,L]of l.entries())R.push(L),U<l.length-1&&R.push(c`, `);const Q=[];if(u)for(const[U,L]of u.entries())Q.push(L),U<u.length-1&&Q.push(c`, `);const ue=Q.length>0?c` group by ${c.join(Q)}`:void 0,ne=R.length>0?c` order by ${c.join(R)}`:void 0,Le=h?c` limit ${h}`:void 0,Ve=m?c` offset ${m}`:void 0,Ke=c`${C}select${N} ${I} from ${A}${G}${H}${ue}${S}${ne}${Le}${Ve}`;return f.length>0?this.buildSetOperations(Ke,f):Ke}buildSetOperations(e,s){const[r,...n]=s;if(!r)throw new Error("Cannot pass undefined values to any set operator");return n.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:r}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:r}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:s,isAll:r,rightSelect:n,limit:i,orderBy:o,offset:a}}){const l=c`${e.getSQL()} `,u=c`${n.getSQL()}`;let h;if(o&&o.length>0){const b=[];for(const _ of o)if(d(_,Re))b.push(c.identifier(_.name));else if(d(_,g)){for(let C=0;C<_.queryChunks.length;C++){const N=_.queryChunks[C];d(N,Re)&&(_.queryChunks[C]=c.identifier(N.name))}b.push(c`${_}`)}else b.push(c`${_}`);h=c` order by ${c.join(b,c`, `)}`}const m=i?c` limit ${i}`:void 0,y=c.raw(`${s} ${r?"all ":""}`),f=a?c` offset ${a}`:void 0;return c`${l}${y}${u}${h}${m}${f}`}buildInsertQuery({table:e,values:s,onConflict:r,returning:n,withList:i}){const o=[],a=e[w.Symbol.Columns],l=Object.entries(a),u=l.map(([,b])=>c.identifier(b.name));for(const[b,_]of s.entries()){const C=[];for(const[N,I]of l){const A=_[N];if(A===void 0||d(A,pe)&&A.value===void 0){let T;if(I.default!==null&&I.default!==void 0)T=d(I.default,g)?I.default:c.param(I.default,I);else if(I.defaultFn!==void 0){const G=I.defaultFn();T=d(G,g)?G:c.param(G,I)}else T=c`null`;C.push(T)}else C.push(A)}o.push(C),b<s.length-1&&o.push(c`, `)}const h=this.buildWithCTE(i),m=c.join(o),y=n?c` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,f=r?c` on conflict ${r}`:void 0;return c`${h}insert into ${e} ${u} values ${m}${f}${y}`}sqlToQuery(e){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString})}buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:n,tableConfig:i,queryConfig:o,tableAlias:a,nestedQueryRelation:l,joinOn:u}){let h=[],m,y,f=[],b;const _=[];if(o===!0)h=Object.entries(i.columns).map(([I,A])=>({dbKey:A.name,tsKey:I,field:re(A,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{const N=Object.fromEntries(Object.entries(i.columns).map(([S,R])=>[S,re(R,a)]));if(o.where){const S=typeof o.where=="function"?o.where(N,ta()):o.where;b=S&&it(S,a)}const I=[];let A=[];if(o.columns){let S=!1;for(const[R,Q]of Object.entries(o.columns))Q!==void 0&&R in i.columns&&(!S&&Q===!0&&(S=!0),A.push(R));A.length>0&&(A=S?A.filter(R=>o.columns?.[R]===!0):Object.keys(i.columns).filter(R=>!A.includes(R)))}else A=Object.keys(i.columns);for(const S of A){const R=i.columns[S];I.push({tsKey:S,value:R})}let T=[];o.with&&(T=Object.entries(o.with).filter(S=>!!S[1]).map(([S,R])=>({tsKey:S,queryConfig:R,relation:i.relations[S]})));let G;if(o.extras){G=typeof o.extras=="function"?o.extras(N,{sql:c}):o.extras;for(const[S,R]of Object.entries(G))I.push({tsKey:S,value:Ar(R,a)})}for(const{tsKey:S,value:R}of I)h.push({dbKey:d(R,g.Aliased)?R.fieldAlias:i.columns[S].name,tsKey:S,field:d(R,P)?re(R,a):R,relationTableTsKey:void 0,isJson:!1,selection:[]});let H=typeof o.orderBy=="function"?o.orderBy(N,sa()):o.orderBy??[];Array.isArray(H)||(H=[H]),f=H.map(S=>d(S,P)?re(S,a):it(S,a)),m=o.limit,y=o.offset;for(const{tsKey:S,queryConfig:R,relation:Q}of T){const ue=oa(s,r,Q),ne=Q.referencedTable[w.Symbol.Name],Le=r[ne],Ve=`${a}_${S}`,Ke=Ot(...ue.fields.map((se,dt)=>Tr(re(ue.references[dt],Ve),re(se,a)))),U=this.buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:e[Le],tableConfig:s[Le],queryConfig:d(Q,me)?R===!0?{limit:1}:{...R,limit:1}:R,tableAlias:Ve,joinOn:Ke,nestedQueryRelation:Q}),L=c`(${U.sql})`.as(S);h.push({dbKey:S,tsKey:S,field:L,relationTableTsKey:Le,isJson:!0,selection:U.selection})}}if(h.length===0)throw new Jt({message:`No fields selected for table "${i.tsName}" ("${a}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let C;if(b=Ot(u,b),l){let N=c`json_array(${c.join(h.map(({field:T})=>d(T,Re)?c.identifier(T.name):d(T,g.Aliased)?T.sql:T),c`, `)})`;d(l,ct)&&(N=c`coalesce(json_group_array(${N}), json_array())`);const I=[{dbKey:"data",tsKey:"data",field:N.as("data"),isJson:!0,relationTableTsKey:i.tsName,selection:h}];m!==void 0||y!==void 0||f.length>0?(C=this.buildSelectQuery({table:bt(n,a),fields:{},fieldsFlat:[{path:[],field:c.raw("*")}],where:b,limit:m,offset:y,orderBy:f,setOperators:[]}),b=void 0,m=void 0,y=void 0,f=void 0):C=bt(n,a),C=this.buildSelectQuery({table:d(C,J)?C:new te(C,{},a),fields:{},fieldsFlat:I.map(({field:T})=>({path:[],field:d(T,P)?re(T,a):T})),joins:_,where:b,limit:m,offset:y,orderBy:f,setOperators:[]})}else C=this.buildSelectQuery({table:bt(n,a),fields:{},fieldsFlat:h.map(({field:N})=>({path:[],field:d(N,P)?re(N,a):N})),joins:_,where:b,limit:m,offset:y,orderBy:f,setOperators:[]});return{tableTsKey:i.tsName,sql:C,selection:h}}}class Aa extends Lr{static[p]="SQLiteSyncDialect";migrate(e,s,r){const n=r===void 0||typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=c`
			CREATE TABLE IF NOT EXISTS ${c.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;s.run(i);const a=s.values(c`SELECT id, hash, created_at FROM ${c.identifier(n)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;s.run(c`BEGIN`);try{for(const l of e)if(!a||Number(a[2])<l.folderMillis){for(const u of l.sql)s.run(c.raw(u));s.run(c`INSERT INTO ${c.identifier(n)} ("hash", "created_at") VALUES(${l.hash}, ${l.folderMillis})`)}s.run(c`COMMIT`)}catch(l){throw s.run(c`ROLLBACK`),l}}}class Na extends Lr{static[p]="SQLiteAsyncDialect";async migrate(e,s,r){const n=typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=c`
			CREATE TABLE IF NOT EXISTS ${c.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await s.run(i);const a=(await s.values(c`SELECT id, hash, created_at FROM ${c.identifier(n)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await s.transaction(async l=>{for(const u of e)if(!a||Number(a[2])<u.folderMillis){for(const h of u.sql)await l.run(c.raw(h));await l.run(c`INSERT INTO ${c.identifier(n)} ("hash", "created_at") VALUES(${u.hash}, ${u.folderMillis})`)}})}}class Oa{static[p]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class oe{static[p]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){const s=!!this.fields;let r;return this.fields?r=this.fields:d(e,te)?r=Object.fromEntries(Object.keys(e[F].selection).map(n=>[n,e[n]])):d(e,$r)?r=e[V].selectedFields:d(e,g)?r={}:r=ha(e),new Er({table:e,fields:r,isPartialSelect:s,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}}class $a extends Oa{static[p]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:s,isPartialSelect:r,session:n,dialect:i,withList:o,distinct:a}){super(),this.config={withList:o,table:e,fields:{...s},distinct:a,setOperators:[]},this.isPartialSelect=r,this.session=n,this.dialect=i,this._={selectedFields:s},this.tableName=bs(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(s,r)=>{const n=this.tableName,i=bs(s);if(typeof i=="string"&&this.config.joins?.some(o=>o.alias===i))throw new Error(`Alias "${i}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof i=="string"&&!d(s,g))){const o=d(s,te)?s[F].selection:d(s,$e)?s[V].selectedFields:s[w.Symbol.Columns];this.config.fields[i]=o}if(typeof r=="function"&&(r=r(new Proxy(this.config.fields,new Y({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:r,table:s,joinType:e,alias:i}),typeof i=="string")switch(e){case"left":{this.joinsNotNullableMap[i]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!0;break}case"inner":{this.joinsNotNullableMap[i]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");createSetOperator(e,s){return r=>{const n=typeof r=="function"?r(La()):r;if(!Nr(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:s,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new Y({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new Y({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new Y({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(s)?s:[s]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new Y({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),r=Array.isArray(s)?s:[s];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}else{const s=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}as(e){return new Proxy(new te(this.getSQL(),this.config.fields,e),new Y({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new Y({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class Er extends $a{static[p]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const s=ye(this.config.fields),r=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),s,"all");return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}}ca(Er,[we]);function ht(t,e){return(s,r,...n)=>{const i=[r,...n].map(o=>({type:t,isAll:e,rightSelect:o}));for(const o of i)if(!Nr(s.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return s.addSetOperators(i)}}const La=()=>({union:Ea,unionAll:Pa,intersect:Qa,except:Ba}),Ea=ht("union",!1),Pa=ht("union",!0),Qa=ht("intersect",!1),Ba=ht("except",!1);class ja{static[p]="SQLiteQueryBuilder";dialect;$with(e){const s=this;return{as(r){return typeof r=="function"&&(r=r(s)),new Proxy(new _r(r.getSQL(),r.getSelectedFields(),e,!0),new Y({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(i){return new oe({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e})}function n(i){return new oe({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e,distinct:!0})}return{select:r,selectDistinct:n}}select(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new oe({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new Aa),this.dialect}}class Ss{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[p]="SQLiteUpdateBuilder";set(e){return new ka(this.table,Or(this.table,e),this.session,this.dialect,this.withList)}}class ka extends we{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={set:s,table:e,withList:i}}static[p]="SQLiteUpdate";config;where(e){return this.config.where=e,this}returning(e=this.config.table[J.Symbol.Columns]){return this.config.returning=ye(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class Ua{constructor(e,s,r,n,i,o,a,l){this.mode=e,this.fullSchema=s,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=o,this.dialect=a,this.session=l}static[p]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new xs(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new Et(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new xs(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new Et(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}}class Et extends we{constructor(e,s,r,n,i,o,a,l,u){super(),this.fullSchema=e,this.schema=s,this.tableNamesMap=r,this.table=n,this.tableConfig=i,this.dialect=o,this.session=a,this.config=l,this.mode=u}static[p]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){const{query:s,builtQuery:r}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](r,void 0,this.mode==="first"?"get":"all",(n,i)=>{const o=n.map(a=>$t(this.schema,this.tableConfig,a,s.selection,i));return this.mode==="first"?o[0]:o})}prepare(){return this._prepare(!1)}_toSQL(){const e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),s=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:s}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}}class xs extends Et{static[p]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}}class We extends we{constructor(e,s,r,n,i){super(),this.execute=e,this.getSQL=s,this.dialect=n,this.mapBatchResult=i,this.config={action:r}}static[p]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,s){return s?this.mapBatchResult(e):e}_prepare(){return this}}class Pr{constructor(e,s,r,n){this.resultKind=e,this.dialect=s,this.session=r,this._=n?{schema:n.schema,tableNamesMap:n.tableNamesMap}:{schema:void 0,tableNamesMap:{}},this.query={};const i=this.query;if(this._.schema)for(const[o,a]of Object.entries(this._.schema))i[o]=new Ua(e,n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[o],a,s,r)}static[p]="BaseSQLiteDatabase";query;$with(e){return{as(s){return typeof s=="function"&&(s=s(new ja)),new Proxy(new _r(s.getSQL(),s.getSelectedFields(),e,!0),new Y({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(l){return new oe({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e})}function n(l){return new oe({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e,distinct:!0})}function i(l){return new Ss(l,s.session,s.dialect,e)}function o(l){return new gs(l,s.session,s.dialect,e)}function a(l){return new ws(l,s.session,s.dialect,e)}return{select:r,selectDistinct:n,update:i,insert:o,delete:a}}select(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new oe({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new Ss(e,this.session,this.dialect)}insert(e){return new gs(e,this.session,this.dialect)}delete(e){return new ws(e,this.session,this.dialect)}run(e){const s=e.getSQL();return this.resultKind==="async"?new We(async()=>this.session.run(s),()=>s,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(s)}all(e){const s=e.getSQL();return this.resultKind==="async"?new We(async()=>this.session.all(s),()=>s,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(s)}get(e){const s=e.getSQL();return this.resultKind==="async"?new We(async()=>this.session.get(s),()=>s,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(s)}values(e){const s=e.getSQL();return this.resultKind==="async"?new We(async()=>this.session.values(s),()=>s,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(s)}transaction(e,s){return this.session.transaction(e,s)}}class Da extends we{constructor(e){super(),this.resultCb=e}static[p]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}}class Ma{constructor(e,s,r){this.mode=e,this.executeMethod=s,this.query=r}static[p]="PreparedQuery";joinsNotNullableMap;getQuery(){return this.query}mapRunResult(e,s){return e}mapAllResult(e,s){throw new Error("Not implemented")}mapGetResult(e,s){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new Da(()=>this[this.executeMethod](e))}mapResult(e,s){switch(this.executeMethod){case"run":return this.mapRunResult(e,s);case"all":return this.mapAllResult(e,s);case"get":return this.mapGetResult(e,s)}}}class Fa{constructor(e){this.dialect=e}static[p]="SQLiteSession";prepareOneTimeQuery(e,s,r){return this.prepareQuery(e,s,r)}run(e){const s=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(s,void 0,"run").run()}catch(r){throw new Jt({cause:r,message:`Failed to run the query '${s.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").values()}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}}class za extends Pr{constructor(e,s,r,n,i=0){super(e,s,r,n),this.schema=n,this.nestedIndex=i}static[p]="SQLiteTransaction";rollback(){throw new fa}}class Zt extends Fa{constructor(e,s,r,n,i){super(s),this.client=e,this.schema=r,this.options=n,this.tx=i,this.logger=n.logger??new Co}static[p]="LibSQLSession";logger;prepareQuery(e,s,r,n){return new Va(this.client,e,this.logger,s,this.tx,r,n)}async batch(e){const s=[],r=[];for(const i of e){const o=i._prepare(),a=o.getQuery();s.push(o),r.push({sql:a.sql,args:a.params})}return(await this.client.batch(r)).map((i,o)=>s[o].mapResult(i,!0))}async transaction(e,s){const r=await this.client.transaction(),n=new Zt(this.client,this.dialect,this.schema,this.options,r),i=new Xt("async",this.dialect,n,this.schema);try{const o=await e(i);return await r.commit(),o}catch(o){throw await r.rollback(),o}}extractRawAllValueFromBatchResult(e){return e.rows}extractRawGetValueFromBatchResult(e){return e.rows[0]}extractRawValuesValueFromBatchResult(e){return e.rows}}class Xt extends za{static[p]="LibSQLTransaction";async transaction(e){const s=`sp${this.nestedIndex}`,r=new Xt("async",this.dialect,this.session,this.schema,this.nestedIndex+1);await this.session.run(c.raw(`savepoint ${s}`));try{const n=await e(r);return await this.session.run(c.raw(`release savepoint ${s}`)),n}catch(n){throw await this.session.run(c.raw(`rollback to savepoint ${s}`)),n}}}class Va extends Ma{constructor(e,s,r,n,i,o,a){super("async",o,s),this.client=e,this.logger=r,this.fields=n,this.tx=i,this.customResultMapper=a,this.customResultMapper=a,this.fields=n}static[p]="LibSQLPreparedQuery";run(e){const s=Je(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return this.tx?this.tx.execute(r):this.client.execute(r)}async all(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const u=Je(n.params,e??{});r.logQuery(n.sql,u);const h={sql:n.sql,args:u};return(i?i.execute(h):o.execute(h)).then(({rows:m})=>this.mapAllResult(m))}const l=await this.values(e);return this.mapAllResult(l)}mapAllResult(e,s){return s&&(e=e.rows),!this.fields&&!this.customResultMapper?e.map(r=>qs(r)):this.customResultMapper?this.customResultMapper(e,Ge):e.map(r=>ys(this.fields,Array.prototype.slice.call(r).map(n=>Ge(n)),this.joinsNotNullableMap))}async get(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const u=Je(n.params,e??{});r.logQuery(n.sql,u);const h={sql:n.sql,args:u};return(i?i.execute(h):o.execute(h)).then(({rows:m})=>this.mapGetResult(m))}const l=await this.values(e);return this.mapGetResult(l)}mapGetResult(e,s){s&&(e=e.rows);const r=e[0];if(!this.fields&&!this.customResultMapper)return qs(r);if(r)return this.customResultMapper?this.customResultMapper(e,Ge):ys(this.fields,Array.prototype.slice.call(r).map(n=>Ge(n)),this.joinsNotNullableMap)}values(e){const s=Je(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return(this.tx?this.tx.execute(r):this.client.execute(r)).then(({rows:n})=>n)}}function qs(t){return Object.keys(t).reduce((e,s)=>(Object.prototype.propertyIsEnumerable.call(t,s)&&(e[s]=t[s]),e),{})}function Ge(t){if(typeof ArrayBuffer<"u"&&t instanceof ArrayBuffer){if(typeof Buffer<"u")return t instanceof Buffer?t:Buffer.from(t);if(typeof TextDecoder<"u")return new TextDecoder().decode(t);throw new Error("TextDecoder is not available. Please provide either Buffer or TextDecoder polyfill.")}return t}class Ka extends Pr{static[p]="LibSQLDatabase";async batch(e){return this.session.batch(e)}}function Ha(t,e={}){const s=new Na;let r;e.logger===!0?r=new Ro:e.logger!==!1&&(r=e.logger);let n;if(e.schema){const o=ra(e.schema,aa);n={fullSchema:e.schema,schema:o.tables,tableNamesMap:o.tableNamesMap}}const i=new Zt(t,s,n,{logger:r},void 0);return new Ka("async",s,i,n)}const Qr=Ha(qo),Br=ua("users",{id:Pe("id").primaryKey(),name:Ia("name").notNull(),responses:Pe("responses").notNull().default(0),nps:Pe("nps").notNull().default(0),csat:Pe("csat").notNull().default(0),rd:Pe("rd").notNull().default(0)});async function Ja(){try{return await Qr.select().from(Br).execute()}catch(t){throw console.error("Error al obtener usuarios:",t),new Error(`No se pudieron obtener los usuarios: ${t}`)}}async function Wa(t){try{await Qr.update(Br).set(t).where(c`id = ${t.id}`).execute()}catch(e){throw console.error("Error al actualizar usuario:",e),new Error(`No se pudo actualizar el usuario: ${e}`)}}var Ga=["x1","y1","x2","y2","key"],Ya=["offset"];function be(t){"@babel/helpers - typeof";return be=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},be(t)}function _s(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),s.push.apply(s,r)}return s}function M(t){for(var e=1;e<arguments.length;e++){var s=arguments[e]!=null?arguments[e]:{};e%2?_s(Object(s),!0).forEach(function(r){Za(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):_s(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}function Za(t,e,s){return e=Xa(e),e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function Xa(t){var e=el(t,"string");return be(e)=="symbol"?e:String(e)}function el(t,e){if(be(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,e||"default");if(be(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function he(){return he=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},he.apply(this,arguments)}function Rs(t,e){if(t==null)return{};var s=tl(t,e),r,n;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],!(e.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(s[r]=t[r])}return s}function tl(t,e){if(t==null)return{};var s={},r=Object.keys(t),n,i;for(i=0;i<r.length;i++)n=r[i],!(e.indexOf(n)>=0)&&(s[n]=t[n]);return s}var sl=function(e){var s=e.fill;if(!s||s==="none")return null;var r=e.fillOpacity,n=e.x,i=e.y,o=e.width,a=e.height;return D.createElement("rect",{x:n,y:i,width:o,height:a,stroke:"none",fill:s,fillOpacity:r,className:"recharts-cartesian-grid-bg"})};function jr(t,e){var s;if(D.isValidElement(t))s=D.cloneElement(t,e);else if(wt(t))s=t(e);else{var r=e.x1,n=e.y1,i=e.x2,o=e.y2,a=e.key,l=Rs(e,Ga),u=Vr(l,!1);u.offset;var h=Rs(u,Ya);s=D.createElement("line",he({},h,{x1:r,y1:n,x2:i,y2:o,fill:"none",key:a}))}return s}function rl(t){var e=t.x,s=t.width,r=t.horizontal,n=r===void 0?!0:r,i=t.horizontalPoints;if(!n||!i||!i.length)return null;var o=i.map(function(a,l){var u=M(M({},t),{},{x1:e,y1:a,x2:e+s,y2:a,key:"line-".concat(l),index:l});return jr(n,u)});return D.createElement("g",{className:"recharts-cartesian-grid-horizontal"},o)}function nl(t){var e=t.y,s=t.height,r=t.vertical,n=r===void 0?!0:r,i=t.verticalPoints;if(!n||!i||!i.length)return null;var o=i.map(function(a,l){var u=M(M({},t),{},{x1:a,y1:e,x2:a,y2:e+s,key:"line-".concat(l),index:l});return jr(n,u)});return D.createElement("g",{className:"recharts-cartesian-grid-vertical"},o)}function il(t){var e=t.horizontalFill,s=t.fillOpacity,r=t.x,n=t.y,i=t.width,o=t.height,a=t.horizontalPoints,l=t.horizontal,u=l===void 0?!0:l;if(!u||!e||!e.length)return null;var h=a.map(function(y){return Math.round(y+n-n)}).sort(function(y,f){return y-f});n!==h[0]&&h.unshift(0);var m=h.map(function(y,f){var b=!h[f+1],_=b?n+o-y:h[f+1]-y;if(_<=0)return null;var C=f%e.length;return D.createElement("rect",{key:"react-".concat(f),y,x:r,height:_,width:i,stroke:"none",fill:e[C],fillOpacity:s,className:"recharts-cartesian-grid-bg"})});return D.createElement("g",{className:"recharts-cartesian-gridstripes-horizontal"},m)}function ol(t){var e=t.vertical,s=e===void 0?!0:e,r=t.verticalFill,n=t.fillOpacity,i=t.x,o=t.y,a=t.width,l=t.height,u=t.verticalPoints;if(!s||!r||!r.length)return null;var h=u.map(function(y){return Math.round(y+i-i)}).sort(function(y,f){return y-f});i!==h[0]&&h.unshift(0);var m=h.map(function(y,f){var b=!h[f+1],_=b?i+a-y:h[f+1]-y;if(_<=0)return null;var C=f%r.length;return D.createElement("rect",{key:"react-".concat(f),x:y,y:o,width:_,height:l,stroke:"none",fill:r[C],fillOpacity:n,className:"recharts-cartesian-grid-bg"})});return D.createElement("g",{className:"recharts-cartesian-gridstripes-vertical"},m)}var al=function(e,s){var r=e.xAxis,n=e.width,i=e.height,o=e.offset;return Cs(vs(M(M(M({},Is.defaultProps),r),{},{ticks:Ts(r,!0),viewBox:{x:0,y:0,width:n,height:i}})),o.left,o.left+o.width,s)},ll=function(e,s){var r=e.yAxis,n=e.width,i=e.height,o=e.offset;return Cs(vs(M(M(M({},Is.defaultProps),r),{},{ticks:Ts(r,!0),viewBox:{x:0,y:0,width:n,height:i}})),o.top,o.top+o.height,s)},ge={horizontal:!0,vertical:!0,horizontalPoints:[],verticalPoints:[],stroke:"#ccc",fill:"none",verticalFill:[],horizontalFill:[]};function kr(t){var e,s,r,n,i,o,a=Ur(),l=Dr(),u=Mr(),h=M(M({},t),{},{stroke:(e=t.stroke)!==null&&e!==void 0?e:ge.stroke,fill:(s=t.fill)!==null&&s!==void 0?s:ge.fill,horizontal:(r=t.horizontal)!==null&&r!==void 0?r:ge.horizontal,horizontalFill:(n=t.horizontalFill)!==null&&n!==void 0?n:ge.horizontalFill,vertical:(i=t.vertical)!==null&&i!==void 0?i:ge.vertical,verticalFill:(o=t.verticalFill)!==null&&o!==void 0?o:ge.verticalFill,x:ie(t.x)?t.x:u.left,y:ie(t.y)?t.y:u.top,width:ie(t.width)?t.width:u.width,height:ie(t.height)?t.height:u.height}),m=h.x,y=h.y,f=h.width,b=h.height,_=h.syncWithTicks,C=h.horizontalValues,N=h.verticalValues,I=Fr(),A=zr();if(!ie(f)||f<=0||!ie(b)||b<=0||!ie(m)||m!==+m||!ie(y)||y!==+y)return null;var T=h.verticalCoordinatesGenerator||al,G=h.horizontalCoordinatesGenerator||ll,H=h.horizontalPoints,S=h.verticalPoints;if((!H||!H.length)&&wt(G)){var R=C&&C.length,Q=G({yAxis:A?M(M({},A),{},{ticks:R?C:A.ticks}):void 0,width:a,height:l,offset:u},R?!0:_);rs(Array.isArray(Q),"horizontalCoordinatesGenerator should return Array but instead it returned [".concat(be(Q),"]")),Array.isArray(Q)&&(H=Q)}if((!S||!S.length)&&wt(T)){var ue=N&&N.length,ne=T({xAxis:I?M(M({},I),{},{ticks:ue?N:I.ticks}):void 0,width:a,height:l,offset:u},ue?!0:_);rs(Array.isArray(ne),"verticalCoordinatesGenerator should return Array but instead it returned [".concat(be(ne),"]")),Array.isArray(ne)&&(S=ne)}return D.createElement("g",{className:"recharts-cartesian-grid"},D.createElement(sl,{fill:h.fill,fillOpacity:h.fillOpacity,x:h.x,y:h.y,width:h.width,height:h.height}),D.createElement(rl,he({},h,{offset:u,horizontalPoints:H,xAxis:I,yAxis:A})),D.createElement(nl,he({},h,{offset:u,verticalPoints:S,xAxis:I,yAxis:A})),D.createElement(il,he({},h,{horizontalPoints:H})),D.createElement(ol,he({},h,{verticalPoints:S})))}kr.displayName="CartesianGrid";var ul=Kr({chartName:"BarChart",GraphicalChild:Qe,defaultTooltipEventType:"axis",validateTooltipEventTypes:["axis","item"],axisComponents:[{axisType:"xAxis",AxisComp:As},{axisType:"yAxis",AxisComp:Ns}],formatAxisMap:Hr});const bl=()=>{const[t,e]=Ee.useState([]),[s,r]=Ee.useState(!0),[n,i]=Ee.useState(null),[o,a]=Ee.useState("");Ee.useEffect(()=>{(async()=>{try{r(!0);const b=await Ja();e(b),i(null)}catch(b){console.error("Error al cargar usuarios:",b),i(`Error al cargar las métricas: ${b instanceof Error?b.message:String(b)}`)}finally{r(!1)}})()},[]);const l=async f=>{try{await Wa(f),e(t.map(b=>b.id===f.id?f:b))}catch(b){console.error("Error al actualizar el usuario:",b),i(`Error al actualizar el usuario: ${b instanceof Error?b.message:String(b)}`)}},u=(f,b,_)=>{e(t.map(C=>C.id===f?{...C,[b]:Number(_)}:C))},h=f=>f>=15?"#28a745":f>=0?"#ffc107":"#dc3545",m=f=>f>70?"#28a745":f>=65?"#ffc107":"#dc3545",y=t.filter(f=>f.name.toLowerCase().includes(o.toLowerCase()));return s?x.jsx("div",{children:"Cargando datos de usuarios..."}):n?x.jsxs("div",{children:["Error: ",n]}):t.length===0?x.jsx("div",{children:"No se encontraron datos de usuarios."}):x.jsxs("div",{children:[x.jsx("h1",{children:"Métricas - NPS Individual"}),x.jsx("input",{type:"text",placeholder:"Buscar por nombre...",value:o,onChange:f=>a(f.target.value),style:{marginBottom:"20px",padding:"5px",width:"200px"}}),x.jsx(Jr,{width:"100%",height:500,children:x.jsxs(ul,{data:y,margin:{top:20,right:30,left:20,bottom:5},children:[x.jsx(kr,{strokeDasharray:"3 3"}),x.jsx(As,{dataKey:"name"}),x.jsx(Ns,{}),x.jsx(Wr,{}),x.jsx(Gr,{}),x.jsx(Qe,{dataKey:"responses",fill:"#8884d8",name:"Respuestas"}),x.jsx(Qe,{dataKey:"nps",name:"NPS",children:y.map(f=>x.jsx(ft,{fill:h(f.nps)},`cell-nps-${f.id}`))}),x.jsx(Qe,{dataKey:"csat",name:"CSAT",children:y.map(f=>x.jsx(ft,{fill:m(f.csat)},`cell-csat-${f.id}`))}),x.jsx(Qe,{dataKey:"rd",name:"RD",children:y.map(f=>x.jsx(ft,{fill:m(f.rd)},`cell-rd-${f.id}`))})]})}),x.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"20px"},children:y.map(f=>x.jsxs("div",{style:{border:"1px solid #ddd",padding:"15px",borderRadius:"8px",width:"300px"},children:[x.jsx("h2",{children:f.name}),x.jsx("div",{style:{marginBottom:"10px"},children:x.jsxs("label",{children:["Respuestas:",x.jsx("input",{type:"number",value:f.responses,onChange:b=>u(f.id,"responses",b.target.value),style:{width:"100%"}})]})}),x.jsx("div",{style:{marginBottom:"10px"},children:x.jsxs("label",{children:["NPS:",x.jsx("input",{type:"number",value:f.nps,onChange:b=>u(f.id,"nps",b.target.value),style:{width:"100%"}})]})}),x.jsx("div",{style:{marginBottom:"10px"},children:x.jsxs("label",{children:["CSAT:",x.jsx("input",{type:"number",value:f.csat,onChange:b=>u(f.id,"csat",b.target.value),style:{width:"100%"}})]})}),x.jsx("div",{style:{marginBottom:"10px"},children:x.jsxs("label",{children:["RD:",x.jsx("input",{type:"number",value:f.rd,onChange:b=>u(f.id,"rd",b.target.value),style:{width:"100%"}})]})}),x.jsx("button",{onClick:()=>l(f),style:{width:"100%",padding:"10px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.3s"},onMouseOver:b=>b.currentTarget.style.backgroundColor="#0056b3",onMouseOut:b=>b.currentTarget.style.backgroundColor="#007bff",children:"Guardar Cambios"})]},f.id))})]})};export{bl as default};
