import{g as _r}from"./index.DJO9vBfz.js";class q extends Error{code;rawCode;constructor(e,s,r,n){s!==void 0&&(e=`${s}: ${e}`),super(e,{cause:n}),this.code=s,this.rawCode=r,this.name="LibsqlError"}}function qr(t){const e=Rr.exec(t);if(e===null)throw new q(`The URL '${t}' is not in a valid format`,"URL_INVALID");const s=e.groups,r=s.scheme,n=s.authority!==void 0?xr(s.authority):void 0,i=re(s.path),o=s.query!==void 0?Ir(s.query):void 0,a=s.fragment!==void 0?re(s.fragment):void 0;return{scheme:r,authority:n,path:i,query:o,fragment:a}}const Rr=(()=>{const t="(?<scheme>[A-Za-z][A-Za-z.+-]*)",e="(?<authority>[^/?#]*)",s="(?<path>[^?#]*)",r="(?<query>[^#]*)",n="(?<fragment>.*)";return new RegExp(`^${t}:(//${e})?${s}(\\?${r})?(#${n})?$`,"su")})();function xr(t){const e=Cr.exec(t);if(e===null)throw new q("The authority part of the URL is not in a valid format","URL_INVALID");const s=e.groups,r=re(s.host_br??s.host),n=s.port?parseInt(s.port,10):void 0,i=s.username!==void 0?{username:re(s.username),password:s.password!==void 0?re(s.password):void 0}:void 0;return{host:r,port:n,userinfo:i}}const Cr=new RegExp("^((?<username>[^:]*)(:(?<password>.*))?@)?((?<host>[^:\\[\\]]*)|(\\[(?<host_br>[^\\[\\]]*)\\]))(:(?<port>[0-9]*))?$","su");function Ir(t){const e=t.split("&"),s=[];for(const r of e){if(r==="")continue;let n,i;const o=r.indexOf("=");o<0?(n=r,i=""):(n=r.substring(0,o),i=r.substring(o+1)),s.push({key:re(n.replaceAll("+"," ")),value:re(i.replaceAll("+"," "))})}return{pairs:s}}function re(t){try{return decodeURIComponent(t)}catch(e){throw e instanceof URIError?new q(`URL component has invalid percent encoding: ${e}`,"URL_INVALID",void 0,e):e}}function lt(t,e,s){if(e===void 0)throw new q(`URL with scheme ${JSON.stringify(t+":")} requires authority (the "//" part)`,"URL_INVALID");const r=`${t}:`,n=Tr(e.host),i=$r(e.port),a=`//${Lr(e.userinfo)}${n}${i}`;let l=s.split("/").map(encodeURIComponent).join("/");return l!==""&&!l.startsWith("/")&&(l="/"+l),new URL(`${r}${a}${l}`)}function Tr(t){return t.includes(":")?`[${encodeURI(t)}]`:encodeURI(t)}function $r(t){return t!==void 0?`:${t}`:""}function Lr(t){if(t===void 0)return"";const e=encodeURIComponent(t.username),s=t.password!==void 0?`:${encodeURIComponent(t.password)}`:"";return`${e}${s}@`}const ms="3.7.7",Ar=ms,ge=typeof Buffer=="function",Jt=typeof TextDecoder=="function"?new TextDecoder:void 0,Wt=typeof TextEncoder=="function"?new TextEncoder:void 0,Nr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",xe=Array.prototype.slice.call(Nr),Pe=(t=>{let e={};return t.forEach((s,r)=>e[s]=r),e})(xe),Er=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Q=String.fromCharCode.bind(String),Ht=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),ys=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),bs=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),ws=t=>{let e,s,r,n,i="";const o=t.length%3;for(let a=0;a<t.length;){if((s=t.charCodeAt(a++))>255||(r=t.charCodeAt(a++))>255||(n=t.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=s<<16|r<<8|n,i+=xe[e>>18&63]+xe[e>>12&63]+xe[e>>6&63]+xe[e&63]}return o?i.slice(0,o-3)+"===".substring(o):i},xt=typeof btoa=="function"?t=>btoa(t):ge?t=>Buffer.from(t,"binary").toString("base64"):ws,ut=ge?t=>Buffer.from(t).toString("base64"):t=>{let s=[];for(let r=0,n=t.length;r<n;r+=4096)s.push(Q.apply(null,t.subarray(r,r+4096)));return xt(s.join(""))},je=(t,e=!1)=>e?ys(ut(t)):ut(t),vr=t=>{if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?Q(192|e>>>6)+Q(128|e&63):Q(224|e>>>12&15)+Q(128|e>>>6&63)+Q(128|e&63)}else{var e=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return Q(240|e>>>18&7)+Q(128|e>>>12&63)+Q(128|e>>>6&63)+Q(128|e&63)}},Or=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,gs=t=>t.replace(Or,vr),Gt=ge?t=>Buffer.from(t,"utf8").toString("base64"):Wt?t=>ut(Wt.encode(t)):t=>xt(gs(t)),fe=(t,e=!1)=>e?ys(Gt(t)):Gt(t),Yt=t=>fe(t,!0),Qr=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Br=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),s=e-65536;return Q((s>>>10)+55296)+Q((s&1023)+56320);case 3:return Q((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return Q((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},Ss=t=>t.replace(Qr,Br),_s=t=>{if(t=t.replace(/\s+/g,""),!Er.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,s="",r,n;for(let i=0;i<t.length;)e=Pe[t.charAt(i++)]<<18|Pe[t.charAt(i++)]<<12|(r=Pe[t.charAt(i++)])<<6|(n=Pe[t.charAt(i++)]),s+=r===64?Q(e>>16&255):n===64?Q(e>>16&255,e>>8&255):Q(e>>16&255,e>>8&255,e&255);return s},Ct=typeof atob=="function"?t=>atob(bs(t)):ge?t=>Buffer.from(t,"base64").toString("binary"):_s,qs=ge?t=>Ht(Buffer.from(t,"base64")):t=>Ht(Ct(t).split("").map(e=>e.charCodeAt(0))),Rs=t=>qs(xs(t)),Pr=ge?t=>Buffer.from(t,"base64").toString("utf8"):Jt?t=>Jt.decode(qs(t)):t=>Ss(Ct(t)),xs=t=>bs(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),ct=t=>Pr(xs(t)),Ur=t=>{if(typeof t!="string")return!1;const e=t.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(e)||!/[^\s0-9a-zA-Z\-_]/.test(e)},Cs=t=>({value:t,enumerable:!1,writable:!0,configurable:!0}),Is=function(){const t=(e,s)=>Object.defineProperty(String.prototype,e,Cs(s));t("fromBase64",function(){return ct(this)}),t("toBase64",function(e){return fe(this,e)}),t("toBase64URI",function(){return fe(this,!0)}),t("toBase64URL",function(){return fe(this,!0)}),t("toUint8Array",function(){return Rs(this)})},Ts=function(){const t=(e,s)=>Object.defineProperty(Uint8Array.prototype,e,Cs(s));t("toBase64",function(e){return je(this,e)}),t("toBase64URI",function(){return je(this,!0)}),t("toBase64URL",function(){return je(this,!0)})},Dr=()=>{Is(),Ts()},It={version:ms,VERSION:Ar,atob:Ct,atobPolyfill:_s,btoa:xt,btoaPolyfill:ws,fromBase64:ct,toBase64:fe,encode:fe,encodeURI:Yt,encodeURL:Yt,utob:gs,btou:Ss,decode:ct,isValid:Ur,fromUint8Array:je,toUint8Array:Rs,extendString:Is,extendUint8Array:Ts,extendBuiltins:Dr},Le="https://github.com/libsql/libsql-client-ts#supported-urls";function ht(t){if(t==="write")return"BEGIN IMMEDIATE";if(t==="read")return"BEGIN TRANSACTION READONLY";if(t==="deferred")return"BEGIN DEFERRED";throw RangeError('Unknown transaction mode, supported values are "write", "read" and "deferred"')}class Mr{columns;columnTypes;rows;rowsAffected;lastInsertRowid;constructor(e,s,r,n,i){this.columns=e,this.columnTypes=s,this.rows=r,this.rowsAffected=n,this.lastInsertRowid=i}toJSON(){return{columns:this.columns,columnTypes:this.columnTypes,rows:this.rows.map(jr),rowsAffected:this.rowsAffected,lastInsertRowid:this.lastInsertRowid!==void 0?""+this.lastInsertRowid:null}}}function jr(t){return Array.prototype.map.call(t,kr)}function kr(t){return typeof t=="bigint"?""+t:t instanceof ArrayBuffer?It.fromUint8Array(new Uint8Array(t)):t}function Fr(t,e){if(typeof t!="object")throw new TypeError(`Expected client configuration as object, got ${typeof t}`);const s=Math.max(0,t.concurrency||20);let r=t.tls,n=t.authToken,i=t.encryptionKey,o=t.syncUrl,a=t.syncInterval;const l=""+(t.intMode??"number");if(l!=="number"&&l!=="bigint"&&l!=="string")throw new TypeError(`Invalid value for intMode, expected "number", "bigint" or "string",             got ${JSON.stringify(l)}`);if(t.url===":memory:")return{path:":memory:",scheme:"file",syncUrl:o,syncInterval:a,intMode:l,fetch:t.fetch,tls:!1,authToken:void 0,encryptionKey:void 0,authority:void 0,concurrency:s};const u=qr(t.url);for(const{key:b,value:S}of u.query?.pairs??[])if(b==="authToken")n=S||void 0;else if(b==="tls")if(S==="0")r=!1;else if(S==="1")r=!0;else throw new q(`Unknown value for the "tls" query argument: ${JSON.stringify(S)}. Supported values are "0" and "1"`,"URL_INVALID");else throw new q(`Unknown URL query parameter ${JSON.stringify(b)}`,"URL_PARAM_NOT_SUPPORTED");const h=u.scheme.toLowerCase();let p;if(h==="libsql")if(r===!1){if(u.authority?.port===void 0)throw new q('A "libsql:" URL with ?tls=0 must specify an explicit port',"URL_INVALID");p="http"}else p="https";else if(h==="http"||h==="ws")p=h,r??=!1;else if(h==="https"||h==="wss"||h==="file")p=h;else throw new q(`The client supports only "libsql:", "wss:", "ws:", "https:", "http:" and "file:" URLs, got ${JSON.stringify(u.scheme+":")}. For more information, please read ${Le}`,"URL_SCHEME_NOT_SUPPORTED");if(u.fragment!==void 0)throw new q(`URL fragments are not supported: ${JSON.stringify("#"+u.fragment)}`,"URL_INVALID");return{scheme:p,tls:r??!0,authority:u.authority,path:u.path,authToken:n,encryptionKey:i,syncUrl:o,syncInterval:a,intMode:l,fetch:t.fetch,concurrency:s}}let ce;typeof WebSocket<"u"?ce=WebSocket:typeof global<"u"?ce=global.WebSocket:typeof window<"u"?ce=window.WebSocket:typeof self<"u"&&(ce=self.WebSocket);class $s{constructor(){this.intMode="number"}intMode}class T extends Error{constructor(e){super(e),this.name="ClientError"}}class w extends T{constructor(e){super(e),this.name="ProtoError"}}class Ls extends T{code;proto;constructor(e,s){super(e),this.name="ResponseError",this.code=s.code,this.proto=s,this.stack=void 0}}class z extends T{constructor(e,s){s!==void 0?(super(`${e}: ${s}`),this.cause=s):super(e),this.name="ClosedError"}}class As extends T{constructor(e){super(e),this.name="WebSocketUnsupportedError"}}class dt extends T{constructor(e){super(e),this.name="WebSocketError"}}class Ns extends T{status;constructor(e,s){super(e),this.status=s,this.name="HttpServerError"}}class me extends T{constructor(e){super(e),this.name="ProtocolVersionError"}}class ee extends T{constructor(e){super(e),this.name="InternalError"}}class Se extends T{constructor(e){super(e),this.name="MisuseError"}}function J(t){if(typeof t=="string")return t;throw _e(t,"string")}function W(t){if(t!=null){if(typeof t=="string")return t;throw _e(t,"string or null")}}function ne(t){if(typeof t=="number")return t;throw _e(t,"number")}function Ae(t){if(typeof t=="boolean")return t;throw _e(t,"boolean")}function Fe(t){if(Array.isArray(t))return t;throw _e(t,"array")}function P(t){if(t!==null&&typeof t=="object"&&!Array.isArray(t))return t;throw _e(t,"object")}function te(t,e){return Fe(t).map(s=>e(P(s)))}function _e(t,e){if(t===void 0)return new w(`Expected ${e}, but the property was missing`);let s=typeof t;return t===null?s="null":Array.isArray(t)&&(s="array"),new w(`Expected ${e}, received ${s}`)}function Tt(t,e){return e(P(t))}class Vr{#e;#t;constructor(e){this.#e=e,this.#t=!1}begin(){this.#e.push("{"),this.#t=!0}end(){this.#e.push("}"),this.#t=!1}#s(e){this.#t?(this.#e.push('"'),this.#t=!1):this.#e.push(',"'),this.#e.push(e),this.#e.push('":')}string(e,s){this.#s(e),this.#e.push(JSON.stringify(s))}stringRaw(e,s){this.#s(e),this.#e.push('"'),this.#e.push(s),this.#e.push('"')}number(e,s){this.#s(e),this.#e.push(""+s)}boolean(e,s){this.#s(e),this.#e.push(s?"true":"false")}object(e,s,r){this.#s(e),this.begin(),r(this,s),this.end()}arrayObjects(e,s,r){this.#s(e),this.#e.push("[");for(let n=0;n<s.length;++n)n!==0&&this.#e.push(","),this.begin(),r(this,s[n]),this.end();this.#e.push("]")}}function Es(t,e){const s=[],r=new Vr(s);return r.begin(),e(r,t),r.end(),s.join("")}const Ie=0,ft=1,pt=2,zr=5;class Kr{#e;#t;#s;constructor(e){this.#e=e,this.#t=new DataView(e.buffer,e.byteOffset,e.byteLength),this.#s=0}varint(){let e=0;for(let s=0;;s+=7){const r=this.#e[this.#s++];if(e|=(r&127)<<s,!(r&128))break}return e}varintBig(){let e=0n;for(let s=0n;;s+=7n){const r=this.#e[this.#s++];if(e|=BigInt(r&127)<<s,!(r&128))break}return e}bytes(e){const s=new Uint8Array(this.#e.buffer,this.#e.byteOffset+this.#s,e);return this.#s+=e,s}double(){const e=this.#t.getFloat64(this.#s,!0);return this.#s+=8,e}skipVarint(){for(;this.#e[this.#s++]&128;);}skip(e){this.#s+=e}eof(){return this.#s>=this.#e.byteLength}}class Jr{#e;#t;constructor(e){this.#e=e,this.#t=-1}setup(e){this.#t=e}#s(e){if(this.#t!==e)throw new w(`Expected wire type ${e}, got ${this.#t}`);this.#t=-1}bytes(){this.#s(pt);const e=this.#e.varint();return this.#e.bytes(e)}string(){return new TextDecoder().decode(this.bytes())}message(e){return Ye(this.bytes(),e)}int32(){return this.#s(Ie),this.#e.varint()}uint32(){return this.int32()}bool(){return this.int32()!==0}uint64(){return this.#s(Ie),this.#e.varintBig()}sint64(){const e=this.uint64();return e>>1n^-(e&1n)}double(){return this.#s(ft),this.#e.double()}maybeSkip(){if(!(this.#t<0)){if(this.#t===Ie)this.#e.skipVarint();else if(this.#t===ft)this.#e.skip(8);else if(this.#t===pt){const e=this.#e.varint();this.#e.skip(e)}else if(this.#t===zr)this.#e.skip(4);else throw new w(`Unexpected wire type ${this.#t}`);this.#t=-1}}}function Ye(t,e){const s=new Kr(t),r=new Jr(s);let n=e.default();for(;!s.eof();){const i=s.varint(),o=i>>3,a=i&7;r.setup(a);const l=e[o];if(l!==void 0){const u=l(r,n);u!==void 0&&(n=u)}r.maybeSkip()}return n}class $t{#e;#t;#s;#r;constructor(){this.#e=new ArrayBuffer(256),this.#t=new Uint8Array(this.#e),this.#s=new DataView(this.#e),this.#r=0}#i(e){if(this.#r+e<=this.#e.byteLength)return;let s=this.#e.byteLength;for(;s<this.#r+e;)s*=2;const r=new ArrayBuffer(s),n=new Uint8Array(r),i=new DataView(r);n.set(new Uint8Array(this.#e,0,this.#r)),this.#e=r,this.#t=n,this.#s=i}#n(e){this.#i(5),e=0|e;do{let s=e&127;e>>>=7,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#a(e){this.#i(10),e=e&0xffffffffffffffffn;do{let s=Number(e&0x7fn);e>>=7n,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#o(e,s){this.#n(e<<3|s)}bytes(e,s){this.#o(e,pt),this.#n(s.byteLength),this.#i(s.byteLength),this.#t.set(s,this.#r),this.#r+=s.byteLength}string(e,s){this.bytes(e,new TextEncoder().encode(s))}message(e,s,r){const n=new $t;r(n,s),this.bytes(e,n.data())}int32(e,s){this.#o(e,Ie),this.#n(s)}uint32(e,s){this.int32(e,s)}bool(e,s){this.int32(e,s?1:0)}sint64(e,s){this.#o(e,Ie),this.#a(s<<1n^s>>63n)}double(e,s){this.#o(e,ft),this.#i(8),this.#s.setFloat64(this.#r,s,!0),this.#r+=8}data(){return new Uint8Array(this.#e,0,this.#r)}}function vs(t,e){const s=new $t;return e(s,t),s.data()}class Ce{#e;#t;constructor(){this.#e=new Set,this.#t=new Set}alloc(){for(const s of this.#t)return this.#t.delete(s),this.#e.add(s),this.#e.has(this.#e.size-1)||this.#t.add(this.#e.size-1),s;const e=this.#e.size;return this.#e.add(e),e}free(e){if(!this.#e.delete(e))throw new ee("Freeing an id that is not allocated");this.#t.delete(this.#e.size),e<this.#e.size&&this.#t.add(e)}}function $(t,e){throw new ee(e)}function Te(t){if(t===null)return null;if(typeof t=="string")return t;if(typeof t=="number"){if(!Number.isFinite(t))throw new RangeError("Only finite numbers (not Infinity or NaN) can be passed as arguments");return t}else if(typeof t=="bigint"){if(t<Wr||t>Hr)throw new RangeError("This bigint value is too large to be represented as a 64-bit integer and passed as argument");return t}else{if(typeof t=="boolean")return t?1n:0n;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(t instanceof Uint8Array)return t;if(t instanceof Date)return+t.valueOf();if(typeof t=="object")return""+t.toString();throw new TypeError("Unsupported type of value")}}const Wr=-9223372036854775808n,Hr=9223372036854775807n;function Os(t,e){if(t===null)return null;if(typeof t=="number")return t;if(typeof t=="string")return t;if(typeof t=="bigint")if(e==="number"){const s=Number(t);if(!Number.isSafeInteger(s))throw new RangeError("Received integer which is too large to be safely represented as a JavaScript number");return s}else{if(e==="bigint")return t;if(e==="string")return""+t;throw new Se("Invalid value for IntMode")}else{if(t instanceof Uint8Array)return t.slice().buffer;throw t===void 0?new w("Received unrecognized type of Value"):$(t,"Impossible type of Value")}}function ve(t){return{affectedRowCount:t.affectedRowCount,lastInsertRowid:t.lastInsertRowid,columnNames:t.cols.map(e=>e.name),columnDecltypes:t.cols.map(e=>e.decltype)}}function Qs(t,e){const s=ve(t),r=t.rows.map(n=>Us(s.columnNames,n,e));return{...s,rows:r}}function Bs(t,e){const s=ve(t);let r;return t.rows.length>0&&(r=Us(s.columnNames,t.rows[0],e)),{...s,row:r}}function Ps(t,e){const s=ve(t);let r;return t.rows.length>0&&s.columnNames.length>0&&(r=Os(t.rows[0][0],e)),{...s,value:r}}function Us(t,e,s){const r={};Object.defineProperty(r,"length",{value:e.length});for(let n=0;n<e.length;++n){const i=Os(e[n],s);Object.defineProperty(r,n,{value:i});const o=t[n];o!==void 0&&!Object.hasOwn(r,o)&&Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0})}return r}function ye(t){return new Ls(t.message,t)}class Lt{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}_getSqlId(e){if(this.#e!==e)throw new Se("Attempted to use SQL text opened with other object");if(this.#s!==void 0)throw new z("SQL text is closed",this.#s);return this.#t}close(){this._setClosed(new T("SQL text was manually closed"))}_setClosed(e){this.#s===void 0&&(this.#s=e,this.#e._closeSql(this.#t))}get closed(){return this.#s!==void 0}}function mt(t,e){return e instanceof Lt?{sqlId:e._getSqlId(t)}:{sql:""+e}}class Ve{#e;#t;constructor(){this.#e=[],this.#t=[]}get length(){return this.#e.length+this.#t.length}push(e){this.#e.push(e)}shift(){return this.#t.length===0&&this.#e.length>0&&(this.#t=this.#e.reverse(),this.#e=[]),this.#t.pop()}first(){return this.#t.length!==0?this.#t[this.#t.length-1]:this.#e[0]}}let yt=class{sql;_args;_namedArgs;constructor(e){this.sql=e,this._args=[],this._namedArgs=new Map}bindIndexes(e){this._args.length=0;for(const s of e)this._args.push(Te(s));return this}bindIndex(e,s){if(e!==(e|0)||e<=0)throw new RangeError("Index of a positional argument must be positive integer");for(;this._args.length<e;)this._args.push(null);return this._args[e-1]=Te(s),this}bindName(e,s){return this._namedArgs.set(e,Te(s)),this}unbindAll(){return this._args.length=0,this._namedArgs.clear(),this}};function Ds(t,e,s){let r,n=[],i=[];if(e instanceof yt){r=e.sql,n=e._args;for(const[l,u]of e._namedArgs.entries())i.push({name:l,value:u})}else Array.isArray(e)?(r=e[0],Array.isArray(e[1])?n=e[1].map(l=>Te(l)):i=Object.entries(e[1]).map(([l,u])=>({name:l,value:Te(u)}))):r=e;const{sql:o,sqlId:a}=mt(t,r);return{sql:o,sqlId:a,args:n,namedArgs:i,wantRows:s}}let Gr=class{_stream;#e;_steps;#t;constructor(e,s){this._stream=e,this.#e=s,this._steps=[],this.#t=!1}step(){return new Xr(this)}execute(){if(this.#t)throw new Se("This batch has already been executed");this.#t=!0;const e={steps:this._steps.map(s=>s.proto)};return this.#e?Zr(this._stream,this._steps,e):Yr(this._stream,this._steps,e)}};function Yr(t,e,s){return t._batch(s).then(r=>{for(let n=0;n<e.length;++n){const i=r.stepResults.get(n),o=r.stepErrors.get(n);e[n].callback(i,o)}})}async function Zr(t,e,s){const r=await t._openCursor(s);try{let n=0,i,o=[];for(;;){const a=await r.next();if(a===void 0)break;if(a.type==="step_begin"){if(a.step<n||a.step>=e.length)throw new w("Server produced StepBeginEntry for unexpected step");if(i!==void 0)throw new w("Server produced StepBeginEntry before terminating previous step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0);n=a.step+1,i=a,o=[]}else if(a.type==="step_end"){if(i===void 0)throw new w("Server produced StepEndEntry but no step is active");const l={cols:i.cols,rows:o,affectedRowCount:a.affectedRowCount,lastInsertRowid:a.lastInsertRowid};e[i.step].callback(l,void 0),i=void 0,o=[]}else if(a.type==="step_error"){if(i===void 0){if(a.step>=e.length)throw new w("Server produced StepErrorEntry for unexpected step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0)}else{if(a.step!==i.step)throw new w("Server produced StepErrorEntry for unexpected step");i=void 0,o=[]}e[a.step].callback(void 0,a.error),n=a.step+1}else if(a.type==="row"){if(i===void 0)throw new w("Server produced RowEntry but no step is active");o.push(a.row)}else throw a.type==="error"?ye(a.error):a.type==="none"?new w("Server produced unrecognized CursorEntry"):$(a,"Impossible CursorEntry")}if(i!==void 0)throw new w("Server closed Cursor before terminating active step");for(let a=n;a<e.length;++a)e[a].callback(void 0,void 0)}finally{r.close()}}let Xr=class{_batch;#e;_index;constructor(e){this._batch=e,this.#e=[],this._index=void 0}condition(e){return this.#e.push(e._proto),this}query(e){return this.#t(e,!0,Qs)}queryRow(e){return this.#t(e,!0,Bs)}queryValue(e){return this.#t(e,!0,Ps)}run(e){return this.#t(e,!1,ve)}#t(e,s,r){if(this._index!==void 0)throw new Se("This BatchStep has already been added to the batch");const n=Ds(this._batch._stream._sqlOwner(),e,s);let i;this.#e.length===0?i=void 0:this.#e.length===1?i=this.#e[0]:i={type:"and",conds:this.#e.slice()};const o={stmt:n,condition:i};return new Promise((a,l)=>{const u=(h,p)=>{h!==void 0&&p!==void 0?l(new w("Server returned both result and error")):p!==void 0?l(ye(p)):a(h!==void 0?r(h,this._batch._stream.intMode):void 0)};this._index=this._batch._steps.length,this._batch._steps.push({proto:o,callback:u})})}},D=class se{_batch;_proto;constructor(e,s){this._batch=e,this._proto=s}static ok(e){return new se(e._batch,{type:"ok",step:Zt(e)})}static error(e){return new se(e._batch,{type:"error",step:Zt(e)})}static not(e){return new se(e._batch,{type:"not",cond:e._proto})}static and(e,s){for(const r of s)Xt(e,r);return new se(e,{type:"and",conds:s.map(r=>r._proto)})}static or(e,s){for(const r of s)Xt(e,r);return new se(e,{type:"or",conds:s.map(r=>r._proto)})}static isAutocommit(e){return e._stream.client()._ensureVersion(3,"BatchCond.isAutocommit()"),new se(e,{type:"is_autocommit"})}};function Zt(t){if(t._index===void 0)throw new Se("Cannot add a condition referencing a step that has not been added to the batch");return t._index}function Xt(t,e){if(e._batch!==t)throw new Se("Cannot mix BatchCond objects for different Batch objects")}function en(t){return{paramNames:t.params.map(e=>e.name),columns:t.cols,isExplain:t.isExplain,isReadonly:t.isReadonly}}class Ms{constructor(e){this.intMode=e}query(e){return this.#e(e,!0,Qs)}queryRow(e){return this.#e(e,!0,Bs)}queryValue(e){return this.#e(e,!0,Ps)}run(e){return this.#e(e,!1,ve)}#e(e,s,r){const n=Ds(this._sqlOwner(),e,s);return this._execute(n).then(i=>r(i,this.intMode))}batch(e=!1){return new Gr(this,e)}describe(e){const s=mt(this._sqlOwner(),e);return this._describe(s).then(en)}sequence(e){const s=mt(this._sqlOwner(),e);return this._sequence(s)}intMode}class js{}const tn=1e3,sn=10;class rn extends js{#e;#t;#s;#r;#i;#n;#a;constructor(e,s,r){super(),this.#e=e,this.#t=s,this.#s=r,this.#r=new Ve,this.#i=new Ve,this.#n=void 0,this.#a=!1}async next(){for(;;){if(this.#n!==void 0)throw new z("Cursor is closed",this.#n);for(;!this.#a&&this.#i.length<sn;)this.#i.push(this.#o());const e=this.#r.shift();if(this.#a||e!==void 0)return e;await this.#i.shift().then(s=>{if(s!==void 0){for(const r of s.entries)this.#r.push(r);this.#a||=s.done}})}}#o(){return this.#t._sendCursorRequest(this,{type:"fetch_cursor",cursorId:this.#s,maxCount:tn}).then(e=>e,e=>{this._setClosed(e)})}_setClosed(e){this.#n===void 0&&(this.#n=e,this.#t._sendCursorRequest(this,{type:"close_cursor",cursorId:this.#s}).catch(()=>{}),this.#t._cursorClosed(this))}close(){this._setClosed(new T("Cursor was manually closed"))}get closed(){return this.#n!==void 0}}class At extends Ms{#e;#t;#s;#r;#i;#n;static open(e){const s=e._streamIdAlloc.alloc(),r=new At(e,s),n=()=>{},i=a=>r.#u(a),o={type:"open_stream",streamId:s};return e._sendRequest(o,{responseCallback:n,errorCallback:i}),r}constructor(e,s){super(e.intMode),this.#e=e,this.#t=s,this.#s=new Ve,this.#r=void 0,this.#i=!1,this.#n=void 0}client(){return this.#e}_sqlOwner(){return this.#e}_execute(e){return this.#a({type:"execute",streamId:this.#t,stmt:e}).then(s=>s.result)}_batch(e){return this.#a({type:"batch",streamId:this.#t,batch:e}).then(s=>s.result)}_describe(e){return this.#e._ensureVersion(2,"describe()"),this.#a({type:"describe",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#e._ensureVersion(2,"sequence()"),this.#a({type:"sequence",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#a({type:"get_autocommit",streamId:this.#t}).then(e=>e.isAutocommit)}#a(e){return new Promise((s,r)=>{this.#o({type:"request",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return this.#e._ensureVersion(3,"cursor"),new Promise((s,r)=>{this.#o({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_sendCursorRequest(e,s){if(e!==this.#r)throw new ee("Cursor not associated with the stream attempted to execute a request");return new Promise((r,n)=>{this.#n!==void 0?n(new z("Stream is closed",this.#n)):this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})})}_cursorClosed(e){if(e!==this.#r)throw new ee("Cursor was closed, but it was not associated with the stream");this.#r=void 0,this.#l()}#o(e){this.#n!==void 0?e.errorCallback(new z("Stream is closed",this.#n)):this.#i?e.errorCallback(new z("Stream is closing",void 0)):(this.#s.push(e),this.#l())}#l(){for(;;){const e=this.#s.first();if(e===void 0&&this.#r===void 0&&this.#i){this.#u(new T("Stream was gracefully closed"));break}else if(e?.type==="request"&&this.#r===void 0){const{request:s,responseCallback:r,errorCallback:n}=e;this.#s.shift(),this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}else if(e?.type==="cursor"&&this.#r===void 0){const{batch:s,cursorCallback:r}=e;this.#s.shift();const n=this.#e._cursorIdAlloc.alloc(),i=new rn(this.#e,this,n),o={type:"open_cursor",streamId:this.#t,cursorId:n,batch:s},a=()=>{},l=u=>i._setClosed(u);this.#e._sendRequest(o,{responseCallback:a,errorCallback:l}),this.#r=i,r(i)}else break}}#u(e){if(this.#n!==void 0)return;for(this.#n=e,this.#r!==void 0&&this.#r._setClosed(e);;){const i=this.#s.shift();if(i!==void 0)i.errorCallback(e);else break}const s={type:"close_stream",streamId:this.#t},r=()=>this.#e._streamIdAlloc.free(this.#t),n=()=>{};this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}close(){this.#u(new T("Stream was manually closed"))}closeGracefully(){this.#i=!0,this.#l()}get closed(){return this.#n!==void 0||this.#i}}function Nt(t,e){e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId),t.arrayObjects("args",e.args,ks),t.arrayObjects("named_args",e.namedArgs,nn),t.boolean("want_rows",e.wantRows)}function nn(t,e){t.string("name",e.name),t.object("value",e.value,ks)}function ze(t,e){t.arrayObjects("steps",e.steps,on)}function on(t,e){e.condition!==void 0&&t.object("condition",e.condition,bt),t.object("stmt",e.stmt,Nt)}function bt(t,e){if(t.stringRaw("type",e.type),e.type==="ok"||e.type==="error")t.number("step",e.step);else if(e.type==="not")t.object("cond",e.cond,bt);else if(e.type==="and"||e.type==="or")t.arrayObjects("conds",e.conds,bt);else if(e.type!=="is_autocommit")throw $(e,"Impossible type of BatchCond")}function ks(t,e){if(e===null)t.stringRaw("type","null");else if(typeof e=="bigint")t.stringRaw("type","integer"),t.stringRaw("value",""+e);else if(typeof e=="number")t.stringRaw("type","float"),t.number("value",e);else if(typeof e=="string")t.stringRaw("type","text"),t.string("value",e);else if(e instanceof Uint8Array)t.stringRaw("type","blob"),t.stringRaw("base64",It.fromUint8Array(e));else if(e!==void 0)throw $(e,"Impossible type of Value")}function an(t,e){if(t.stringRaw("type",e.type),e.type==="hello")e.jwt!==void 0&&t.string("jwt",e.jwt);else if(e.type==="request")t.number("request_id",e.requestId),t.object("request",e.request,ln);else throw $(e,"Impossible type of ClientMsg")}function ln(t,e){if(t.stringRaw("type",e.type),e.type==="open_stream")t.number("stream_id",e.streamId);else if(e.type==="close_stream")t.number("stream_id",e.streamId);else if(e.type==="execute")t.number("stream_id",e.streamId),t.object("stmt",e.stmt,Nt);else if(e.type==="batch")t.number("stream_id",e.streamId),t.object("batch",e.batch,ze);else if(e.type==="open_cursor")t.number("stream_id",e.streamId),t.number("cursor_id",e.cursorId),t.object("batch",e.batch,ze);else if(e.type==="close_cursor")t.number("cursor_id",e.cursorId);else if(e.type==="fetch_cursor")t.number("cursor_id",e.cursorId),t.number("max_count",e.maxCount);else if(e.type==="sequence")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type==="get_autocommit")t.number("stream_id",e.streamId);else throw $(e,"Impossible type of Request")}function Et(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId);for(const s of e.args)t.message(3,s,Fs);for(const s of e.namedArgs)t.message(4,s,un);t.bool(5,e.wantRows)}function un(t,e){t.string(1,e.name),t.message(2,e.value,Fs)}function Ze(t,e){for(const s of e.steps)t.message(1,s,cn)}function cn(t,e){e.condition!==void 0&&t.message(1,e.condition,vt),t.message(2,e.stmt,Et)}function vt(t,e){if(e.type==="ok")t.uint32(1,e.step);else if(e.type==="error")t.uint32(2,e.step);else if(e.type==="not")t.message(3,e.cond,vt);else if(e.type==="and")t.message(4,e.conds,es);else if(e.type==="or")t.message(5,e.conds,es);else if(e.type==="is_autocommit")t.message(6,void 0,Vs);else throw $(e,"Impossible type of BatchCond")}function es(t,e){for(const s of e)t.message(1,s,vt)}function Fs(t,e){if(e===null)t.message(1,void 0,Vs);else if(typeof e=="bigint")t.sint64(2,e);else if(typeof e=="number")t.double(3,e);else if(typeof e=="string")t.string(4,e);else if(e instanceof Uint8Array)t.bytes(5,e);else if(e!==void 0)throw $(e,"Impossible type of Value")}function Vs(t,e){}function hn(t,e){if(e.type==="hello")t.message(1,e,dn);else if(e.type==="request")t.message(2,e,fn);else throw $(e,"Impossible type of ClientMsg")}function dn(t,e){e.jwt!==void 0&&t.string(1,e.jwt)}function fn(t,e){t.int32(1,e.requestId);const s=e.request;if(s.type==="open_stream")t.message(2,s,pn);else if(s.type==="close_stream")t.message(3,s,mn);else if(s.type==="execute")t.message(4,s,yn);else if(s.type==="batch")t.message(5,s,bn);else if(s.type==="open_cursor")t.message(6,s,wn);else if(s.type==="close_cursor")t.message(7,s,gn);else if(s.type==="fetch_cursor")t.message(8,s,Sn);else if(s.type==="sequence")t.message(9,s,_n);else if(s.type==="describe")t.message(10,s,qn);else if(s.type==="store_sql")t.message(11,s,Rn);else if(s.type==="close_sql")t.message(12,s,xn);else if(s.type==="get_autocommit")t.message(13,s,Cn);else throw $(s,"Impossible type of Request")}function pn(t,e){t.int32(1,e.streamId)}function mn(t,e){t.int32(1,e.streamId)}function yn(t,e){t.int32(1,e.streamId),t.message(2,e.stmt,Et)}function bn(t,e){t.int32(1,e.streamId),t.message(2,e.batch,Ze)}function wn(t,e){t.int32(1,e.streamId),t.int32(2,e.cursorId),t.message(3,e.batch,Ze)}function gn(t,e){t.int32(1,e.cursorId)}function Sn(t,e){t.int32(1,e.cursorId),t.uint32(2,e.maxCount)}function _n(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function qn(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function Rn(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function xn(t,e){t.int32(1,e.sqlId)}function Cn(t,e){t.int32(1,e.streamId)}function be(t){const e=J(t.message),s=W(t.code);return{message:e,code:s}}function Ot(t){const e=te(t.cols,zs),s=Fe(t.rows).map(o=>te(o,Hs)),r=ne(t.affected_row_count),n=W(t.last_insert_rowid),i=n!==void 0?BigInt(n):void 0;return{cols:e,rows:s,affectedRowCount:r,lastInsertRowid:i}}function zs(t){const e=W(t.name),s=W(t.decltype);return{name:e,decltype:s}}function Ks(t){const e=new Map;Fe(t.step_results).forEach((r,n)=>{r!==null&&e.set(n,Ot(P(r)))});const s=new Map;return Fe(t.step_errors).forEach((r,n)=>{r!==null&&s.set(n,be(P(r)))}),{stepResults:e,stepErrors:s}}function Js(t){const e=J(t.type);if(e==="step_begin"){const s=ne(t.step),r=te(t.cols,zs);return{type:"step_begin",step:s,cols:r}}else if(e==="step_end"){const s=ne(t.affected_row_count),r=W(t.last_insert_rowid),n=r!==void 0?BigInt(r):void 0;return{type:"step_end",affectedRowCount:s,lastInsertRowid:n}}else if(e==="step_error"){const s=ne(t.step),r=be(P(t.error));return{type:"step_error",step:s,error:r}}else{if(e==="row")return{type:"row",row:te(t.row,Hs)};if(e==="error")return{type:"error",error:be(P(t.error))};throw new w("Unexpected type of CursorEntry")}}function Ws(t){const e=te(t.params,In),s=te(t.cols,Tn),r=Ae(t.is_explain),n=Ae(t.is_readonly);return{params:e,cols:s,isExplain:r,isReadonly:n}}function In(t){return{name:W(t.name)}}function Tn(t){const e=J(t.name),s=W(t.decltype);return{name:e,decltype:s}}function Hs(t){const e=J(t.type);if(e==="null")return null;if(e==="integer"){const s=J(t.value);return BigInt(s)}else{if(e==="float")return ne(t.value);if(e==="text")return J(t.value);if(e==="blob")return It.toUint8Array(J(t.base64));throw new w("Unexpected type of Value")}}function $n(t){const e=J(t.type);if(e==="hello_ok")return{type:"hello_ok"};if(e==="hello_error")return{type:"hello_error",error:be(P(t.error))};if(e==="response_ok"){const s=ne(t.request_id),r=Ln(P(t.response));return{type:"response_ok",requestId:s,response:r}}else if(e==="response_error"){const s=ne(t.request_id),r=be(P(t.error));return{type:"response_error",requestId:s,error:r}}else throw new w("Unexpected type of ServerMsg")}function Ln(t){const e=J(t.type);if(e==="open_stream")return{type:"open_stream"};if(e==="close_stream")return{type:"close_stream"};if(e==="execute")return{type:"execute",result:Ot(P(t.result))};if(e==="batch")return{type:"batch",result:Ks(P(t.result))};if(e==="open_cursor")return{type:"open_cursor"};if(e==="close_cursor")return{type:"close_cursor"};if(e==="fetch_cursor"){const s=te(t.entries,Js),r=Ae(t.done);return{type:"fetch_cursor",entries:s,done:r}}else{if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:Ws(P(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Ae(t.is_autocommit)};throw new w("Unexpected type of Response")}}const H={default(){return{message:"",code:void 0}},1(t,e){e.message=t.string()},2(t,e){e.code=t.string()}},we={default(){return{cols:[],rows:[],affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.cols.push(t.message(Gs))},2(t,e){e.rows.push(t.message(Ys))},3(t,e){e.affectedRowCount=Number(t.uint64())},4(t,e){e.lastInsertRowid=t.sint64()}},Gs={default(){return{name:void 0,decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},Ys={default(){return[]},1(t,e){e.push(t.message(Pn))}},Ke={default(){return{stepResults:new Map,stepErrors:new Map}},1(t,e){const[s,r]=t.message(An);e.stepResults.set(s,r)},2(t,e){const[s,r]=t.message(Nn);e.stepErrors.set(s,r)}},An={default(){return[0,we.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(we)}},Nn={default(){return[0,H.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(H)}},Zs={default(){return{type:"none"}},1(t){return t.message(En)},2(t){return t.message(vn)},3(t){return t.message(On)},4(t){return{type:"row",row:t.message(Ys)}},5(t){return{type:"error",error:t.message(H)}}},En={default(){return{type:"step_begin",step:0,cols:[]}},1(t,e){e.step=t.uint32()},2(t,e){e.cols.push(t.message(Gs))}},vn={default(){return{type:"step_end",affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.affectedRowCount=t.uint32()},2(t,e){e.lastInsertRowid=t.uint64()}},On={default(){return{type:"step_error",step:0,error:H.default()}},1(t,e){e.step=t.uint32()},2(t,e){e.error=t.message(H)}},Je={default(){return{params:[],cols:[],isExplain:!1,isReadonly:!1}},1(t,e){e.params.push(t.message(Qn))},2(t,e){e.cols.push(t.message(Bn))},3(t,e){e.isExplain=t.bool()},4(t,e){e.isReadonly=t.bool()}},Qn={default(){return{name:void 0}},1(t,e){e.name=t.string()}},Bn={default(){return{name:"",decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},Pn={default(){},1(t){return null},2(t){return t.sint64()},3(t){return t.double()},4(t){return t.string()},5(t){return t.bytes()}},Un={default(){return{type:"none"}},1(t){return{type:"hello_ok"}},2(t){return t.message(Dn)},3(t){return t.message(jn)},4(t){return t.message(Mn)}},Dn={default(){return{type:"hello_error",error:H.default()}},1(t,e){e.error=t.message(H)}},Mn={default(){return{type:"response_error",requestId:0,error:H.default()}},1(t,e){e.requestId=t.int32()},2(t,e){e.error=t.message(H)}},jn={default(){return{type:"response_ok",requestId:0,response:{type:"none"}}},1(t,e){e.requestId=t.int32()},2(t,e){e.response={type:"open_stream"}},3(t,e){e.response={type:"close_stream"}},4(t,e){e.response=t.message(kn)},5(t,e){e.response=t.message(Fn)},6(t,e){e.response={type:"open_cursor"}},7(t,e){e.response={type:"close_cursor"}},8(t,e){e.response=t.message(Vn)},9(t,e){e.response={type:"sequence"}},10(t,e){e.response=t.message(zn)},11(t,e){e.response={type:"store_sql"}},12(t,e){e.response={type:"close_sql"}},13(t,e){e.response=t.message(Kn)}},kn={default(){return{type:"execute",result:we.default()}},1(t,e){e.result=t.message(we)}},Fn={default(){return{type:"batch",result:Ke.default()}},1(t,e){e.result=t.message(Ke)}},Vn={default(){return{type:"fetch_cursor",entries:[],done:!1}},1(t,e){e.entries.push(t.message(Zs))},2(t,e){e.done=t.bool()}},zn={default(){return{type:"describe",result:Je.default()}},1(t,e){e.result=t.message(Je)}},Kn={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},Jn=new Map([["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]),Xs=new Map([["hrana3-protobuf",{version:3,encoding:"protobuf"}],["hrana3",{version:3,encoding:"json"}],["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]);let Wn=class extends $s{#e;#t;#s;#r;#i;#n;#a;#o;#l;_streamIdAlloc;_cursorIdAlloc;#u;constructor(e,s){super(),this.#e=e,this.#t=[],this.#s=!1,this.#r=void 0,this.#i=!1,this.#n=void 0,this.#a=!1,this.#o=new Map,this.#l=new Ce,this._streamIdAlloc=new Ce,this._cursorIdAlloc=new Ce,this.#u=new Ce,this.#e.binaryType="arraybuffer",this.#e.addEventListener("open",()=>this.#p()),this.#e.addEventListener("close",r=>this.#f(r)),this.#e.addEventListener("error",r=>this.#m(r)),this.#e.addEventListener("message",r=>this.#b(r)),this.#h({type:"hello",jwt:s})}#h(e){if(this.#r!==void 0)throw new ee("Trying to send a message on a closed client");if(this.#s)this.#d(e);else{const s=()=>this.#d(e),r=()=>{};this.#t.push({openCallback:s,errorCallback:r})}}#p(){const e=this.#e.protocol;if(e===void 0){this.#c(new T("The `WebSocket.protocol` property is undefined. This most likely means that the WebSocket implementation provided by the environment is broken. If you are using Miniflare 2, please update to Miniflare 3, which fixes this problem."));return}else if(e==="")this.#n={version:1,encoding:"json"};else if(this.#n=Xs.get(e),this.#n===void 0){this.#c(new w(`Unrecognized WebSocket subprotocol: ${JSON.stringify(e)}`));return}for(const s of this.#t)s.openCallback();this.#t.length=0,this.#s=!0}#d(e){const s=this.#n.encoding;if(s==="json"){const r=Es(e,an);this.#e.send(r)}else if(s==="protobuf"){const r=vs(e,hn);this.#e.send(r)}else throw $(s,"Impossible encoding")}getVersion(){return new Promise((e,s)=>{if(this.#a=!0,this.#r!==void 0)s(this.#r);else if(this.#s)e(this.#n.version);else{const r=()=>e(this.#n.version);this.#t.push({openCallback:r,errorCallback:s})}})}_ensureVersion(e,s){if(this.#n===void 0||!this.#a)throw new me(`${s} is supported only on protocol version ${e} and higher, but the version supported by the WebSocket server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this.#n.version<e)throw new me(`${s} is supported on protocol version ${e} and higher, but the WebSocket server only supports version ${this.#n.version}`)}_sendRequest(e,s){if(this.#r!==void 0){s.errorCallback(new z("Client is closed",this.#r));return}const r=this.#l.alloc();this.#o.set(r,{...s,type:e.type}),this.#h({type:"request",requestId:r,request:e})}#m(e){const r=e.message??"WebSocket was closed due to an error";this.#c(new dt(r))}#f(e){let s=`WebSocket was closed with code ${e.code}`;e.reason&&(s+=`: ${e.reason}`),this.#c(new dt(s))}#c(e){if(this.#r===void 0){this.#r=e;for(const s of this.#t)s.errorCallback(e);this.#t.length=0;for(const[s,r]of this.#o.entries())r.errorCallback(e),this.#l.free(s);this.#o.clear(),this.#e.close()}}#b(e){if(this.#r===void 0)try{let s;const r=this.#n.encoding;if(r==="json"){if(typeof e.data!="string"){this.#e.close(3003,"Only text messages are accepted with JSON encoding"),this.#c(new w("Received non-text message from server with JSON encoding"));return}s=Tt(JSON.parse(e.data),$n)}else if(r==="protobuf"){if(!(e.data instanceof ArrayBuffer)){this.#e.close(3003,"Only binary messages are accepted with Protobuf encoding"),this.#c(new w("Received non-binary message from server with Protobuf encoding"));return}s=Ye(new Uint8Array(e.data),Un)}else throw $(r,"Impossible encoding");this.#y(s)}catch(s){this.#e.close(3007,"Could not handle message"),this.#c(s)}}#y(e){if(e.type==="none")throw new w("Received an unrecognized ServerMsg");if(e.type==="hello_ok"||e.type==="hello_error"){if(this.#i)throw new w("Received a duplicated hello response");if(this.#i=!0,e.type==="hello_error")throw ye(e.error);return}else if(!this.#i)throw new w("Received a non-hello message before a hello response");if(e.type==="response_ok"){const s=e.requestId,r=this.#o.get(s);if(this.#o.delete(s),r===void 0)throw new w("Received unexpected OK response");this.#l.free(s);try{if(r.type!==e.response.type)throw console.dir({responseState:r,msg:e}),new w("Received unexpected type of response");r.responseCallback(e.response)}catch(n){throw r.errorCallback(n),n}}else if(e.type==="response_error"){const s=e.requestId,r=this.#o.get(s);if(this.#o.delete(s),r===void 0)throw new w("Received unexpected error response");this.#l.free(s),r.errorCallback(ye(e.error))}else throw $(e,"Impossible ServerMsg type")}openStream(){return At.open(this)}storeSql(e){this._ensureVersion(2,"storeSql()");const s=this.#u.alloc(),r=new Lt(this,s),n=()=>{},i=a=>r._setClosed(a),o={type:"store_sql",sqlId:s,sql:e};return this._sendRequest(o,{responseCallback:n,errorCallback:i}),r}_closeSql(e){if(this.#r!==void 0)return;const s=()=>this.#u.free(e),r=i=>this.#c(i),n={type:"close_sql",sqlId:e};this._sendRequest(n,{responseCallback:s,errorCallback:r})}close(){this.#c(new T("Client was manually closed"))}get closed(){return this.#r!==void 0}};const Hn=fetch,er=Request,Gn=Headers;let he;if(typeof queueMicrotask<"u")he=queueMicrotask;else{const t=Promise.resolve();he=e=>{t.then(e)}}class Yn{#e;#t;#s;constructor(e){this.#e=new Uint8Array(new ArrayBuffer(e)),this.#t=0,this.#s=0}get length(){return this.#s-this.#t}data(){return this.#e.slice(this.#t,this.#s)}push(e){this.#r(e.byteLength),this.#e.set(e,this.#s),this.#s+=e.byteLength}#r(e){if(this.#s+e<=this.#e.byteLength)return;const s=this.#s-this.#t;if(s+e<=this.#e.byteLength&&2*this.#s>=this.#e.byteLength)this.#e.copyWithin(0,this.#t,this.#s);else{let r=this.#e.byteLength;do r*=2;while(s+e>r);const n=new Uint8Array(new ArrayBuffer(r));n.set(this.#e.slice(this.#t,this.#s),0),this.#e=n}this.#s=s,this.#t=0}shift(e){this.#t+=e}}function Zn(t){const e=W(t.baton),s=W(t.base_url),r=te(t.results,Xn);return{baton:e,baseUrl:s,results:r}}function Xn(t){const e=J(t.type);if(e==="ok")return{type:"ok",response:ei(P(t.response))};if(e==="error")return{type:"error",error:be(P(t.error))};throw new w("Unexpected type of StreamResult")}function ei(t){const e=J(t.type);if(e==="close")return{type:"close"};if(e==="execute")return{type:"execute",result:Ot(P(t.result))};if(e==="batch")return{type:"batch",result:Ks(P(t.result))};if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:Ws(P(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Ae(t.is_autocommit)};throw new w("Unexpected type of StreamResponse")}function ti(t){const e=W(t.baton),s=W(t.base_url);return{baton:e,baseUrl:s}}const si={default(){return{baton:void 0,baseUrl:void 0,results:[]}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()},3(t,e){e.results.push(t.message(ri))}},ri={default(){return{type:"none"}},1(t){return{type:"ok",response:t.message(ni)}},2(t){return{type:"error",error:t.message(H)}}},ni={default(){return{type:"none"}},1(t){return{type:"close"}},2(t){return t.message(ii)},3(t){return t.message(oi)},4(t){return{type:"sequence"}},5(t){return t.message(ai)},6(t){return{type:"store_sql"}},7(t){return{type:"close_sql"}},8(t){return t.message(li)}},ii={default(){return{type:"execute",result:we.default()}},1(t,e){e.result=t.message(we)}},oi={default(){return{type:"batch",result:Ke.default()}},1(t,e){e.result=t.message(Ke)}},ai={default(){return{type:"describe",result:Je.default()}},1(t,e){e.result=t.message(Je)}},li={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},ui={default(){return{baton:void 0,baseUrl:void 0}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()}};class ci extends js{#e;#t;#s;#r;#i;#n;constructor(e,s){super(),this.#e=e,this.#t=s,this.#s=void 0,this.#r=new Yn(16*1024),this.#i=void 0,this.#n=!1}async open(e){if(e.body===null)throw new w("No response body for cursor request");this.#s=e.body.getReader();const s=await this.#a(ti,ui);if(s===void 0)throw new w("Empty response to cursor request");return s}next(){return this.#a(Js,Zs)}close(){this._setClosed(new T("Cursor was manually closed"))}_setClosed(e){this.#i===void 0&&(this.#i=e,this.#e._cursorClosed(this),this.#s!==void 0&&this.#s.cancel())}get closed(){return this.#i!==void 0}async#a(e,s){for(;;){if(this.#n)return;if(this.#i!==void 0)throw new z("Cursor is closed",this.#i);if(this.#t==="json"){const i=this.#o();if(i!==void 0){const o=new TextDecoder().decode(i),a=JSON.parse(o);return Tt(a,e)}}else if(this.#t==="protobuf"){const i=this.#l();if(i!==void 0)return Ye(i,s)}else throw $(this.#t,"Impossible encoding");if(this.#s===void 0)throw new ee("Attempted to read from HTTP cursor before it was opened");const{value:r,done:n}=await this.#s.read();if(n&&this.#r.length===0)this.#n=!0;else{if(n)throw new w("Unexpected end of cursor stream");this.#r.push(r)}}}#o(){const e=this.#r.data(),r=e.indexOf(10);if(r<0)return;const n=e.slice(0,r);return this.#r.shift(r+1),n}#l(){const e=this.#r.data();let s=0,r=0;for(;;){if(r>=e.byteLength)return;const i=e[r];if(s|=(i&127)<<7*r,r+=1,!(i&128))break}if(e.byteLength<r+s)return;const n=e.slice(r,r+s);return this.#r.shift(r+s),n}}function hi(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.arrayObjects("requests",e.requests,di)}function di(t,e){if(t.stringRaw("type",e.type),e.type!=="close"){if(e.type==="execute")t.object("stmt",e.stmt,Nt);else if(e.type==="batch")t.object("batch",e.batch,ze);else if(e.type==="sequence")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type!=="get_autocommit")throw $(e,"Impossible type of StreamRequest")}}function fi(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.object("batch",e.batch,ze)}function pi(t,e){e.baton!==void 0&&t.string(1,e.baton);for(const s of e.requests)t.message(2,s,mi)}function mi(t,e){if(e.type==="close")t.message(1,e,yi);else if(e.type==="execute")t.message(2,e,bi);else if(e.type==="batch")t.message(3,e,wi);else if(e.type==="sequence")t.message(4,e,gi);else if(e.type==="describe")t.message(5,e,Si);else if(e.type==="store_sql")t.message(6,e,_i);else if(e.type==="close_sql")t.message(7,e,qi);else if(e.type==="get_autocommit")t.message(8,e,Ri);else throw $(e,"Impossible type of StreamRequest")}function yi(t,e){}function bi(t,e){t.message(1,e.stmt,Et)}function wi(t,e){t.message(1,e.batch,Ze)}function gi(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function Si(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function _i(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function qi(t,e){t.int32(1,e.sqlId)}function Ri(t,e){}function xi(t,e){e.baton!==void 0&&t.string(1,e.baton),t.message(2,e.batch,Ze)}class Ci extends Ms{#e;#t;#s;#r;#i;#n;#a;#o;#l;#u;#h;#p;constructor(e,s,r,n){super(e.intMode),this.#e=e,this.#t=s.toString(),this.#s=r,this.#r=n,this.#i=void 0,this.#n=new Ve,this.#a=!1,this.#l=!1,this.#u=!1,this.#h=void 0,this.#p=new Ce}client(){return this.#e}_sqlOwner(){return this}storeSql(e){const s=this.#p.alloc();return this.#d({type:"store_sql",sqlId:s,sql:e}).then(()=>{},r=>this._setClosed(r)),new Lt(this,s)}_closeSql(e){this.#h===void 0&&this.#d({type:"close_sql",sqlId:e}).then(()=>this.#p.free(e),s=>this._setClosed(s))}_execute(e){return this.#d({type:"execute",stmt:e}).then(s=>s.result)}_batch(e){return this.#d({type:"batch",batch:e}).then(s=>s.result)}_describe(e){return this.#d({type:"describe",sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#d({type:"sequence",sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#d({type:"get_autocommit"}).then(e=>e.isAutocommit)}#d(e){return new Promise((s,r)=>{this.#m({type:"pipeline",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return new Promise((s,r)=>{this.#m({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_cursorClosed(e){if(e!==this.#o)throw new ee("Cursor was closed, but it was not associated with the stream");this.#o=void 0,he(()=>this.#f())}close(){this._setClosed(new T("Stream was manually closed"))}closeGracefully(){this.#l=!0,he(()=>this.#f())}get closed(){return this.#h!==void 0||this.#l}_setClosed(e){if(this.#h===void 0){for(this.#h=e,this.#o!==void 0&&this.#o._setClosed(e),this.#e._streamClosed(this);;){const s=this.#n.shift();if(s!==void 0)s.errorCallback(e);else break}(this.#i!==void 0||this.#a)&&!this.#u&&(this.#n.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0,he(()=>this.#f()))}}#m(e){if(this.#h!==void 0)throw new z("Stream is closed",this.#h);if(this.#l)throw new z("Stream is closing",void 0);this.#n.push(e),he(()=>this.#f())}#f(){if(this.#a||this.#o!==void 0)return;if(this.#l&&this.#n.length===0){this._setClosed(new T("Stream was gracefully closed"));return}const e=this.#e._endpoint;if(e===void 0){this.#e._endpointPromise.then(()=>this.#f(),r=>this._setClosed(r));return}const s=this.#n.shift();if(s!==void 0)if(s.type==="pipeline"){const r=[s];for(;;){const n=this.#n.first();if(n!==void 0&&n.type==="pipeline")r.push(n),this.#n.shift();else if(n===void 0&&this.#l&&!this.#u){r.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0;break}else break}this.#c(e,r)}else if(s.type==="cursor")this.#b(e,s);else throw $(s,"Impossible type of QueueEntry")}#c(e,s){this.#y(()=>this.#g(s,e),r=>Ti(r,e.encoding),r=>r.baton,r=>r.baseUrl,r=>Ii(s,r),r=>s.forEach(n=>n.errorCallback(r)))}#b(e,s){const r=new ci(this,e.encoding);this.#o=r,this.#y(()=>this.#S(s,e),n=>r.open(n),n=>n.baton,n=>n.baseUrl,n=>s.cursorCallback(r),n=>s.errorCallback(n))}#y(e,s,r,n,i,o){let a;try{const l=e(),u=this.#r;a=u(l)}catch(l){a=Promise.reject(l)}this.#a=!0,a.then(l=>l.ok?s(l):$i(l).then(u=>{throw u})).then(l=>{this.#i=r(l),this.#t=n(l)??this.#t,i(l)}).catch(l=>{this._setClosed(l),o(l)}).finally(()=>{this.#a=!1,this.#f()})}#g(e,s){return this.#w(new URL(s.pipelinePath,this.#t),{baton:this.#i,requests:e.map(r=>r.request)},s.encoding,hi,pi)}#S(e,s){if(s.cursorPath===void 0)throw new me(`Cursors are supported only on protocol version 3 and higher, but the HTTP server only supports version ${s.version}.`);return this.#w(new URL(s.cursorPath,this.#t),{baton:this.#i,batch:e.batch},s.encoding,fi,xi)}#w(e,s,r,n,i){let o,a;if(r==="json")o=Es(s,n),a="application/json";else if(r==="protobuf")o=vs(s,i),a="application/x-protobuf";else throw $(r,"Impossible encoding");const l=new Gn;return l.set("content-type",a),this.#s!==void 0&&l.set("authorization",`Bearer ${this.#s}`),new er(e.toString(),{method:"POST",headers:l,body:o})}}function Ii(t,e){if(e.results.length!==t.length)throw new w("Server returned unexpected number of pipeline results");for(let s=0;s<t.length;++s){const r=e.results[s],n=t[s];if(r.type==="ok"){if(r.response.type!==n.request.type)throw new w("Received unexpected type of response");n.responseCallback(r.response)}else if(r.type==="error")n.errorCallback(ye(r.error));else throw r.type==="none"?new w("Received unrecognized type of StreamResult"):$(r,"Received impossible type of StreamResult")}}async function Ti(t,e){if(e==="json"){const s=await t.json();return Tt(s,Zn)}else if(e==="protobuf"){const s=await t.arrayBuffer();return Ye(new Uint8Array(s),si)}else throw $(e,"Impossible encoding")}async function $i(t){const e=t.headers.get("content-type")??"text/plain";if(e==="application/json"){const r=await t.json();if("message"in r)return ye(r)}let s=`Server returned HTTP status ${t.status}`;if(e==="text/plain"){const r=(await t.text()).trim();r!==""&&(s+=`: ${r}`)}return new Ns(s,t.status)}const Li=[{versionPath:"v3-protobuf",pipelinePath:"v3-protobuf/pipeline",cursorPath:"v3-protobuf/cursor",version:3,encoding:"protobuf"}],wt={versionPath:"v2",pipelinePath:"v2/pipeline",cursorPath:void 0,version:2,encoding:"json"};let Ai=class extends $s{#e;#t;#s;#r;#i;_endpointPromise;_endpoint;constructor(e,s,r,n=2){super(),this.#e=e,this.#t=s,this.#s=r??Hn,this.#r=void 0,this.#i=new Set,n==3?(this._endpointPromise=Ni(this.#s,this.#e),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i))):(this._endpointPromise=Promise.resolve(wt),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i)))}async getVersion(){return this._endpoint!==void 0?this._endpoint.version:(await this._endpointPromise).version}_ensureVersion(e,s){if(!(e<=wt.version)){if(this._endpoint===void 0)throw new me(`${s} is supported only on protocol version ${e} and higher, but the version supported by the HTTP server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this._endpoint.version<e)throw new me(`${s} is supported only on protocol version ${e} and higher, but the HTTP server only supports version ${this._endpoint.version}.`)}}openStream(){if(this.#r!==void 0)throw new z("Client is closed",this.#r);const e=new Ci(this,this.#e,this.#t,this.#s);return this.#i.add(e),e}_streamClosed(e){this.#i.delete(e)}close(){this.#n(new T("Client was manually closed"))}get closed(){return this.#r!==void 0}#n(e){if(this.#r===void 0){this.#r=e;for(const s of Array.from(this.#i))s._setClosed(new z("Client was closed",e))}}};async function Ni(t,e){const s=t;for(const r of Li){const n=new URL(r.versionPath,e),i=new er(n.toString(),{method:"GET"}),o=await s(i);if(await o.arrayBuffer(),o.ok)return r}return wt}function tr(t,e,s=2){if(typeof ce>"u")throw new As("WebSockets are not supported in this environment");var r=void 0;s==3?r=Array.from(Xs.keys()):r=Array.from(Jn.keys());const n=new ce(t,r);return new Wn(n,e)}function Ei(t,e,s,r=2){return new Ai(t instanceof URL?t:new URL(t),e,s,r)}class sr{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}execute(e){return this.batch([e]).then(s=>s[0])}async batch(e){const s=this._getStream();if(s.closed)throw new q("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{const r=e.map(Ne);let n;if(this.#s===void 0){this._getSqlCache().apply(r);const o=s.batch(this.#t>=3),a=o.step(),l=a.run(ht(this.#e));let u=a;n=r.map(h=>{const p=o.step().condition(D.ok(u));this.#t>=3&&p.condition(D.not(D.isAutocommit(o)));const b=p.query(h);return b.catch(()=>{}),u=p,b}),this.#s=o.execute().then(()=>l).then(()=>{});try{await this.#s}catch(h){throw this.close(),h}}else{this.#t<3&&await this.#s,this._getSqlCache().apply(r);const o=s.batch(this.#t>=3);let a;n=r.map(l=>{const u=o.step();a!==void 0&&u.condition(D.ok(a)),this.#t>=3&&u.condition(D.not(D.isAutocommit(o)));const h=u.query(l);return h.catch(()=>{}),a=u,h}),await o.execute()}const i=[];for(const o of n){const a=await o;if(a===void 0)throw new q("Statement in a transaction was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");i.push(Xe(a))}return i}catch(r){throw v(r)}}async executeMultiple(e){const s=this._getStream();if(s.closed)throw new q("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{if(this.#s===void 0){this.#s=s.run(ht(this.#e)).then(()=>{});try{await this.#s}catch(r){throw this.close(),r}}else await this.#s;await s.sequence(e)}catch(r){throw v(r)}}async rollback(){try{const e=this._getStream();if(e.closed||this.#s===void 0)return;const s=e.run("ROLLBACK").catch(r=>{throw v(r)});e.closeGracefully(),await s}catch(e){throw v(e)}finally{this.close()}}async commit(){try{const e=this._getStream();if(e.closed)throw new q("Cannot commit the transaction because it is already closed","TRANSACTION_CLOSED");if(this.#s!==void 0)await this.#s;else return;const s=e.run("COMMIT").catch(r=>{throw v(r)});e.closeGracefully(),await s}catch(e){throw v(e)}finally{this.close()}}}async function rr(t,e,s,r){const n=s.step(),i=n.run(ht(t));let o=n;const a=r.map(b=>{const S=s.step().condition(D.ok(o));e>=3&&S.condition(D.not(D.isAutocommit(s)));const x=S.query(b);return o=S,x}),l=s.step().condition(D.ok(o));e>=3&&l.condition(D.not(D.isAutocommit(s)));const u=l.run("COMMIT");s.step().condition(D.not(D.ok(l))).run("ROLLBACK").catch(b=>{}),await s.execute();const p=[];await i;for(const b of a){const S=await b;if(S===void 0)throw new q("Statement in a batch was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");p.push(Xe(S))}return await u,p}function Ne(t){if(typeof t=="string")return new yt(t);const e=new yt(t.sql);if(Array.isArray(t.args))e.bindIndexes(t.args);else for(const[s,r]of Object.entries(t.args))e.bindName(s,r);return e}function Xe(t){const e=t.columnNames.map(o=>o??""),s=t.columnDecltypes.map(o=>o??""),r=t.rows,n=t.affectedRowCount,i=t.lastInsertRowid!==void 0?t.lastInsertRowid:void 0;return new Mr(e,s,r,n,i)}function v(t){if(t instanceof T){const e=nr(t);return new q(t.message,e,void 0,t)}return t}function nr(t){return t instanceof Ls&&t.code!==void 0?t.code:t instanceof w?"HRANA_PROTO_ERROR":t instanceof z?t.cause instanceof T?nr(t.cause):"HRANA_CLOSED_ERROR":t instanceof dt?"HRANA_WEBSOCKET_ERROR":t instanceof Ns?"SERVER_ERROR":t instanceof me?"PROTOCOL_VERSION_ERROR":t instanceof ee?"INTERNAL_ERROR":"UNKNOWN"}class Qt{#e;#t;capacity;constructor(e,s){this.#e=e,this.#t=new vi,this.capacity=s}apply(e){if(this.capacity<=0)return;const s=new Set;for(const r of e){if(typeof r.sql!="string")continue;const n=r.sql;if(n.length>=5e3)continue;let i=this.#t.get(n);if(i===void 0){for(;this.#t.size+1>this.capacity;){const[o,a]=this.#t.peekLru();if(s.has(a))break;a.close(),this.#t.delete(o)}this.#t.size+1<=this.capacity&&(i=this.#e.storeSql(n),this.#t.set(n,i))}i!==void 0&&(r.sql=i,s.add(i))}}}class vi{#e;constructor(){this.#e=new Map}get(e){const s=this.#e.get(e);return s!==void 0&&(this.#e.delete(e),this.#e.set(e,s)),s}set(e,s){this.#e.set(e,s)}peekLru(){for(const e of this.#e.entries())return e}delete(e){this.#e.delete(e)}get size(){return this.#e.size}}const Oi=1e3,Qi=30;async function Bi(t){return new Promise(e=>{setTimeout(e,t)})}async function Pi({authToken:t,baseUrl:e,jobId:s}){const r=Bt(e+`/v1/jobs/${s}`),n=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}}),o=await n.json();if(n.status!==200)throw new Error(`Unexpected status code while fetching job status for migration with id ${s}: ${n.status}`);if(o.status=="RunFailure")throw new Error("Migration job failed");return o.status=="RunSuccess"}function Bt(t){return t.startsWith("ws://")?t.replace("ws://","http://"):t.startsWith("wss://")?t.replace("wss://","https://"):t}async function ir({authToken:t,baseUrl:e}){try{if(e.startsWith("http://127.0.0.1"))return!1;const s=Bt(e+"/v1/jobs"),r=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(r.status===404||r.status===500)return!1;const n=await r.json();return!(r.status===400&&n.error==="Invalid namespace")}catch(s){throw console.error(["There has been an error while retrieving the database type.","Debug information:",`- URL: ${e}`,"- Response Status Code: N/A"].join(`
`)),s}}async function Ui({authToken:t,baseUrl:e}){const s=Bt(e+"/v1/jobs"),r=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(r.status!==200)throw new Error("Unexpected status code while fetching migration jobs: "+r.status);const n=await r.json();if(!n.migrations||n.migrations.length===0)throw new Error("No migrations found");const i=n.migrations||[];let o;for(const a of i)a.job_id>(o?.job_id||0)&&(o=a);if(!o)throw new Error("No migration job found");if(o?.status==="RunFailure")throw new Error("Last migration job failed");return o}async function We({authToken:t,baseUrl:e}){const s=await Ui({authToken:t,baseUrl:e});if(s.status!=="RunSuccess"){let r=0;for(;r<Qi&&(r++,!await Pi({authToken:t,baseUrl:e,jobId:s.job_id}));)await Bi(Oi)}}function Di(t){var e=0,s=[];function r(){e--,e<t&&n()}function n(){var l=s.shift();a.queue=s.length,l&&o(l.fn).then(l.resolve).catch(l.reject)}function i(l){return new Promise(function(u,h){s.push({fn:l,resolve:u,reject:h}),a.queue=s.length})}function o(l){e++;try{return Promise.resolve(l()).then(function(u){return r(),u},function(u){throw r(),u})}catch(u){return r(),Promise.reject(u)}}var a=function(l){return e>=t?i(l):o(l)};return a}function Mi(t,e){var s=!1,r=this;return Promise.all(t.map(function(){var n=arguments;return r(function(){if(!s)return e.apply(void 0,n).catch(function(i){throw s=!0,i})})}))}function ts(t){return t.queue=0,t.map=Mi,t}var ji=function(t){return ts(t?Di(t):function(e){return e()})};const or=_r(ji);function ki(t){if(t.scheme!=="wss"&&t.scheme!=="ws")throw new q(`The WebSocket client supports only "libsql:", "wss:" and "ws:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${Le}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new q("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="ws"&&t.tls)throw new q('A "ws:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="wss"&&!t.tls)throw new q('A "wss:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=lt(t.scheme,t.authority,t.path);let s;try{s=tr(e,t.authToken)}catch(r){if(r instanceof As){const n=t.scheme==="wss"?"https":"http",i=lt(n,t.authority,t.path);throw new q(`This environment does not support WebSockets, please switch to the HTTP client by using a "${n}:" URL (${JSON.stringify(i)}). For more information, please read ${Le}`,"WEBSOCKETS_NOT_SUPPORTED")}throw v(r)}return new zi(s,e,t.authToken,t.intMode,t.concurrency)}const Fi=60*1e3,Vi=100;class zi{#e;#t;#s;#r;#i;closed;protocol;#n;#a;constructor(e,s,r,n,i){this.#e=s,this.#t=r,this.#s=n,this.#r=this.#l(e),this.#i=void 0,this.closed=!1,this.protocol="ws",this.#a=or(i)}getIsSchemaDatabase(){return this.#n===void 0&&(this.#n=ir({authToken:this.#t,baseUrl:this.#e.origin})),this.#n}async limit(e){return this.#a(e)}async execute(e){return this.limit(async()=>{const s=await this.#o();try{const r=this.getIsSchemaDatabase(),n=Ne(e);s.conn.sqlCache.apply([n]);const i=s.stream.query(n);s.stream.closeGracefully();const o=await i;return await r&&await We({authToken:this.#t,baseUrl:this.#e.origin}),Xe(o)}catch(r){throw v(r)}finally{this._closeStream(s)}})}async batch(e,s="deferred"){return this.limit(async()=>{const r=await this.#o();try{const n=this.getIsSchemaDatabase(),i=e.map(Ne),o=await r.conn.client.getVersion();r.conn.sqlCache.apply(i);const a=r.stream.batch(o>=3),u=await rr(s,o,a,i);return await n&&await We({authToken:this.#t,baseUrl:this.#e.origin}),u}catch(n){throw v(n)}finally{this._closeStream(r)}})}async transaction(e="write"){return this.limit(async()=>{const s=await this.#o();try{const r=await s.conn.client.getVersion();return new Ki(this,s,e,r)}catch(r){throw this._closeStream(s),v(r)}})}async executeMultiple(e){return this.limit(async()=>{const s=await this.#o();try{const r=s.stream.sequence(e);s.stream.closeGracefully(),await r}catch(r){throw v(r)}finally{this._closeStream(s)}})}sync(){return Promise.resolve()}async#o(){if(this.closed)throw new q("The client is closed","CLIENT_CLOSED");if(new Date().valueOf()-this.#r.openTime.valueOf()>Fi&&this.#i===void 0){const n=this.#l();this.#i=n,n.client.getVersion().then(i=>{this.#r!==n&&this.#r.streamStates.size===0&&this.#r.client.close(),this.#r=n,this.#i=void 0},i=>{this.#i=void 0})}if(this.#r.client.closed)try{this.#i!==void 0?this.#r=this.#i:this.#r=this.#l()}catch(n){throw v(n)}const r=this.#r;try{r.useSqlCache===void 0&&(r.useSqlCache=await r.client.getVersion()>=2,r.useSqlCache&&(r.sqlCache.capacity=Vi));const n=r.client.openStream();n.intMode=this.#s;const i={conn:r,stream:n};return r.streamStates.add(i),i}catch(n){throw v(n)}}#l(e){try{return e??=tr(this.#e,this.#t),{client:e,useSqlCache:void 0,sqlCache:new Qt(e,0),openTime:new Date,streamStates:new Set}}catch(s){throw v(s)}}_closeStream(e){e.stream.close();const s=e.conn;s.streamStates.delete(e),s.streamStates.size===0&&s!==this.#r&&s.client.close()}close(){this.#r.client.close(),this.closed=!0}}class Ki extends sr{#e;#t;constructor(e,s,r,n){super(r,n),this.#e=e,this.#t=s}_getStream(){return this.#t.stream}_getSqlCache(){return this.#t.conn.sqlCache}close(){this.#e._closeStream(this.#t)}get closed(){return this.#t.stream.closed}}function Ji(t){if(t.scheme!=="https"&&t.scheme!=="http")throw new q(`The HTTP client supports only "libsql:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${Le}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new q("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="http"&&t.tls)throw new q('A "http:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="https"&&!t.tls)throw new q('A "https:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=lt(t.scheme,t.authority,t.path);return new Wi(e,t.authToken,t.intMode,t.fetch,t.concurrency)}const ar=30;class Wi{#e;protocol;#t;#s;#r;#i;constructor(e,s,r,n,i){this.#e=Ei(e,s,n),this.#e.intMode=r,this.protocol="http",this.#t=e,this.#s=s,this.#i=or(i)}getIsSchemaDatabase(){return this.#r===void 0&&(this.#r=ir({authToken:this.#s,baseUrl:this.#t.origin})),this.#r}async limit(e){return this.#i(e)}async execute(e){return this.limit(async()=>{try{const s=this.getIsSchemaDatabase(),r=Ne(e);let n;const i=this.#e.openStream();try{n=i.query(r)}finally{i.closeGracefully()}const o=await n;return await s&&await We({authToken:this.#s,baseUrl:this.#t.origin}),Xe(o)}catch(s){throw v(s)}})}async batch(e,s="deferred"){return this.limit(async()=>{try{const r=this.getIsSchemaDatabase(),n=e.map(Ne),i=await this.#e.getVersion();let o;const a=this.#e.openStream();try{new Qt(a,ar).apply(n);const p=a.batch(!1);o=rr(s,i,p,n)}finally{a.closeGracefully()}const l=await o;return await r&&await We({authToken:this.#s,baseUrl:this.#t.origin}),l}catch(r){throw v(r)}})}async transaction(e="write"){return this.limit(async()=>{try{const s=await this.#e.getVersion();return new Hi(this.#e.openStream(),e,s)}catch(s){throw v(s)}})}async executeMultiple(e){return this.limit(async()=>{try{let s;const r=this.#e.openStream();try{s=r.sequence(e)}finally{r.closeGracefully()}await s}catch(s){throw v(s)}})}sync(){throw new q("sync not supported in http mode","SYNC_NOT_SUPPORTED")}close(){this.#e.close()}get closed(){return this.#e.closed}}class Hi extends sr{#e;#t;constructor(e,s,r){super(s,r),this.#e=e,this.#t=new Qt(e,ar)}_getStream(){return this.#e}_getSqlCache(){return this.#t}close(){this.#e.close()}get closed(){return this.#e.closed}}function Ia(t){return Gi(Fr(t))}function Gi(t){if(t.scheme==="ws"||t.scheme==="wss")return ki(t);if(t.scheme==="http"||t.scheme==="https")return Ji(t);throw new q(`The client that uses Web standard APIs supports only "libsql:", "wss:", "ws:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${Le}`,"URL_SCHEME_NOT_SUPPORTED")}const f=Symbol.for("drizzle:entityKind");function d(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,f))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let s=t.constructor;if(s)for(;s;){if(f in s&&s[f]===e[f])return!0;s=Object.getPrototypeOf(s)}return!1}class Yi{static[f]="ConsoleLogWriter";write(e){console.log(e)}}class Zi{static[f]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new Yi}logQuery(e,s){const r=s.map(i=>{try{return JSON.stringify(i)}catch{return String(i)}}),n=r.length?` -- params: [${r.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}}class Xi{static[f]="NoopLogger";logQuery(){}}const $e=Symbol.for("drizzle:Name"),ke=Symbol.for("drizzle:Schema"),ss=Symbol.for("drizzle:Columns"),rs=Symbol.for("drizzle:ExtraConfigColumns"),it=Symbol.for("drizzle:OriginalName"),ot=Symbol.for("drizzle:BaseName"),ns=Symbol.for("drizzle:IsAlias"),is=Symbol.for("drizzle:ExtraConfigBuilder");class y{static[f]="Table";static Symbol={Name:$e,Schema:ke,OriginalName:it,Columns:ss,ExtraConfigColumns:rs,BaseName:ot,IsAlias:ns,ExtraConfigBuilder:is};[$e];[it];[ke];[ss];[rs];[ot];[ns]=!1;[is]=void 0;constructor(e,s,r){this[$e]=this[it]=e,this[ke]=s,this[ot]=r}}function de(t){return t[$e]}function Ee(t){return`${t[ke]??"public"}.${t[$e]}`}class O{constructor(e,s){this.table=e,this.config=s,this.name=s.name,this.notNull=s.notNull,this.default=s.default,this.defaultFn=s.defaultFn,this.onUpdateFn=s.onUpdateFn,this.hasDefault=s.hasDefault,this.primary=s.primaryKey,this.isUnique=s.isUnique,this.uniqueName=s.uniqueName,this.uniqueType=s.uniqueType,this.dataType=s.dataType,this.columnType=s.columnType}static[f]="Column";name;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}}const os=Symbol.for("drizzle:PgInlineForeignKeys");class eo extends y{static[f]="PgTable";static Symbol=Object.assign({},y.Symbol,{InlineForeignKeys:os});[os]=[];[y.Symbol.ExtraConfigBuilder]=void 0}class to{static[f]="PgPrimaryKeyBuilder";columns;name;constructor(e,s){this.columns=e,this.name=s}build(e){return new so(e,this.columns,this.name)}}class so{constructor(e,s,r){this.table=e,this.columns=s,this.name=r}static[f]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[eo.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}}class ro{static[f]="ColumnBuilder";config;constructor(e,s,r){this.config={name:e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:s,columnType:r}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}}const as=Symbol.for("drizzle:isPgEnum");function no(t){return!!t&&typeof t=="function"&&as in t&&t[as]===!0}class G{static[f]="Subquery";constructor(e,s,r,n=!1){this._={brand:"Subquery",sql:e,selectedFields:s,alias:r,isWith:n}}}class lr extends G{static[f]="WithSubquery"}const io={startActiveSpan(t,e){return e()}},M=Symbol.for("drizzle:ViewBaseConfig");function ur(t){return t!=null&&typeof t.getSQL=="function"}function oo(t){const e={sql:"",params:[]};for(const s of t)e.sql+=s.sql,e.params.push(...s.params),s.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...s.typings));return e}class B{static[f]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new m([this])}}class m{constructor(e){this.queryChunks=e}static[f]="SQL";decoder=cr;shouldInlineParams=!1;append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return io.startActiveSpan("drizzle.buildSQL",s=>{const r=this.buildQueryFromSourceParams(this.queryChunks,e);return s?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(e,s){const r=Object.assign({},s,{inlineParams:s.inlineParams||this.shouldInlineParams,paramStartIndex:s.paramStartIndex||{value:0}}),{escapeName:n,escapeParam:i,prepareTyping:o,inlineParams:a,paramStartIndex:l}=r;return oo(e.map(u=>{if(d(u,B))return{sql:u.value.join(""),params:[]};if(d(u,gt))return{sql:n(u.value),params:[]};if(u===void 0)return{sql:"",params:[]};if(Array.isArray(u)){const h=[new B("(")];for(const[p,b]of u.entries())h.push(b),p<u.length-1&&h.push(new B(", "));return h.push(new B(")")),this.buildQueryFromSourceParams(h,r)}if(d(u,m))return this.buildQueryFromSourceParams(u.queryChunks,{...r,inlineParams:a||u.shouldInlineParams});if(d(u,y)){const h=u[y.Symbol.Schema],p=u[y.Symbol.Name];return{sql:h===void 0?n(p):n(h)+"."+n(p),params:[]}}if(d(u,O))return s.invokeSource==="indexes"?{sql:n(u.name),params:[]}:{sql:n(u.table[y.Symbol.Name])+"."+n(u.name),params:[]};if(d(u,qe)){const h=u[M].schema,p=u[M].name;return{sql:h===void 0?n(p):n(h)+"."+n(p),params:[]}}if(d(u,ie)){const h=u.value===null?null:u.encoder.mapToDriverValue(u.value);if(d(h,m))return this.buildQueryFromSourceParams([h],r);if(a)return{sql:this.mapInlineParam(h,r),params:[]};let p;return o&&(p=[o(u.encoder)]),{sql:i(l.value++,h),params:[h],typings:p}}return d(u,et)?{sql:i(l.value++,u),params:[u],typings:["none"]}:d(u,m.Aliased)&&u.fieldAlias!==void 0?{sql:n(u.fieldAlias),params:[]}:d(u,G)?u._.isWith?{sql:n(u._.alias),params:[]}:this.buildQueryFromSourceParams([new B("("),u._.sql,new B(") "),new gt(u._.alias)],r):no(u)?u.schema?{sql:n(u.schema)+"."+n(u.enumName),params:[]}:{sql:n(u.enumName),params:[]}:ur(u)?u.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([u.getSQL()],r):this.buildQueryFromSourceParams([new B("("),u.getSQL(),new B(")")],r):a?{sql:this.mapInlineParam(u,r),params:[]}:{sql:i(l.value++,u),params:[u]}}))}mapInlineParam(e,{escapeString:s}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return s(e);if(typeof e=="object"){const r=e.toString();return s(r==="[object Object]"?JSON.stringify(e):r)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new m.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}}class gt{constructor(e){this.value=e}static[f]="Name";brand;getSQL(){return new m([this])}}function ao(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}const cr={mapFromDriverValue:t=>t},hr={mapToDriverValue:t=>t};({...cr,...hr});class ie{constructor(e,s=hr){this.value=e,this.encoder=s}static[f]="Param";brand;getSQL(){return new m([this])}}function c(t,...e){const s=[];(e.length>0||t.length>0&&t[0]!=="")&&s.push(new B(t[0]));for(const[r,n]of e.entries())s.push(n,new B(t[r+1]));return new m(s)}(t=>{function e(){return new m([])}t.empty=e;function s(l){return new m(l)}t.fromList=s;function r(l){return new m([new B(l)])}t.raw=r;function n(l,u){const h=[];for(const[p,b]of l.entries())p>0&&u!==void 0&&h.push(u),h.push(b);return new m(h)}t.join=n;function i(l){return new gt(l)}t.identifier=i;function o(l){return new et(l)}t.placeholder=o;function a(l,u){return new ie(l,u)}t.param=a})(c||(c={}));(t=>{class e{constructor(r,n){this.sql=r,this.fieldAlias=n}static[f]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(m||(m={}));class et{constructor(e){this.name=e}static[f]="Placeholder";getSQL(){return new m([this])}}function Ue(t,e){return t.map(s=>{if(d(s,et)){if(!(s.name in e))throw new Error(`No value for placeholder "${s.name}" was provided`);return e[s.name]}return s})}class qe{static[f]="View";[M];constructor({name:e,schema:s,selectedFields:r,query:n}){this[M]={name:e,originalName:e,schema:s,selectedFields:r,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new m([this])}}O.prototype.getSQL=function(){return new m([this])};y.prototype.getSQL=function(){return new m([this])};G.prototype.getSQL=function(){return new m([this])};function j(t,e){return ao(e)&&!ur(t)&&!d(t,ie)&&!d(t,et)&&!d(t,O)&&!d(t,y)&&!d(t,qe)?new ie(t,e):t}const dr=(t,e)=>c`${t} = ${j(e,t)}`,lo=(t,e)=>c`${t} <> ${j(e,t)}`;function St(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new m(e):new m([new B("("),c.join(e,new B(" and ")),new B(")")])}function uo(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new m(e):new m([new B("("),c.join(e,new B(" or ")),new B(")")])}function co(t){return c`not ${t}`}const ho=(t,e)=>c`${t} > ${j(e,t)}`,fo=(t,e)=>c`${t} >= ${j(e,t)}`,po=(t,e)=>c`${t} < ${j(e,t)}`,mo=(t,e)=>c`${t} <= ${j(e,t)}`;function yo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("inArray requires at least one value");return c`${t} in ${e.map(s=>j(s,t))}`}return c`${t} in ${j(e,t)}`}function bo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("notInArray requires at least one value");return c`${t} not in ${e.map(s=>j(s,t))}`}return c`${t} not in ${j(e,t)}`}function wo(t){return c`${t} is null`}function go(t){return c`${t} is not null`}function So(t){return c`exists ${t}`}function _o(t){return c`not exists ${t}`}function qo(t,e,s){return c`${t} between ${j(e,t)} and ${j(s,t)}`}function Ro(t,e,s){return c`${t} not between ${j(e,t)} and ${j(s,t)}`}function xo(t,e){return c`${t} like ${e}`}function Co(t,e){return c`${t} not like ${e}`}function Io(t,e){return c`${t} ilike ${e}`}function To(t,e){return c`${t} not ilike ${e}`}function $o(t){return c`${t} asc`}function Lo(t){return c`${t} desc`}class fr{constructor(e,s,r){this.sourceTable=e,this.referencedTable=s,this.relationName=r,this.referencedTableName=s[y.Symbol.Name]}static[f]="Relation";referencedTableName;fieldName}class Ao{constructor(e,s){this.table=e,this.config=s}static[f]="Relations"}class oe extends fr{constructor(e,s,r,n){super(e,s,r?.relationName),this.config=r,this.isNullable=n}static[f]="One";withFieldName(e){const s=new oe(this.sourceTable,this.referencedTable,this.config,this.isNullable);return s.fieldName=e,s}}class tt extends fr{constructor(e,s,r){super(e,s,r?.relationName),this.config=r}static[f]="Many";withFieldName(e){const s=new tt(this.sourceTable,this.referencedTable,this.config);return s.fieldName=e,s}}function No(){return{and:St,between:qo,eq:dr,exists:So,gt:ho,gte:fo,ilike:Io,inArray:yo,isNull:wo,isNotNull:go,like:xo,lt:po,lte:mo,ne:lo,not:co,notBetween:Ro,notExists:_o,notLike:Co,notIlike:To,notInArray:bo,or:uo,sql:c}}function Eo(){return{sql:c,asc:$o,desc:Lo}}function vo(t,e){Object.keys(t).length===1&&"default"in t&&!d(t.default,y)&&(t=t.default);const s={},r={},n={};for(const[i,o]of Object.entries(t))if(d(o,y)){const a=Ee(o),l=r[a];s[a]=i,n[i]={tsName:i,dbName:o[y.Symbol.Name],schema:o[y.Symbol.Schema],columns:o[y.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(const h of Object.values(o[y.Symbol.Columns]))h.primary&&n[i].primaryKey.push(h);const u=o[y.Symbol.ExtraConfigBuilder]?.(o[y.Symbol.ExtraConfigColumns]);if(u)for(const h of Object.values(u))d(h,to)&&n[i].primaryKey.push(...h.columns)}else if(d(o,Ao)){const a=Ee(o.table),l=s[a],u=o.config(e(o.table));let h;for(const[p,b]of Object.entries(u))if(l){const S=n[l];S.relations[p]=b}else a in r||(r[a]={relations:{},primaryKey:h}),r[a].relations[p]=b}return{tables:n,tableNamesMap:s}}function Oo(t){return function(s,r){return new oe(t,s,r,r?.fields.reduce((n,i)=>n&&i.notNull,!0)??!1)}}function Qo(t){return function(s,r){return new tt(t,s,r)}}function Bo(t,e,s){if(d(s,oe)&&s.config)return{fields:s.config.fields,references:s.config.references};const r=e[Ee(s.referencedTable)];if(!r)throw new Error(`Table "${s.referencedTable[y.Symbol.Name]}" not found in schema`);const n=t[r];if(!n)throw new Error(`Table "${r}" not found in schema`);const i=s.sourceTable,o=e[Ee(i)];if(!o)throw new Error(`Table "${i[y.Symbol.Name]}" not found in schema`);const a=[];for(const l of Object.values(n.relations))(s.relationName&&s!==l&&l.relationName===s.relationName||!s.relationName&&l.referencedTable===s.sourceTable)&&a.push(l);if(a.length>1)throw s.relationName?new Error(`There are multiple relations with name "${s.relationName}" in table "${r}"`):new Error(`There are multiple relations between "${r}" and "${s.sourceTable[y.Symbol.Name]}". Please specify relation name`);if(a[0]&&d(a[0],oe)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${s.fieldName}"`)}function Po(t){return{one:Oo(t),many:Qo(t)}}function _t(t,e,s,r,n=i=>i){const i={};for(const[o,a]of r.entries())if(a.isJson){const l=e.relations[a.tsKey],u=s[o],h=typeof u=="string"?JSON.parse(u):u;i[a.tsKey]=d(l,oe)?h&&_t(t,t[a.relationTableTsKey],h,a.selection,n):h.map(p=>_t(t,t[a.relationTableTsKey],p,a.selection,n))}else{const l=n(s[o]),u=a.field;let h;d(u,O)?h=u:d(u,m)?h=u.decoder:h=u.sql.decoder,i[a.tsKey]=l===null?null:h.mapFromDriverValue(l)}return i}class He{constructor(e){this.table=e}static[f]="ColumnAliasProxyHandler";get(e,s){return s==="table"?this.table:e[s]}}class Pt{constructor(e,s){this.alias=e,this.replaceOriginalName=s}static[f]="TableAliasProxyHandler";get(e,s){if(s===y.Symbol.IsAlias)return!0;if(s===y.Symbol.Name)return this.alias;if(this.replaceOriginalName&&s===y.Symbol.OriginalName)return this.alias;if(s===M)return{...e[M],name:this.alias,isAlias:!0};if(s===y.Symbol.Columns){const n=e[y.Symbol.Columns];if(!n)return n;const i={};return Object.keys(n).map(o=>{i[o]=new Proxy(n[o],new He(new Proxy(e,this)))}),i}const r=e[s];return d(r,O)?new Proxy(r,new He(new Proxy(e,this))):r}}function at(t,e){return new Proxy(t,new Pt(e,!1))}function Z(t,e){return new Proxy(t,new He(new Proxy(t.table,new Pt(e,!1))))}function pr(t,e){return new m.Aliased(Ge(t.sql,e),t.fieldAlias)}function Ge(t,e){return c.join(t.queryChunks.map(s=>d(s,O)?Z(s,e):d(s,m)?Ge(s,e):d(s,m.Aliased)?pr(s,e):s))}class K{static[f]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,s){if(s==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(s===M)return{...e[M],selectedFields:new Proxy(e[M].selectedFields,this)};if(typeof s=="symbol")return e[s];const n=(d(e,G)?e._.selectedFields:d(e,qe)?e[M].selectedFields:e)[s];if(d(n,m.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!n.isSelectionField)return n.sql;const i=n.clone();return i.isSelectionField=!0,i}if(d(n,m)){if(this.config.sqlBehavior==="sql")return n;throw new Error(`You tried to reference "${s}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return d(n,O)?this.config.alias?new Proxy(n,new He(new Proxy(n.table,new Pt(this.config.alias,this.config.replaceOriginalName??!1)))):n:typeof n!="object"||n===null?n:new Proxy(n,new K(this.config))}}class le{static[f]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(s=>(e?.(),s),s=>{throw e?.(),s})}then(e,s){return this.execute().then(e,s)}}const qt=Symbol.for("drizzle:SQLiteInlineForeignKeys");class V extends y{static[f]="SQLiteTable";static Symbol=Object.assign({},y.Symbol,{InlineForeignKeys:qt});[y.Symbol.Columns];[qt]=[];[y.Symbol.ExtraConfigBuilder]=void 0}function Uo(t,e,s,r,n=t){const i=new V(t,r,n),o=Object.fromEntries(Object.entries(e).map(([l,u])=>{const h=u,p=h.build(i);return i[qt].push(...h.buildForeignKeys(p,i)),[l,p]})),a=Object.assign(i,o);return a[y.Symbol.Columns]=o,a[y.Symbol.ExtraConfigColumns]=o,a}const Ta=(t,e,s)=>Uo(t,e);function ls(t,e,s){const r={},n=t.reduce((i,{path:o,field:a},l)=>{let u;d(a,O)?u=a:d(a,m)?u=a.decoder:u=a.sql.decoder;let h=i;for(const[p,b]of o.entries())if(p<o.length-1)b in h||(h[b]={}),h=h[b];else{const S=e[l],x=h[b]=S===null?null:u.mapFromDriverValue(S);if(s&&d(a,O)&&o.length===2){const I=o[0];I in r?typeof r[I]=="string"&&r[I]!==de(a.table)&&(r[I]=!1):r[I]=x===null?de(a.table):!1}}return i},{});if(s&&Object.keys(r).length>0)for(const[i,o]of Object.entries(r))typeof o=="string"&&!s[o]&&(n[i]=null);return n}function ae(t,e){return Object.entries(t).reduce((s,[r,n])=>{if(typeof r!="string")return s;const i=e?[...e,r]:[r];return d(n,O)||d(n,m)||d(n,m.Aliased)?s.push({path:i,field:n}):d(n,y)?s.push(...ae(n[y.Symbol.Columns],i)):s.push(...ae(n,i)),s},[])}function mr(t,e){const s=Object.keys(t),r=Object.keys(e);if(s.length!==r.length)return!1;for(const[n,i]of s.entries())if(i!==r[n])return!1;return!0}function yr(t,e){const s=Object.entries(e).filter(([,r])=>r!==void 0).map(([r,n])=>d(n,m)?[r,n]:[r,new ie(n,t[y.Symbol.Columns][r])]);if(s.length===0)throw new Error("No values to set");return Object.fromEntries(s)}function Do(t,e){for(const s of e)for(const r of Object.getOwnPropertyNames(s.prototype))r!=="constructor"&&Object.defineProperty(t.prototype,r,Object.getOwnPropertyDescriptor(s.prototype,r)||Object.create(null))}function Mo(t){return t[y.Symbol.Columns]}function us(t){return d(t,G)?t._.alias:d(t,qe)?t[M].name:d(t,m)?void 0:t[y.Symbol.IsAlias]?t[y.Symbol.Name]:t[y.Symbol.BaseName]}class cs extends le{constructor(e,s,r,n){super(),this.table=e,this.session=s,this.dialect=r,this.config={table:e,withList:n}}static[f]="SQLiteDelete";config;where(e){return this.config.where=e,this}returning(e=this.table[V.Symbol.Columns]){return this.config.returning=ae(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}}class hs{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[f]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");const s=e.map(r=>{const n={},i=this.table[y.Symbol.Columns];for(const o of Object.keys(r)){const a=r[o];n[o]=d(a,m)?a:new ie(a,i[o])}return n});return new jo(this.table,s,this.session,this.dialect,this.withList)}}class jo extends le{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={table:e,values:s,withList:i}}static[f]="SQLiteInsert";config;returning(e=this.config.table[V.Symbol.Columns]){return this.config.returning=ae(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=c`do nothing`;else{const s=Array.isArray(e.target)?c`${e.target}`:c`${[e.target]}`,r=e.where?c` where ${e.where}`:c``;this.config.onConflict=c`${s} do nothing${r}`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');const s=e.where?c` where ${e.where}`:void 0,r=e.targetWhere?c` where ${e.targetWhere}`:void 0,n=e.setWhere?c` where ${e.setWhere}`:void 0,i=Array.isArray(e.target)?c`${e.target}`:c`${[e.target]}`,o=this.dialect.buildUpdateSet(this.config.table,yr(this.config.table,e.set));return this.config.onConflict=c`${i}${r} do update set ${o}${s}${n}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class Ut extends Error{static[f]="DrizzleError";constructor({message:e,cause:s}){super(e),this.name="DrizzleError",this.cause=s}}class ko extends Ut{static[f]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class Fo{static[f]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,s){this.reference=()=>{const{name:r,columns:n,foreignColumns:i}=e();return{name:r,columns:n,foreignTable:i[0].table,foreignColumns:i}},s&&(this._onUpdate=s.onUpdate,this._onDelete=s.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new Vo(e,this)}}class Vo{constructor(e,s){this.table=e,this.reference=s.reference,this.onUpdate=s._onUpdate,this.onDelete=s._onDelete}static[f]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){const{name:e,columns:s,foreignColumns:r}=this.reference(),n=s.map(a=>a.name),i=r.map(a=>a.name),o=[this.table[V.Symbol.Name],...n,r[0].table[V.Symbol.Name],...i];return e??`${o.join("_")}_fk`}}function zo(t,e){return`${t[V.Symbol.Name]}_${e.join("_")}_unique`}class Dt extends ro{static[f]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,s={}){return this.foreignKeyConfigs.push({ref:e,actions:s}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}buildForeignKeys(e,s){return this.foreignKeyConfigs.map(({ref:r,actions:n})=>((i,o)=>{const a=new Fo(()=>{const l=i();return{columns:[e],foreignColumns:[l]}});return o.onUpdate&&a.onUpdate(o.onUpdate),o.onDelete&&a.onDelete(o.onDelete),a.build(s)})(r,n))}}class pe extends O{constructor(e,s){s.uniqueName||(s.uniqueName=zo(e,[s.name])),super(e,s),this.table=e}static[f]="SQLiteColumn"}class Mt extends Dt{static[f]="SQLiteBaseIntegerBuilder";constructor(e,s,r){super(e,s,r),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}}class jt extends pe{static[f]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}}class Ko extends Mt{static[f]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new Jo(e,this.config)}}class Jo extends jt{static[f]="SQLiteInteger"}class Wo extends Mt{static[f]="SQLiteTimestampBuilder";constructor(e,s){super(e,"date","SQLiteTimestamp"),this.config.mode=s}defaultNow(){return this.default(c`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new Ho(e,this.config)}}class Ho extends jt{static[f]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){const s=e.getTime();return this.config.mode==="timestamp"?Math.floor(s/1e3):s}}class Go extends Mt{static[f]="SQLiteBooleanBuilder";constructor(e,s){super(e,"boolean","SQLiteBoolean"),this.config.mode=s}build(e){return new Yo(e,this.config)}}class Yo extends jt{static[f]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}}function $a(t,e){return e?.mode==="timestamp"||e?.mode==="timestamp_ms"?new Wo(t,e.mode):e?.mode==="boolean"?new Go(t,e.mode):new Ko(t)}class Zo extends Dt{static[f]="SQLiteTextBuilder";constructor(e,s){super(e,"string","SQLiteText"),this.config.enumValues=s.enum,this.config.length=s.length}build(e){return new Xo(e,this.config)}}class Xo extends pe{static[f]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,s){super(e,s)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}}class ea extends Dt{static[f]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new ta(e,this.config)}}class ta extends pe{static[f]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}}function La(t,e={}){return e.mode==="json"?new ea(t):new Zo(t,e)}class br extends qe{static[f]="SQLiteViewBase"}class wr{static[f]="SQLiteDialect";escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;const s=[c`with `];for(const[r,n]of e.entries())s.push(c`${c.identifier(n._.alias)} as (${n._.sql})`),r<e.length-1&&s.push(c`, `);return s.push(c` `),c.join(s)}buildDeleteQuery({table:e,where:s,returning:r,withList:n}){const i=this.buildWithCTE(n),o=r?c` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,a=s?c` where ${s}`:void 0;return c`${i}delete from ${e}${a}${o}`}buildUpdateSet(e,s){const r=e[y.Symbol.Columns],n=Object.keys(r).filter(o=>s[o]!==void 0||r[o]?.onUpdateFn!==void 0),i=n.length;return c.join(n.flatMap((o,a)=>{const l=r[o],u=s[o]??c.param(l.onUpdateFn(),l),h=c`${c.identifier(l.name)} = ${u}`;return a<i-1?[h,c.raw(", ")]:[h]}))}buildUpdateQuery({table:e,set:s,where:r,returning:n,withList:i}){const o=this.buildWithCTE(i),a=this.buildUpdateSet(e,s),l=n?c` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,u=r?c` where ${r}`:void 0;return c`${o}update ${e} set ${a}${u}${l}`}buildSelection(e,{isSingleTable:s=!1}={}){const r=e.length,n=e.flatMap(({field:i},o)=>{const a=[];if(d(i,m.Aliased)&&i.isSelectionField)a.push(c.identifier(i.fieldAlias));else if(d(i,m.Aliased)||d(i,m)){const l=d(i,m.Aliased)?i.sql:i;s?a.push(new m(l.queryChunks.map(u=>d(u,O)?c.identifier(u.name):u))):a.push(l),d(i,m.Aliased)&&a.push(c` as ${c.identifier(i.fieldAlias)}`)}else if(d(i,O)){const l=i.table[y.Symbol.Name],u=i.name;s?a.push(c.identifier(u)):a.push(c`${c.identifier(l)}.${c.identifier(u)}`)}return o<r-1&&a.push(c`, `),a});return c.join(n)}buildSelectQuery({withList:e,fields:s,fieldsFlat:r,where:n,having:i,table:o,joins:a,orderBy:l,groupBy:u,limit:h,offset:p,distinct:b,setOperators:S}){const x=r??ae(s);for(const U of x)if(d(U.field,O)&&de(U.field.table)!==(d(o,G)?o._.alias:d(o,br)?o[M].name:d(o,m)?void 0:de(o))&&!(N=>a?.some(({alias:Y})=>Y===(N[y.Symbol.IsAlias]?de(N):N[y.Symbol.BaseName])))(U.field.table)){const N=de(U.field.table);throw new Error(`Your "${U.path.join("->")}" field references a column "${N}"."${U.field.name}", but the table "${N}" is not part of the query! Did you forget to join it?`)}const I=!a||a.length===0,L=this.buildWithCTE(e),A=b?c` distinct`:void 0,C=this.buildSelection(x,{isSingleTable:I}),E=d(o,y)&&o[y.Symbol.OriginalName]!==o[y.Symbol.Name]?c`${c.identifier(o[y.Symbol.OriginalName])} ${c.identifier(o[y.Symbol.Name])}`:o,R=[];if(a)for(const[U,N]of a.entries()){U===0&&R.push(c` `);const Y=N.table;if(d(Y,V)){const nt=Y[V.Symbol.Name],Vt=Y[V.Symbol.Schema],zt=Y[V.Symbol.OriginalName],Kt=nt===zt?void 0:N.alias;R.push(c`${c.raw(N.joinType)} join ${Vt?c`${c.identifier(Vt)}.`:void 0}${c.identifier(zt)}${Kt&&c` ${c.identifier(Kt)}`} on ${N.on}`)}else R.push(c`${c.raw(N.joinType)} join ${Y} on ${N.on}`);U<a.length-1&&R.push(c` `)}const k=c.join(R),ue=n?c` where ${n}`:void 0,g=i?c` having ${i}`:void 0,_=[];if(l)for(const[U,N]of l.entries())_.push(N),U<l.length-1&&_.push(c`, `);const F=[];if(u)for(const[U,N]of u.entries())F.push(N),U<u.length-1&&F.push(c`, `);const Oe=F.length>0?c` group by ${c.join(F)}`:void 0,rt=_.length>0?c` order by ${c.join(_)}`:void 0,Re=h?c` limit ${h}`:void 0,Qe=p?c` offset ${p}`:void 0,Be=c`${L}select${A} ${C} from ${E}${k}${ue}${Oe}${g}${rt}${Re}${Qe}`;return S.length>0?this.buildSetOperations(Be,S):Be}buildSetOperations(e,s){const[r,...n]=s;if(!r)throw new Error("Cannot pass undefined values to any set operator");return n.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:r}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:r}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:s,isAll:r,rightSelect:n,limit:i,orderBy:o,offset:a}}){const l=c`${e.getSQL()} `,u=c`${n.getSQL()}`;let h;if(o&&o.length>0){const x=[];for(const I of o)if(d(I,pe))x.push(c.identifier(I.name));else if(d(I,m)){for(let L=0;L<I.queryChunks.length;L++){const A=I.queryChunks[L];d(A,pe)&&(I.queryChunks[L]=c.identifier(A.name))}x.push(c`${I}`)}else x.push(c`${I}`);h=c` order by ${c.join(x,c`, `)}`}const p=i?c` limit ${i}`:void 0,b=c.raw(`${s} ${r?"all ":""}`),S=a?c` offset ${a}`:void 0;return c`${l}${b}${u}${h}${p}${S}`}buildInsertQuery({table:e,values:s,onConflict:r,returning:n,withList:i}){const o=[],a=e[y.Symbol.Columns],l=Object.entries(a),u=l.map(([,x])=>c.identifier(x.name));for(const[x,I]of s.entries()){const L=[];for(const[A,C]of l){const E=I[A];if(E===void 0||d(E,ie)&&E.value===void 0){let R;if(C.default!==null&&C.default!==void 0)R=d(C.default,m)?C.default:c.param(C.default,C);else if(C.defaultFn!==void 0){const k=C.defaultFn();R=d(k,m)?k:c.param(k,C)}else if(!C.default&&C.onUpdateFn!==void 0){const k=C.onUpdateFn();R=d(k,m)?k:c.param(k,C)}else R=c`null`;L.push(R)}else L.push(E)}o.push(L),x<s.length-1&&o.push(c`, `)}const h=this.buildWithCTE(i),p=c.join(o),b=n?c` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,S=r?c` on conflict ${r}`:void 0;return c`${h}insert into ${e} ${u} values ${p}${S}${b}`}sqlToQuery(e,s){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,invokeSource:s})}buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:n,tableConfig:i,queryConfig:o,tableAlias:a,nestedQueryRelation:l,joinOn:u}){let h=[],p,b,S=[],x;const I=[];if(o===!0)h=Object.entries(i.columns).map(([C,E])=>({dbKey:E.name,tsKey:C,field:Z(E,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{const A=Object.fromEntries(Object.entries(i.columns).map(([g,_])=>[g,Z(_,a)]));if(o.where){const g=typeof o.where=="function"?o.where(A,No()):o.where;x=g&&Ge(g,a)}const C=[];let E=[];if(o.columns){let g=!1;for(const[_,F]of Object.entries(o.columns))F!==void 0&&_ in i.columns&&(!g&&F===!0&&(g=!0),E.push(_));E.length>0&&(E=g?E.filter(_=>o.columns?.[_]===!0):Object.keys(i.columns).filter(_=>!E.includes(_)))}else E=Object.keys(i.columns);for(const g of E){const _=i.columns[g];C.push({tsKey:g,value:_})}let R=[];o.with&&(R=Object.entries(o.with).filter(g=>!!g[1]).map(([g,_])=>({tsKey:g,queryConfig:_,relation:i.relations[g]})));let k;if(o.extras){k=typeof o.extras=="function"?o.extras(A,{sql:c}):o.extras;for(const[g,_]of Object.entries(k))C.push({tsKey:g,value:pr(_,a)})}for(const{tsKey:g,value:_}of C)h.push({dbKey:d(_,m.Aliased)?_.fieldAlias:i.columns[g].name,tsKey:g,field:d(_,O)?Z(_,a):_,relationTableTsKey:void 0,isJson:!1,selection:[]});let ue=typeof o.orderBy=="function"?o.orderBy(A,Eo()):o.orderBy??[];Array.isArray(ue)||(ue=[ue]),S=ue.map(g=>d(g,O)?Z(g,a):Ge(g,a)),p=o.limit,b=o.offset;for(const{tsKey:g,queryConfig:_,relation:F}of R){const Oe=Bo(s,r,F),rt=Ee(F.referencedTable),Re=r[rt],Qe=`${a}_${g}`,Be=St(...Oe.fields.map((Y,nt)=>dr(Z(Oe.references[nt],Qe),Z(Y,a)))),U=this.buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:e[Re],tableConfig:s[Re],queryConfig:d(F,oe)?_===!0?{limit:1}:{..._,limit:1}:_,tableAlias:Qe,joinOn:Be,nestedQueryRelation:F}),N=c`(${U.sql})`.as(g);h.push({dbKey:g,tsKey:g,field:N,relationTableTsKey:Re,isJson:!0,selection:U.selection})}}if(h.length===0)throw new Ut({message:`No fields selected for table "${i.tsName}" ("${a}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let L;if(x=St(u,x),l){let A=c`json_array(${c.join(h.map(({field:R})=>d(R,pe)?c.identifier(R.name):d(R,m.Aliased)?R.sql:R),c`, `)})`;d(l,tt)&&(A=c`coalesce(json_group_array(${A}), json_array())`);const C=[{dbKey:"data",tsKey:"data",field:A.as("data"),isJson:!0,relationTableTsKey:i.tsName,selection:h}];p!==void 0||b!==void 0||S.length>0?(L=this.buildSelectQuery({table:at(n,a),fields:{},fieldsFlat:[{path:[],field:c.raw("*")}],where:x,limit:p,offset:b,orderBy:S,setOperators:[]}),x=void 0,p=void 0,b=void 0,S=void 0):L=at(n,a),L=this.buildSelectQuery({table:d(L,V)?L:new G(L,{},a),fields:{},fieldsFlat:C.map(({field:R})=>({path:[],field:d(R,O)?Z(R,a):R})),joins:I,where:x,limit:p,offset:b,orderBy:S,setOperators:[]})}else L=this.buildSelectQuery({table:at(n,a),fields:{},fieldsFlat:h.map(({field:A})=>({path:[],field:d(A,O)?Z(A,a):A})),joins:I,where:x,limit:p,offset:b,orderBy:S,setOperators:[]});return{tableTsKey:i.tsName,sql:L,selection:h}}}class sa extends wr{static[f]="SQLiteSyncDialect";migrate(e,s,r){const n=r===void 0||typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=c`
			CREATE TABLE IF NOT EXISTS ${c.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;s.run(i);const a=s.values(c`SELECT id, hash, created_at FROM ${c.identifier(n)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;s.run(c`BEGIN`);try{for(const l of e)if(!a||Number(a[2])<l.folderMillis){for(const u of l.sql)s.run(c.raw(u));s.run(c`INSERT INTO ${c.identifier(n)} ("hash", "created_at") VALUES(${l.hash}, ${l.folderMillis})`)}s.run(c`COMMIT`)}catch(l){throw s.run(c`ROLLBACK`),l}}}class ra extends wr{static[f]="SQLiteAsyncDialect";async migrate(e,s,r){const n=r===void 0||typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=c`
			CREATE TABLE IF NOT EXISTS ${c.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await s.run(i);const a=(await s.values(c`SELECT id, hash, created_at FROM ${c.identifier(n)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await s.transaction(async l=>{for(const u of e)if(!a||Number(a[2])<u.folderMillis){for(const h of u.sql)await l.run(c.raw(h));await l.run(c`INSERT INTO ${c.identifier(n)} ("hash", "created_at") VALUES(${u.hash}, ${u.folderMillis})`)}})}}class na{static[f]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class X{static[f]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){const s=!!this.fields;let r;return this.fields?r=this.fields:d(e,G)?r=Object.fromEntries(Object.keys(e._.selectedFields).map(n=>[n,e[n]])):d(e,br)?r=e[M].selectedFields:d(e,m)?r={}:r=Mo(e),new gr({table:e,fields:r,isPartialSelect:s,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}}class ia extends na{static[f]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:s,isPartialSelect:r,session:n,dialect:i,withList:o,distinct:a}){super(),this.config={withList:o,table:e,fields:{...s},distinct:a,setOperators:[]},this.isPartialSelect=r,this.session=n,this.dialect=i,this._={selectedFields:s},this.tableName=us(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(s,r)=>{const n=this.tableName,i=us(s);if(typeof i=="string"&&this.config.joins?.some(o=>o.alias===i))throw new Error(`Alias "${i}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof i=="string"&&!d(s,m))){const o=d(s,G)?s._.selectedFields:d(s,qe)?s[M].selectedFields:s[y.Symbol.Columns];this.config.fields[i]=o}if(typeof r=="function"&&(r=r(new Proxy(this.config.fields,new K({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:r,table:s,joinType:e,alias:i}),typeof i=="string")switch(e){case"left":{this.joinsNotNullableMap[i]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!0;break}case"inner":{this.joinsNotNullableMap[i]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");createSetOperator(e,s){return r=>{const n=typeof r=="function"?r(oa()):r;if(!mr(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:s,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new K({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new K({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new K({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(s)?s:[s]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new K({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),r=Array.isArray(s)?s:[s];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}else{const s=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}as(e){return new Proxy(new G(this.getSQL(),this.config.fields,e),new K({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new K({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class gr extends ia{static[f]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const s=ae(this.config.fields),r=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),s,"all",!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}}Do(gr,[le]);function st(t,e){return(s,r,...n)=>{const i=[r,...n].map(o=>({type:t,isAll:e,rightSelect:o}));for(const o of i)if(!mr(s.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return s.addSetOperators(i)}}const oa=()=>({union:aa,unionAll:la,intersect:ua,except:ca}),aa=st("union",!1),la=st("union",!0),ua=st("intersect",!1),ca=st("except",!1);class ha{static[f]="SQLiteQueryBuilder";dialect;$with(e){const s=this;return{as(r){return typeof r=="function"&&(r=r(s)),new Proxy(new lr(r.getSQL(),r.getSelectedFields(),e,!0),new K({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(i){return new X({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e})}function n(i){return new X({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e,distinct:!0})}return{select:r,selectDistinct:n}}select(e){return new X({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new X({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new sa),this.dialect}}class ds{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[f]="SQLiteUpdateBuilder";set(e){return new da(this.table,yr(this.table,e),this.session,this.dialect,this.withList)}}class da extends le{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={set:s,table:e,withList:i}}static[f]="SQLiteUpdate";config;where(e){return this.config.where=e,this}returning(e=this.config.table[V.Symbol.Columns]){return this.config.returning=ae(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0)}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class fa{constructor(e,s,r,n,i,o,a,l){this.mode=e,this.fullSchema=s,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=o,this.dialect=a,this.session=l}static[f]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new fs(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new Rt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new fs(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new Rt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}}class Rt extends le{constructor(e,s,r,n,i,o,a,l,u){super(),this.fullSchema=e,this.schema=s,this.tableNamesMap=r,this.table=n,this.tableConfig=i,this.dialect=o,this.session=a,this.config=l,this.mode=u}static[f]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){const{query:s,builtQuery:r}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](r,void 0,this.mode==="first"?"get":"all",!0,(n,i)=>{const o=n.map(a=>_t(this.schema,this.tableConfig,a,s.selection,i));return this.mode==="first"?o[0]:o})}prepare(){return this._prepare(!1)}_toSQL(){const e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),s=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:s}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}}class fs extends Rt{static[f]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}}class De extends le{constructor(e,s,r,n,i){super(),this.execute=e,this.getSQL=s,this.dialect=n,this.mapBatchResult=i,this.config={action:r}}static[f]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,s){return s?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}}class Sr{constructor(e,s,r,n){this.resultKind=e,this.dialect=s,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap}:{schema:void 0,fullSchema:{},tableNamesMap:{}},this.query={};const i=this.query;if(this._.schema)for(const[o,a]of Object.entries(this._.schema))i[o]=new fa(e,n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[o],a,s,r)}static[f]="BaseSQLiteDatabase";query;$with(e){return{as(s){return typeof s=="function"&&(s=s(new ha)),new Proxy(new lr(s.getSQL(),s.getSelectedFields(),e,!0),new K({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(l){return new X({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e})}function n(l){return new X({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e,distinct:!0})}function i(l){return new ds(l,s.session,s.dialect,e)}function o(l){return new hs(l,s.session,s.dialect,e)}function a(l){return new cs(l,s.session,s.dialect,e)}return{select:r,selectDistinct:n,update:i,insert:o,delete:a}}select(e){return new X({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new X({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new ds(e,this.session,this.dialect)}insert(e){return new hs(e,this.session,this.dialect)}delete(e){return new cs(e,this.session,this.dialect)}run(e){const s=e.getSQL();return this.resultKind==="async"?new De(async()=>this.session.run(s),()=>s,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(s)}all(e){const s=e.getSQL();return this.resultKind==="async"?new De(async()=>this.session.all(s),()=>s,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(s)}get(e){const s=e.getSQL();return this.resultKind==="async"?new De(async()=>this.session.get(s),()=>s,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(s)}values(e){const s=e.getSQL();return this.resultKind==="async"?new De(async()=>this.session.values(s),()=>s,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(s)}transaction(e,s){return this.session.transaction(e,s)}}class pa extends le{constructor(e){super(),this.resultCb=e}static[f]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}}class ma{constructor(e,s,r){this.mode=e,this.executeMethod=s,this.query=r}static[f]="PreparedQuery";joinsNotNullableMap;getQuery(){return this.query}mapRunResult(e,s){return e}mapAllResult(e,s){throw new Error("Not implemented")}mapGetResult(e,s){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new pa(()=>this[this.executeMethod](e))}mapResult(e,s){switch(this.executeMethod){case"run":return this.mapRunResult(e,s);case"all":return this.mapAllResult(e,s);case"get":return this.mapGetResult(e,s)}}}class ya{constructor(e){this.dialect=e}static[f]="SQLiteSession";prepareOneTimeQuery(e,s,r,n){return this.prepareQuery(e,s,r,n)}run(e){const s=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(s,void 0,"run",!1).run()}catch(r){throw new Ut({cause:r,message:`Failed to run the query '${s.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).values()}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}}class ba extends Sr{constructor(e,s,r,n,i=0){super(e,s,r,n),this.schema=n,this.nestedIndex=i}static[f]="SQLiteTransaction";rollback(){throw new ko}}class kt extends ya{constructor(e,s,r,n,i){super(s),this.client=e,this.schema=r,this.options=n,this.tx=i,this.logger=n.logger??new Xi}static[f]="LibSQLSession";logger;prepareQuery(e,s,r,n,i){return new wa(this.client,e,this.logger,s,this.tx,r,n,i)}async batch(e){const s=[],r=[];for(const i of e){const o=i._prepare(),a=o.getQuery();s.push(o),r.push({sql:a.sql,args:a.params})}return(await this.client.batch(r)).map((i,o)=>s[o].mapResult(i,!0))}async transaction(e,s){const r=await this.client.transaction(),n=new kt(this.client,this.dialect,this.schema,this.options,r),i=new Ft("async",this.dialect,n,this.schema);try{const o=await e(i);return await r.commit(),o}catch(o){throw await r.rollback(),o}}extractRawAllValueFromBatchResult(e){return e.rows}extractRawGetValueFromBatchResult(e){return e.rows[0]}extractRawValuesValueFromBatchResult(e){return e.rows}}class Ft extends ba{static[f]="LibSQLTransaction";async transaction(e){const s=`sp${this.nestedIndex}`,r=new Ft("async",this.dialect,this.session,this.schema,this.nestedIndex+1);await this.session.run(c.raw(`savepoint ${s}`));try{const n=await e(r);return await this.session.run(c.raw(`release savepoint ${s}`)),n}catch(n){throw await this.session.run(c.raw(`rollback to savepoint ${s}`)),n}}}class wa extends ma{constructor(e,s,r,n,i,o,a,l){super("async",o,s),this.client=e,this.logger=r,this.fields=n,this.tx=i,this._isResponseInArrayMode=a,this.customResultMapper=l,this.customResultMapper=l,this.fields=n}static[f]="LibSQLPreparedQuery";run(e){const s=Ue(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return this.tx?this.tx.execute(r):this.client.execute(r)}async all(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const u=Ue(n.params,e??{});r.logQuery(n.sql,u);const h={sql:n.sql,args:u};return(i?i.execute(h):o.execute(h)).then(({rows:p})=>this.mapAllResult(p))}const l=await this.values(e);return this.mapAllResult(l)}mapAllResult(e,s){return s&&(e=e.rows),!this.fields&&!this.customResultMapper?e.map(r=>ps(r)):this.customResultMapper?this.customResultMapper(e,Me):e.map(r=>ls(this.fields,Array.prototype.slice.call(r).map(n=>Me(n)),this.joinsNotNullableMap))}async get(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const u=Ue(n.params,e??{});r.logQuery(n.sql,u);const h={sql:n.sql,args:u};return(i?i.execute(h):o.execute(h)).then(({rows:p})=>this.mapGetResult(p))}const l=await this.values(e);return this.mapGetResult(l)}mapGetResult(e,s){s&&(e=e.rows);const r=e[0];if(!this.fields&&!this.customResultMapper)return ps(r);if(r)return this.customResultMapper?this.customResultMapper(e,Me):ls(this.fields,Array.prototype.slice.call(r).map(n=>Me(n)),this.joinsNotNullableMap)}values(e){const s=Ue(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return(this.tx?this.tx.execute(r):this.client.execute(r)).then(({rows:n})=>n)}isResponseInArrayMode(){return this._isResponseInArrayMode}}function ps(t){return Object.keys(t).reduce((e,s)=>(Object.prototype.propertyIsEnumerable.call(t,s)&&(e[s]=t[s]),e),{})}function Me(t){if(typeof ArrayBuffer<"u"&&t instanceof ArrayBuffer){if(typeof Buffer<"u")return t instanceof Buffer?t:Buffer.from(t);if(typeof TextDecoder<"u")return new TextDecoder().decode(t);throw new Error("TextDecoder is not available. Please provide either Buffer or TextDecoder polyfill.")}return t}class ga extends Sr{static[f]="LibSQLDatabase";async batch(e){return this.session.batch(e)}}function Aa(t,e={}){const s=new ra;let r;e.logger===!0?r=new Zi:e.logger!==!1&&(r=e.logger);let n;if(e.schema){const o=vo(e.schema,Po);n={fullSchema:e.schema,schema:o.tables,tableNamesMap:o.tableNamesMap}}const i=new kt(t,s,n,{logger:r},void 0);return new ga("async",s,i,n)}const Na={tursoConnectionUrl:"libsql://metrics-nps-gastongithubb.turso.io",tursoAuthToken:"eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3MjA4MDM3MjcsImlkIjoiYjI2MjM2YmUtYWExYS00YzY4LTk2MDktZDg3NDNhZGUxODViIn0.3wq3aRju7HMXzdIXr8CYZ_2YSbFIiDwIdFIAahz4xIBnxz95krzz9ISghsjmNpEF75O_vB93jE333SpWZpmICQ"};export{Na as a,c as b,Ia as c,Aa as d,$a as i,Ta as s,La as t};
