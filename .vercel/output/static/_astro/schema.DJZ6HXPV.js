class _ extends Error{code;rawCode;constructor(e,s,r,n){s!==void 0&&(e=`${s}: ${e}`),super(e,{cause:n}),this.code=s,this.rawCode=r,this.name="LibsqlError"}}function xr(t){const e=Nr.exec(t);if(e===null)throw new _("The URL is not in a valid format","URL_INVALID");const s=e.groups,r=s.scheme,n=s.authority!==void 0?Cr(s.authority):void 0,i=oe(s.path),o=s.query!==void 0?Er(s.query):void 0,a=s.fragment!==void 0?oe(s.fragment):void 0;return{scheme:r,authority:n,path:i,query:o,fragment:a}}const Nr=(()=>{const t="(?<scheme>[A-Za-z][A-Za-z.+-]*)",e="(?<authority>[^/?#]*)",s="(?<path>[^?#]*)",r="(?<query>[^#]*)",n="(?<fragment>.*)";return new RegExp(`^${t}:(//${e})?${s}(\\?${r})?(#${n})?$`,"su")})();function Cr(t){const e=Ir.exec(t);if(e===null)throw new _("The authority part of the URL is not in a valid format","URL_INVALID");const s=e.groups,r=oe(s.host_br??s.host),n=s.port?parseInt(s.port,10):void 0,i=s.username!==void 0?{username:oe(s.username),password:s.password!==void 0?oe(s.password):void 0}:void 0;return{host:r,port:n,userinfo:i}}const Ir=new RegExp("^((?<username>[^:]*)(:(?<password>.*))?@)?((?<host>[^:\\[\\]]*)|(\\[(?<host_br>[^\\[\\]]*)\\]))(:(?<port>[0-9]*))?$","su");function Er(t){const e=t.split("&"),s=[];for(const r of e){if(r==="")continue;let n,i;const o=r.indexOf("=");o<0?(n=r,i=""):(n=r.substring(0,o),i=r.substring(o+1)),s.push({key:oe(n.replaceAll("+"," ")),value:oe(i.replaceAll("+"," "))})}return{pairs:s}}function oe(t){try{return decodeURIComponent(t)}catch(e){throw e instanceof URIError?new _(`URL component has invalid percent encoding: ${e}`,"URL_INVALID",void 0,e):e}}function ht(t,e,s){if(e===void 0)throw new _(`URL with scheme ${JSON.stringify(t+":")} requires authority (the "//" part)`,"URL_INVALID");const r=`${t}:`,n=Lr(e.host),i=Ar(e.port),a=`//${$r(e.userinfo)}${n}${i}`;let l=s.split("/").map(encodeURIComponent).join("/");return l!==""&&!l.startsWith("/")&&(l="/"+l),new URL(`${r}${a}${l}`)}function Lr(t){return t.includes(":")?`[${encodeURI(t)}]`:encodeURI(t)}function Ar(t){return t!==void 0?`:${t}`:""}function $r(t){if(t===void 0)return"";const e=encodeURIComponent(t.username),s=t.password!==void 0?`:${encodeURIComponent(t.password)}`:"";return`${e}${s}@`}const bs="3.7.7",Or=bs,Re=typeof Buffer=="function",Xt=typeof TextDecoder=="function"?new TextDecoder:void 0,Zt=typeof TextEncoder=="function"?new TextEncoder:void 0,vr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Ie=Array.prototype.slice.call(vr),ke=(t=>{let e={};return t.forEach((s,r)=>e[s]=r),e})(Ie),Qr=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Q=String.fromCharCode.bind(String),es=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),gs=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),Ss=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),_s=t=>{let e,s,r,n,i="";const o=t.length%3;for(let a=0;a<t.length;){if((s=t.charCodeAt(a++))>255||(r=t.charCodeAt(a++))>255||(n=t.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=s<<16|r<<8|n,i+=Ie[e>>18&63]+Ie[e>>12&63]+Ie[e>>6&63]+Ie[e&63]}return o?i.slice(0,o-3)+"===".substring(o):i},It=typeof btoa=="function"?t=>btoa(t):Re?t=>Buffer.from(t,"binary").toString("base64"):_s,dt=Re?t=>Buffer.from(t).toString("base64"):t=>{let s=[];for(let r=0,n=t.length;r<n;r+=4096)s.push(Q.apply(null,t.subarray(r,r+4096)));return It(s.join(""))},Fe=(t,e=!1)=>e?gs(dt(t)):dt(t),Br=t=>{if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?Q(192|e>>>6)+Q(128|e&63):Q(224|e>>>12&15)+Q(128|e>>>6&63)+Q(128|e&63)}else{var e=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return Q(240|e>>>18&7)+Q(128|e>>>12&63)+Q(128|e>>>6&63)+Q(128|e&63)}},Pr=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,qs=t=>t.replace(Pr,Br),ts=Re?t=>Buffer.from(t,"utf8").toString("base64"):Zt?t=>dt(Zt.encode(t)):t=>It(qs(t)),we=(t,e=!1)=>e?gs(ts(t)):ts(t),ss=t=>we(t,!0),Ur=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,kr=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),s=e-65536;return Q((s>>>10)+55296)+Q((s&1023)+56320);case 3:return Q((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return Q((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},Rs=t=>t.replace(Ur,kr),Ts=t=>{if(t=t.replace(/\s+/g,""),!Qr.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,s="",r,n;for(let i=0;i<t.length;)e=ke[t.charAt(i++)]<<18|ke[t.charAt(i++)]<<12|(r=ke[t.charAt(i++)])<<6|(n=ke[t.charAt(i++)]),s+=r===64?Q(e>>16&255):n===64?Q(e>>16&255,e>>8&255):Q(e>>16&255,e>>8&255,e&255);return s},Et=typeof atob=="function"?t=>atob(Ss(t)):Re?t=>Buffer.from(t,"base64").toString("binary"):Ts,xs=Re?t=>es(Buffer.from(t,"base64")):t=>es(Et(t).split("").map(e=>e.charCodeAt(0))),Ns=t=>xs(Cs(t)),Dr=Re?t=>Buffer.from(t,"base64").toString("utf8"):Xt?t=>Xt.decode(xs(t)):t=>Rs(Et(t)),Cs=t=>Ss(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),ft=t=>Dr(Cs(t)),Mr=t=>{if(typeof t!="string")return!1;const e=t.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(e)||!/[^\s0-9a-zA-Z\-_]/.test(e)},Is=t=>({value:t,enumerable:!1,writable:!0,configurable:!0}),Es=function(){const t=(e,s)=>Object.defineProperty(String.prototype,e,Is(s));t("fromBase64",function(){return ft(this)}),t("toBase64",function(e){return we(this,e)}),t("toBase64URI",function(){return we(this,!0)}),t("toBase64URL",function(){return we(this,!0)}),t("toUint8Array",function(){return Ns(this)})},Ls=function(){const t=(e,s)=>Object.defineProperty(Uint8Array.prototype,e,Is(s));t("toBase64",function(e){return Fe(this,e)}),t("toBase64URI",function(){return Fe(this,!0)}),t("toBase64URL",function(){return Fe(this,!0)})},jr=()=>{Es(),Ls()},Lt={version:bs,VERSION:Or,atob:Et,atobPolyfill:Ts,btoa:It,btoaPolyfill:_s,fromBase64:ft,toBase64:we,encode:we,encodeURI:ss,encodeURL:ss,utob:qs,btou:Rs,decode:ft,isValid:Mr,fromUint8Array:Fe,toUint8Array:Ns,extendString:Es,extendUint8Array:Ls,extendBuiltins:jr},$e="https://github.com/libsql/libsql-client-ts#supported-urls";function pt(t){if(t==="write")return"BEGIN IMMEDIATE";if(t==="read")return"BEGIN TRANSACTION READONLY";if(t==="deferred")return"BEGIN DEFERRED";throw RangeError('Unknown transaction mode, supported values are "write", "read" and "deferred"')}class Fr{columns;columnTypes;rows;rowsAffected;lastInsertRowid;constructor(e,s,r,n,i){this.columns=e,this.columnTypes=s,this.rows=r,this.rowsAffected=n,this.lastInsertRowid=i}toJSON(){return{columns:this.columns,columnTypes:this.columnTypes,rows:this.rows.map(Vr),rowsAffected:this.rowsAffected,lastInsertRowid:this.lastInsertRowid!==void 0?""+this.lastInsertRowid:null}}}function Vr(t){return Array.prototype.map.call(t,zr)}function zr(t){return typeof t=="bigint"?""+t:t instanceof ArrayBuffer?Lt.fromUint8Array(new Uint8Array(t)):t}function Kr(t,e){if(typeof t!="object")throw new TypeError(`Expected client configuration as object, got ${typeof t}`);let s=t.tls,r=t.authToken,n=t.encryptionKey,i=t.syncUrl,o=t.syncInterval;const a=""+(t.intMode??"number");if(a!=="number"&&a!=="bigint"&&a!=="string")throw new TypeError(`Invalid value for intMode, expected "number", "bigint" or "string",             got ${JSON.stringify(a)}`);if(t.url===":memory:")return{path:":memory:",scheme:"file",syncUrl:i,syncInterval:o,intMode:a,fetch:t.fetch,tls:!1,authToken:void 0,encryptionKey:void 0,authority:void 0};const l=xr(t.url);for(const{key:p,value:w}of l.query?.pairs??[])if(p==="authToken")r=w||void 0;else if(p==="tls")if(w==="0")s=!1;else if(w==="1")s=!0;else throw new _(`Unknown value for the "tls" query argument: ${JSON.stringify(w)}. Supported values are "0" and "1"`,"URL_INVALID");else throw new _(`Unknown URL query parameter ${JSON.stringify(p)}`,"URL_PARAM_NOT_SUPPORTED");const c=l.scheme.toLowerCase();let h;if(c==="libsql")if(s===!1){if(l.authority?.port===void 0)throw new _('A "libsql:" URL with ?tls=0 must specify an explicit port',"URL_INVALID");h="http"}else h="https";else if(c==="http"||c==="ws")h=c,s??=!1;else if(c==="https"||c==="wss"||c==="file")h=c;else throw new _(`The client supports only "libsql:", "wss:", "ws:", "https:", "http:" and "file:" URLs, got ${JSON.stringify(l.scheme+":")}. For more information, please read ${$e}`,"URL_SCHEME_NOT_SUPPORTED");if(l.fragment!==void 0)throw new _(`URL fragments are not supported: ${JSON.stringify("#"+l.fragment)}`,"URL_INVALID");return{scheme:h,tls:s??!0,authority:l.authority,path:l.path,authToken:r,encryptionKey:n,syncUrl:i,syncInterval:o,intMode:a,fetch:t.fetch}}let pe;typeof WebSocket<"u"?pe=WebSocket:typeof global<"u"?pe=global.WebSocket:typeof window<"u"?pe=window.WebSocket:typeof self<"u"&&(pe=self.WebSocket);class As{constructor(){this.intMode="number"}intMode}class N extends Error{constructor(e){super(e),this.name="ClientError"}}class b extends N{constructor(e){super(e),this.name="ProtoError"}}class $s extends N{code;proto;constructor(e,s){super(e),this.name="ResponseError",this.code=s.code,this.proto=s,this.stack=void 0}}class K extends N{constructor(e,s){s!==void 0?(super(`${e}: ${s}`),this.cause=s):super(e),this.name="ClosedError"}}class Os extends N{constructor(e){super(e),this.name="WebSocketUnsupportedError"}}class mt extends N{constructor(e){super(e),this.name="WebSocketError"}}class vs extends N{status;constructor(e,s){super(e),this.status=s,this.name="HttpServerError"}}class ge extends N{constructor(e){super(e),this.name="ProtocolVersionError"}}class re extends N{constructor(e){super(e),this.name="InternalError"}}class Te extends N{constructor(e){super(e),this.name="MisuseError"}}function W(t){if(typeof t=="string")return t;throw xe(t,"string")}function G(t){if(t!=null){if(typeof t=="string")return t;throw xe(t,"string or null")}}function ae(t){if(typeof t=="number")return t;throw xe(t,"number")}function Oe(t){if(typeof t=="boolean")return t;throw xe(t,"boolean")}function Ke(t){if(Array.isArray(t))return t;throw xe(t,"array")}function P(t){if(t!==null&&typeof t=="object"&&!Array.isArray(t))return t;throw xe(t,"object")}function ne(t,e){return Ke(t).map(s=>e(P(s)))}function xe(t,e){if(t===void 0)return new b(`Expected ${e}, but the property was missing`);let s=typeof t;return t===null?s="null":Array.isArray(t)&&(s="array"),new b(`Expected ${e}, received ${s}`)}function At(t,e){return e(P(t))}class Jr{#e;#t;constructor(e){this.#e=e,this.#t=!1}begin(){this.#e.push("{"),this.#t=!0}end(){this.#e.push("}"),this.#t=!1}#s(e){this.#t?(this.#e.push('"'),this.#t=!1):this.#e.push(',"'),this.#e.push(e),this.#e.push('":')}string(e,s){this.#s(e),this.#e.push(JSON.stringify(s))}stringRaw(e,s){this.#s(e),this.#e.push('"'),this.#e.push(s),this.#e.push('"')}number(e,s){this.#s(e),this.#e.push(""+s)}boolean(e,s){this.#s(e),this.#e.push(s?"true":"false")}object(e,s,r){this.#s(e),this.begin(),r(this,s),this.end()}arrayObjects(e,s,r){this.#s(e),this.#e.push("[");for(let n=0;n<s.length;++n)n!==0&&this.#e.push(","),this.begin(),r(this,s[n]),this.end();this.#e.push("]")}}function Qs(t,e){const s=[],r=new Jr(s);return r.begin(),e(r,t),r.end(),s.join("")}const Le=0,yt=1,wt=2,Hr=5;class Wr{#e;#t;#s;constructor(e){this.#e=e,this.#t=new DataView(e.buffer,e.byteOffset,e.byteLength),this.#s=0}varint(){let e=0;for(let s=0;;s+=7){const r=this.#e[this.#s++];if(e|=(r&127)<<s,!(r&128))break}return e}varintBig(){let e=0n;for(let s=0n;;s+=7n){const r=this.#e[this.#s++];if(e|=BigInt(r&127)<<s,!(r&128))break}return e}bytes(e){const s=new Uint8Array(this.#e.buffer,this.#e.byteOffset+this.#s,e);return this.#s+=e,s}double(){const e=this.#t.getFloat64(this.#s,!0);return this.#s+=8,e}skipVarint(){for(;this.#e[this.#s++]&128;);}skip(e){this.#s+=e}eof(){return this.#s>=this.#e.byteLength}}class Gr{#e;#t;constructor(e){this.#e=e,this.#t=-1}setup(e){this.#t=e}#s(e){if(this.#t!==e)throw new b(`Expected wire type ${e}, got ${this.#t}`);this.#t=-1}bytes(){this.#s(wt);const e=this.#e.varint();return this.#e.bytes(e)}string(){return new TextDecoder().decode(this.bytes())}message(e){return Ze(this.bytes(),e)}int32(){return this.#s(Le),this.#e.varint()}uint32(){return this.int32()}bool(){return this.int32()!==0}uint64(){return this.#s(Le),this.#e.varintBig()}sint64(){const e=this.uint64();return e>>1n^-(e&1n)}double(){return this.#s(yt),this.#e.double()}maybeSkip(){if(!(this.#t<0)){if(this.#t===Le)this.#e.skipVarint();else if(this.#t===yt)this.#e.skip(8);else if(this.#t===wt){const e=this.#e.varint();this.#e.skip(e)}else if(this.#t===Hr)this.#e.skip(4);else throw new b(`Unexpected wire type ${this.#t}`);this.#t=-1}}}function Ze(t,e){const s=new Wr(t),r=new Gr(s);let n=e.default();for(;!s.eof();){const i=s.varint(),o=i>>3,a=i&7;r.setup(a);const l=e[o];if(l!==void 0){const c=l(r,n);c!==void 0&&(n=c)}r.maybeSkip()}return n}class $t{#e;#t;#s;#r;constructor(){this.#e=new ArrayBuffer(256),this.#t=new Uint8Array(this.#e),this.#s=new DataView(this.#e),this.#r=0}#i(e){if(this.#r+e<=this.#e.byteLength)return;let s=this.#e.byteLength;for(;s<this.#r+e;)s*=2;const r=new ArrayBuffer(s),n=new Uint8Array(r),i=new DataView(r);n.set(new Uint8Array(this.#e,0,this.#r)),this.#e=r,this.#t=n,this.#s=i}#n(e){this.#i(5),e=0|e;do{let s=e&127;e>>>=7,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#o(e){this.#i(10),e=e&0xffffffffffffffffn;do{let s=Number(e&0x7fn);e>>=7n,s|=e?128:0,this.#t[this.#r++]=s}while(e)}#a(e,s){this.#n(e<<3|s)}bytes(e,s){this.#a(e,wt),this.#n(s.byteLength),this.#i(s.byteLength),this.#t.set(s,this.#r),this.#r+=s.byteLength}string(e,s){this.bytes(e,new TextEncoder().encode(s))}message(e,s,r){const n=new $t;r(n,s),this.bytes(e,n.data())}int32(e,s){this.#a(e,Le),this.#n(s)}uint32(e,s){this.int32(e,s)}bool(e,s){this.int32(e,s?1:0)}sint64(e,s){this.#a(e,Le),this.#o(s<<1n^s>>63n)}double(e,s){this.#a(e,yt),this.#i(8),this.#s.setFloat64(this.#r,s,!0),this.#r+=8}data(){return new Uint8Array(this.#e,0,this.#r)}}function Bs(t,e){const s=new $t;return e(s,t),s.data()}class Ee{#e;#t;constructor(){this.#e=new Set,this.#t=new Set}alloc(){for(const s of this.#t)return this.#t.delete(s),this.#e.add(s),this.#e.has(this.#e.size-1)||this.#t.add(this.#e.size-1),s;const e=this.#e.size;return this.#e.add(e),e}free(e){if(!this.#e.delete(e))throw new re("Freeing an id that is not allocated");this.#t.delete(this.#e.size),e<this.#e.size&&this.#t.add(e)}}function C(t,e){throw new re(e)}function Ae(t){if(t===null)return null;if(typeof t=="string")return t;if(typeof t=="number"){if(!Number.isFinite(t))throw new RangeError("Only finite numbers (not Infinity or NaN) can be passed as arguments");return t}else if(typeof t=="bigint"){if(t<Yr||t>Xr)throw new RangeError("This bigint value is too large to be represented as a 64-bit integer and passed as argument");return t}else{if(typeof t=="boolean")return t?1n:0n;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(t instanceof Uint8Array)return t;if(t instanceof Date)return+t.valueOf();if(typeof t=="object")return""+t.toString();throw new TypeError("Unsupported type of value")}}const Yr=-9223372036854775808n,Xr=9223372036854775807n;function Ps(t,e){if(t===null)return null;if(typeof t=="number")return t;if(typeof t=="string")return t;if(typeof t=="bigint")if(e==="number"){const s=Number(t);if(!Number.isSafeInteger(s))throw new RangeError("Received integer which is too large to be safely represented as a JavaScript number");return s}else{if(e==="bigint")return t;if(e==="string")return""+t;throw new Te("Invalid value for IntMode")}else{if(t instanceof Uint8Array)return t.slice().buffer;throw t===void 0?new b("Received unrecognized type of Value"):C(t,"Impossible type of Value")}}function Qe(t){return{affectedRowCount:t.affectedRowCount,lastInsertRowid:t.lastInsertRowid,columnNames:t.cols.map(e=>e.name),columnDecltypes:t.cols.map(e=>e.decltype)}}function Us(t,e){const s=Qe(t),r=t.rows.map(n=>Ms(s.columnNames,n,e));return{...s,rows:r}}function ks(t,e){const s=Qe(t);let r;return t.rows.length>0&&(r=Ms(s.columnNames,t.rows[0],e)),{...s,row:r}}function Ds(t,e){const s=Qe(t);let r;return t.rows.length>0&&s.columnNames.length>0&&(r=Ps(t.rows[0][0],e)),{...s,value:r}}function Ms(t,e,s){const r={};Object.defineProperty(r,"length",{value:e.length});for(let n=0;n<e.length;++n){const i=Ps(e[n],s);Object.defineProperty(r,n,{value:i});const o=t[n];o!==void 0&&!Object.hasOwn(r,o)&&Object.defineProperty(r,o,{value:i,enumerable:!0})}return r}function Se(t){return new $s(t.message,t)}class Ot{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}_getSqlId(e){if(this.#e!==e)throw new Te("Attempted to use SQL text opened with other object");if(this.#s!==void 0)throw new K("SQL text is closed",this.#s);return this.#t}close(){this._setClosed(new N("SQL text was manually closed"))}_setClosed(e){this.#s===void 0&&(this.#s=e,this.#e._closeSql(this.#t))}get closed(){return this.#s!==void 0}}function bt(t,e){return e instanceof Ot?{sqlId:e._getSqlId(t)}:{sql:""+e}}class Je{#e;#t;constructor(){this.#e=[],this.#t=[]}get length(){return this.#e.length+this.#t.length}push(e){this.#e.push(e)}shift(){return this.#t.length===0&&this.#e.length>0&&(this.#t=this.#e.reverse(),this.#e=[]),this.#t.pop()}first(){return this.#t.length!==0?this.#t[this.#t.length-1]:this.#e[0]}}let gt=class{sql;_args;_namedArgs;constructor(e){this.sql=e,this._args=[],this._namedArgs=new Map}bindIndexes(e){this._args.length=0;for(const s of e)this._args.push(Ae(s));return this}bindIndex(e,s){if(e!==(e|0)||e<=0)throw new RangeError("Index of a positional argument must be positive integer");for(;this._args.length<e;)this._args.push(null);return this._args[e-1]=Ae(s),this}bindName(e,s){return this._namedArgs.set(e,Ae(s)),this}unbindAll(){return this._args.length=0,this._namedArgs.clear(),this}};function js(t,e,s){let r,n=[],i=[];if(e instanceof gt){r=e.sql,n=e._args;for(const[l,c]of e._namedArgs.entries())i.push({name:l,value:c})}else Array.isArray(e)?(r=e[0],Array.isArray(e[1])?n=e[1].map(l=>Ae(l)):i=Object.entries(e[1]).map(([l,c])=>({name:l,value:Ae(c)}))):r=e;const{sql:o,sqlId:a}=bt(t,r);return{sql:o,sqlId:a,args:n,namedArgs:i,wantRows:s}}let Zr=class{_stream;#e;_steps;#t;constructor(e,s){this._stream=e,this.#e=s,this._steps=[],this.#t=!1}step(){return new sn(this)}execute(){if(this.#t)throw new Te("This batch has already been executed");this.#t=!0;const e={steps:this._steps.map(s=>s.proto)};return this.#e?tn(this._stream,this._steps,e):en(this._stream,this._steps,e)}};function en(t,e,s){return t._batch(s).then(r=>{for(let n=0;n<e.length;++n){const i=r.stepResults.get(n),o=r.stepErrors.get(n);e[n].callback(i,o)}})}async function tn(t,e,s){const r=await t._openCursor(s);try{let n=0,i,o=[];for(;;){const a=await r.next();if(a===void 0)break;if(a.type==="step_begin"){if(a.step<n||a.step>=e.length)throw new b("Server produced StepBeginEntry for unexpected step");if(i!==void 0)throw new b("Server produced StepBeginEntry before terminating previous step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0);n=a.step+1,i=a,o=[]}else if(a.type==="step_end"){if(i===void 0)throw new b("Server produced StepEndEntry but no step is active");const l={cols:i.cols,rows:o,affectedRowCount:a.affectedRowCount,lastInsertRowid:a.lastInsertRowid};e[i.step].callback(l,void 0),i=void 0,o=[]}else if(a.type==="step_error"){if(i===void 0){if(a.step>=e.length)throw new b("Server produced StepErrorEntry for unexpected step");for(let l=n;l<a.step;++l)e[l].callback(void 0,void 0)}else{if(a.step!==i.step)throw new b("Server produced StepErrorEntry for unexpected step");i=void 0,o=[]}e[a.step].callback(void 0,a.error),n=a.step+1}else if(a.type==="row"){if(i===void 0)throw new b("Server produced RowEntry but no step is active");o.push(a.row)}else throw a.type==="error"?Se(a.error):a.type==="none"?new b("Server produced unrecognized CursorEntry"):C(a,"Impossible CursorEntry")}if(i!==void 0)throw new b("Server closed Cursor before terminating active step");for(let a=n;a<e.length;++a)e[a].callback(void 0,void 0)}finally{r.close()}}let sn=class{_batch;#e;_index;constructor(e){this._batch=e,this.#e=[],this._index=void 0}condition(e){return this.#e.push(e._proto),this}query(e){return this.#t(e,!0,Us)}queryRow(e){return this.#t(e,!0,ks)}queryValue(e){return this.#t(e,!0,Ds)}run(e){return this.#t(e,!1,Qe)}#t(e,s,r){if(this._index!==void 0)throw new Te("This BatchStep has already been added to the batch");const n=js(this._batch._stream._sqlOwner(),e,s);let i;this.#e.length===0?i=void 0:this.#e.length===1?i=this.#e[0]:i={type:"and",conds:this.#e.slice()};const o={stmt:n,condition:i};return new Promise((a,l)=>{const c=(h,p)=>{h!==void 0&&p!==void 0?l(new b("Server returned both result and error")):p!==void 0?l(Se(p)):a(h!==void 0?r(h,this._batch._stream.intMode):void 0)};this._index=this._batch._steps.length,this._batch._steps.push({proto:o,callback:c})})}},D=class ie{_batch;_proto;constructor(e,s){this._batch=e,this._proto=s}static ok(e){return new ie(e._batch,{type:"ok",step:rs(e)})}static error(e){return new ie(e._batch,{type:"error",step:rs(e)})}static not(e){return new ie(e._batch,{type:"not",cond:e._proto})}static and(e,s){for(const r of s)ns(e,r);return new ie(e,{type:"and",conds:s.map(r=>r._proto)})}static or(e,s){for(const r of s)ns(e,r);return new ie(e,{type:"or",conds:s.map(r=>r._proto)})}static isAutocommit(e){return e._stream.client()._ensureVersion(3,"BatchCond.isAutocommit()"),new ie(e,{type:"is_autocommit"})}};function rs(t){if(t._index===void 0)throw new Te("Cannot add a condition referencing a step that has not been added to the batch");return t._index}function ns(t,e){if(e._batch!==t)throw new Te("Cannot mix BatchCond objects for different Batch objects")}function rn(t){return{paramNames:t.params.map(e=>e.name),columns:t.cols,isExplain:t.isExplain,isReadonly:t.isReadonly}}class Fs{constructor(e){this.intMode=e}query(e){return this.#e(e,!0,Us)}queryRow(e){return this.#e(e,!0,ks)}queryValue(e){return this.#e(e,!0,Ds)}run(e){return this.#e(e,!1,Qe)}#e(e,s,r){const n=js(this._sqlOwner(),e,s);return this._execute(n).then(i=>r(i,this.intMode))}batch(e=!1){return new Zr(this,e)}describe(e){const s=bt(this._sqlOwner(),e);return this._describe(s).then(rn)}sequence(e){const s=bt(this._sqlOwner(),e);return this._sequence(s)}intMode}class Vs{}const nn=1e3,on=10;class an extends Vs{#e;#t;#s;#r;#i;#n;#o;constructor(e,s,r){super(),this.#e=e,this.#t=s,this.#s=r,this.#r=new Je,this.#i=new Je,this.#n=void 0,this.#o=!1}async next(){for(;;){if(this.#n!==void 0)throw new K("Cursor is closed",this.#n);for(;!this.#o&&this.#i.length<on;)this.#i.push(this.#a());const e=this.#r.shift();if(this.#o||e!==void 0)return e;await this.#i.shift().then(s=>{if(s!==void 0){for(const r of s.entries)this.#r.push(r);this.#o||=s.done}})}}#a(){return this.#t._sendCursorRequest(this,{type:"fetch_cursor",cursorId:this.#s,maxCount:nn}).then(e=>e,e=>{this._setClosed(e)})}_setClosed(e){this.#n===void 0&&(this.#n=e,this.#t._sendCursorRequest(this,{type:"close_cursor",cursorId:this.#s}).catch(()=>{}),this.#t._cursorClosed(this))}close(){this._setClosed(new N("Cursor was manually closed"))}get closed(){return this.#n!==void 0}}class vt extends Fs{#e;#t;#s;#r;#i;#n;static open(e){const s=e._streamIdAlloc.alloc(),r=new vt(e,s),n=()=>{},i=a=>r.#u(a),o={type:"open_stream",streamId:s};return e._sendRequest(o,{responseCallback:n,errorCallback:i}),r}constructor(e,s){super(e.intMode),this.#e=e,this.#t=s,this.#s=new Je,this.#r=void 0,this.#i=!1,this.#n=void 0}client(){return this.#e}_sqlOwner(){return this.#e}_execute(e){return this.#o({type:"execute",streamId:this.#t,stmt:e}).then(s=>s.result)}_batch(e){return this.#o({type:"batch",streamId:this.#t,batch:e}).then(s=>s.result)}_describe(e){return this.#e._ensureVersion(2,"describe()"),this.#o({type:"describe",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#e._ensureVersion(2,"sequence()"),this.#o({type:"sequence",streamId:this.#t,sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#o({type:"get_autocommit",streamId:this.#t}).then(e=>e.isAutocommit)}#o(e){return new Promise((s,r)=>{this.#a({type:"request",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return this.#e._ensureVersion(3,"cursor"),new Promise((s,r)=>{this.#a({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_sendCursorRequest(e,s){if(e!==this.#r)throw new re("Cursor not associated with the stream attempted to execute a request");return new Promise((r,n)=>{this.#n!==void 0?n(new K("Stream is closed",this.#n)):this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})})}_cursorClosed(e){if(e!==this.#r)throw new re("Cursor was closed, but it was not associated with the stream");this.#r=void 0,this.#l()}#a(e){this.#n!==void 0?e.errorCallback(new K("Stream is closed",this.#n)):this.#i?e.errorCallback(new K("Stream is closing",void 0)):(this.#s.push(e),this.#l())}#l(){for(;;){const e=this.#s.first();if(e===void 0&&this.#r===void 0&&this.#i){this.#u(new N("Stream was gracefully closed"));break}else if(e?.type==="request"&&this.#r===void 0){const{request:s,responseCallback:r,errorCallback:n}=e;this.#s.shift(),this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}else if(e?.type==="cursor"&&this.#r===void 0){const{batch:s,cursorCallback:r}=e;this.#s.shift();const n=this.#e._cursorIdAlloc.alloc(),i=new an(this.#e,this,n),o={type:"open_cursor",streamId:this.#t,cursorId:n,batch:s},a=()=>{},l=c=>i._setClosed(c);this.#e._sendRequest(o,{responseCallback:a,errorCallback:l}),this.#r=i,r(i)}else break}}#u(e){if(this.#n!==void 0)return;for(this.#n=e,this.#r!==void 0&&this.#r._setClosed(e);;){const i=this.#s.shift();if(i!==void 0)i.errorCallback(e);else break}const s={type:"close_stream",streamId:this.#t},r=()=>this.#e._streamIdAlloc.free(this.#t),n=()=>{};this.#e._sendRequest(s,{responseCallback:r,errorCallback:n})}close(){this.#u(new N("Stream was manually closed"))}closeGracefully(){this.#i=!0,this.#l()}get closed(){return this.#n!==void 0||this.#i}}function Qt(t,e){e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId),t.arrayObjects("args",e.args,zs),t.arrayObjects("named_args",e.namedArgs,ln),t.boolean("want_rows",e.wantRows)}function ln(t,e){t.string("name",e.name),t.object("value",e.value,zs)}function He(t,e){t.arrayObjects("steps",e.steps,un)}function un(t,e){e.condition!==void 0&&t.object("condition",e.condition,St),t.object("stmt",e.stmt,Qt)}function St(t,e){if(t.stringRaw("type",e.type),e.type==="ok"||e.type==="error")t.number("step",e.step);else if(e.type==="not")t.object("cond",e.cond,St);else if(e.type==="and"||e.type==="or")t.arrayObjects("conds",e.conds,St);else if(e.type!=="is_autocommit")throw C(e,"Impossible type of BatchCond")}function zs(t,e){if(e===null)t.stringRaw("type","null");else if(typeof e=="bigint")t.stringRaw("type","integer"),t.stringRaw("value",""+e);else if(typeof e=="number")t.stringRaw("type","float"),t.number("value",e);else if(typeof e=="string")t.stringRaw("type","text"),t.string("value",e);else if(e instanceof Uint8Array)t.stringRaw("type","blob"),t.stringRaw("base64",Lt.fromUint8Array(e));else if(e!==void 0)throw C(e,"Impossible type of Value")}function cn(t,e){if(t.stringRaw("type",e.type),e.type==="hello")e.jwt!==void 0&&t.string("jwt",e.jwt);else if(e.type==="request")t.number("request_id",e.requestId),t.object("request",e.request,hn);else throw C(e,"Impossible type of ClientMsg")}function hn(t,e){if(t.stringRaw("type",e.type),e.type==="open_stream")t.number("stream_id",e.streamId);else if(e.type==="close_stream")t.number("stream_id",e.streamId);else if(e.type==="execute")t.number("stream_id",e.streamId),t.object("stmt",e.stmt,Qt);else if(e.type==="batch")t.number("stream_id",e.streamId),t.object("batch",e.batch,He);else if(e.type==="open_cursor")t.number("stream_id",e.streamId),t.number("cursor_id",e.cursorId),t.object("batch",e.batch,He);else if(e.type==="close_cursor")t.number("cursor_id",e.cursorId);else if(e.type==="fetch_cursor")t.number("cursor_id",e.cursorId),t.number("max_count",e.maxCount);else if(e.type==="sequence")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")t.number("stream_id",e.streamId),e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type==="get_autocommit")t.number("stream_id",e.streamId);else throw C(e,"Impossible type of Request")}function Bt(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId);for(const s of e.args)t.message(3,s,Ks);for(const s of e.namedArgs)t.message(4,s,dn);t.bool(5,e.wantRows)}function dn(t,e){t.string(1,e.name),t.message(2,e.value,Ks)}function et(t,e){for(const s of e.steps)t.message(1,s,fn)}function fn(t,e){e.condition!==void 0&&t.message(1,e.condition,Pt),t.message(2,e.stmt,Bt)}function Pt(t,e){if(e.type==="ok")t.uint32(1,e.step);else if(e.type==="error")t.uint32(2,e.step);else if(e.type==="not")t.message(3,e.cond,Pt);else if(e.type==="and")t.message(4,e.conds,is);else if(e.type==="or")t.message(5,e.conds,is);else if(e.type==="is_autocommit")t.message(6,void 0,Js);else throw C(e,"Impossible type of BatchCond")}function is(t,e){for(const s of e)t.message(1,s,Pt)}function Ks(t,e){if(e===null)t.message(1,void 0,Js);else if(typeof e=="bigint")t.sint64(2,e);else if(typeof e=="number")t.double(3,e);else if(typeof e=="string")t.string(4,e);else if(e instanceof Uint8Array)t.bytes(5,e);else if(e!==void 0)throw C(e,"Impossible type of Value")}function Js(t,e){}function pn(t,e){if(e.type==="hello")t.message(1,e,mn);else if(e.type==="request")t.message(2,e,yn);else throw C(e,"Impossible type of ClientMsg")}function mn(t,e){e.jwt!==void 0&&t.string(1,e.jwt)}function yn(t,e){t.int32(1,e.requestId);const s=e.request;if(s.type==="open_stream")t.message(2,s,wn);else if(s.type==="close_stream")t.message(3,s,bn);else if(s.type==="execute")t.message(4,s,gn);else if(s.type==="batch")t.message(5,s,Sn);else if(s.type==="open_cursor")t.message(6,s,_n);else if(s.type==="close_cursor")t.message(7,s,qn);else if(s.type==="fetch_cursor")t.message(8,s,Rn);else if(s.type==="sequence")t.message(9,s,Tn);else if(s.type==="describe")t.message(10,s,xn);else if(s.type==="store_sql")t.message(11,s,Nn);else if(s.type==="close_sql")t.message(12,s,Cn);else if(s.type==="get_autocommit")t.message(13,s,In);else throw C(s,"Impossible type of Request")}function wn(t,e){t.int32(1,e.streamId)}function bn(t,e){t.int32(1,e.streamId)}function gn(t,e){t.int32(1,e.streamId),t.message(2,e.stmt,Bt)}function Sn(t,e){t.int32(1,e.streamId),t.message(2,e.batch,et)}function _n(t,e){t.int32(1,e.streamId),t.int32(2,e.cursorId),t.message(3,e.batch,et)}function qn(t,e){t.int32(1,e.cursorId)}function Rn(t,e){t.int32(1,e.cursorId),t.uint32(2,e.maxCount)}function Tn(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function xn(t,e){t.int32(1,e.streamId),e.sql!==void 0&&t.string(2,e.sql),e.sqlId!==void 0&&t.int32(3,e.sqlId)}function Nn(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function Cn(t,e){t.int32(1,e.sqlId)}function In(t,e){t.int32(1,e.streamId)}function _e(t){const e=W(t.message),s=G(t.code);return{message:e,code:s}}function Ut(t){const e=ne(t.cols,Hs),s=Ke(t.rows).map(o=>ne(o,Xs)),r=ae(t.affected_row_count),n=G(t.last_insert_rowid),i=n!==void 0?BigInt(n):void 0;return{cols:e,rows:s,affectedRowCount:r,lastInsertRowid:i}}function Hs(t){const e=G(t.name),s=G(t.decltype);return{name:e,decltype:s}}function Ws(t){const e=new Map;Ke(t.step_results).forEach((r,n)=>{r!==null&&e.set(n,Ut(P(r)))});const s=new Map;return Ke(t.step_errors).forEach((r,n)=>{r!==null&&s.set(n,_e(P(r)))}),{stepResults:e,stepErrors:s}}function Gs(t){const e=W(t.type);if(e==="step_begin"){const s=ae(t.step),r=ne(t.cols,Hs);return{type:"step_begin",step:s,cols:r}}else if(e==="step_end"){const s=ae(t.affected_row_count),r=G(t.last_insert_rowid),n=r!==void 0?BigInt(r):void 0;return{type:"step_end",affectedRowCount:s,lastInsertRowid:n}}else if(e==="step_error"){const s=ae(t.step),r=_e(P(t.error));return{type:"step_error",step:s,error:r}}else{if(e==="row")return{type:"row",row:ne(t.row,Xs)};if(e==="error")return{type:"error",error:_e(P(t.error))};throw new b("Unexpected type of CursorEntry")}}function Ys(t){const e=ne(t.params,En),s=ne(t.cols,Ln),r=Oe(t.is_explain),n=Oe(t.is_readonly);return{params:e,cols:s,isExplain:r,isReadonly:n}}function En(t){return{name:G(t.name)}}function Ln(t){const e=W(t.name),s=G(t.decltype);return{name:e,decltype:s}}function Xs(t){const e=W(t.type);if(e==="null")return null;if(e==="integer"){const s=W(t.value);return BigInt(s)}else{if(e==="float")return ae(t.value);if(e==="text")return W(t.value);if(e==="blob")return Lt.toUint8Array(W(t.base64));throw new b("Unexpected type of Value")}}function An(t){const e=W(t.type);if(e==="hello_ok")return{type:"hello_ok"};if(e==="hello_error")return{type:"hello_error",error:_e(P(t.error))};if(e==="response_ok"){const s=ae(t.request_id),r=$n(P(t.response));return{type:"response_ok",requestId:s,response:r}}else if(e==="response_error"){const s=ae(t.request_id),r=_e(P(t.error));return{type:"response_error",requestId:s,error:r}}else throw new b("Unexpected type of ServerMsg")}function $n(t){const e=W(t.type);if(e==="open_stream")return{type:"open_stream"};if(e==="close_stream")return{type:"close_stream"};if(e==="execute")return{type:"execute",result:Ut(P(t.result))};if(e==="batch")return{type:"batch",result:Ws(P(t.result))};if(e==="open_cursor")return{type:"open_cursor"};if(e==="close_cursor")return{type:"close_cursor"};if(e==="fetch_cursor"){const s=ne(t.entries,Gs),r=Oe(t.done);return{type:"fetch_cursor",entries:s,done:r}}else{if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:Ys(P(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Oe(t.is_autocommit)};throw new b("Unexpected type of Response")}}const Y={default(){return{message:"",code:void 0}},1(t,e){e.message=t.string()},2(t,e){e.code=t.string()}},qe={default(){return{cols:[],rows:[],affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.cols.push(t.message(Zs))},2(t,e){e.rows.push(t.message(er))},3(t,e){e.affectedRowCount=Number(t.uint64())},4(t,e){e.lastInsertRowid=t.sint64()}},Zs={default(){return{name:void 0,decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},er={default(){return[]},1(t,e){e.push(t.message(Dn))}},We={default(){return{stepResults:new Map,stepErrors:new Map}},1(t,e){const[s,r]=t.message(On);e.stepResults.set(s,r)},2(t,e){const[s,r]=t.message(vn);e.stepErrors.set(s,r)}},On={default(){return[0,qe.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(qe)}},vn={default(){return[0,Y.default()]},1(t,e){e[0]=t.uint32()},2(t,e){e[1]=t.message(Y)}},tr={default(){return{type:"none"}},1(t){return t.message(Qn)},2(t){return t.message(Bn)},3(t){return t.message(Pn)},4(t){return{type:"row",row:t.message(er)}},5(t){return{type:"error",error:t.message(Y)}}},Qn={default(){return{type:"step_begin",step:0,cols:[]}},1(t,e){e.step=t.uint32()},2(t,e){e.cols.push(t.message(Zs))}},Bn={default(){return{type:"step_end",affectedRowCount:0,lastInsertRowid:void 0}},1(t,e){e.affectedRowCount=t.uint32()},2(t,e){e.lastInsertRowid=t.uint64()}},Pn={default(){return{type:"step_error",step:0,error:Y.default()}},1(t,e){e.step=t.uint32()},2(t,e){e.error=t.message(Y)}},Ge={default(){return{params:[],cols:[],isExplain:!1,isReadonly:!1}},1(t,e){e.params.push(t.message(Un))},2(t,e){e.cols.push(t.message(kn))},3(t,e){e.isExplain=t.bool()},4(t,e){e.isReadonly=t.bool()}},Un={default(){return{name:void 0}},1(t,e){e.name=t.string()}},kn={default(){return{name:"",decltype:void 0}},1(t,e){e.name=t.string()},2(t,e){e.decltype=t.string()}},Dn={default(){},1(t){return null},2(t){return t.sint64()},3(t){return t.double()},4(t){return t.string()},5(t){return t.bytes()}},Mn={default(){return{type:"none"}},1(t){return{type:"hello_ok"}},2(t){return t.message(jn)},3(t){return t.message(Vn)},4(t){return t.message(Fn)}},jn={default(){return{type:"hello_error",error:Y.default()}},1(t,e){e.error=t.message(Y)}},Fn={default(){return{type:"response_error",requestId:0,error:Y.default()}},1(t,e){e.requestId=t.int32()},2(t,e){e.error=t.message(Y)}},Vn={default(){return{type:"response_ok",requestId:0,response:{type:"none"}}},1(t,e){e.requestId=t.int32()},2(t,e){e.response={type:"open_stream"}},3(t,e){e.response={type:"close_stream"}},4(t,e){e.response=t.message(zn)},5(t,e){e.response=t.message(Kn)},6(t,e){e.response={type:"open_cursor"}},7(t,e){e.response={type:"close_cursor"}},8(t,e){e.response=t.message(Jn)},9(t,e){e.response={type:"sequence"}},10(t,e){e.response=t.message(Hn)},11(t,e){e.response={type:"store_sql"}},12(t,e){e.response={type:"close_sql"}},13(t,e){e.response=t.message(Wn)}},zn={default(){return{type:"execute",result:qe.default()}},1(t,e){e.result=t.message(qe)}},Kn={default(){return{type:"batch",result:We.default()}},1(t,e){e.result=t.message(We)}},Jn={default(){return{type:"fetch_cursor",entries:[],done:!1}},1(t,e){e.entries.push(t.message(tr))},2(t,e){e.done=t.bool()}},Hn={default(){return{type:"describe",result:Ge.default()}},1(t,e){e.result=t.message(Ge)}},Wn={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},Gn=new Map([["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]),sr=new Map([["hrana3-protobuf",{version:3,encoding:"protobuf"}],["hrana3",{version:3,encoding:"json"}],["hrana2",{version:2,encoding:"json"}],["hrana1",{version:1,encoding:"json"}]]);let Yn=class extends As{#e;#t;#s;#r;#i;#n;#o;#a;#l;_streamIdAlloc;_cursorIdAlloc;#u;constructor(e,s){super(),this.#e=e,this.#t=[],this.#s=!1,this.#r=void 0,this.#i=!1,this.#n=void 0,this.#o=!1,this.#a=new Map,this.#l=new Ee,this._streamIdAlloc=new Ee,this._cursorIdAlloc=new Ee,this.#u=new Ee,this.#e.binaryType="arraybuffer",this.#e.addEventListener("open",()=>this.#p()),this.#e.addEventListener("close",r=>this.#f(r)),this.#e.addEventListener("error",r=>this.#m(r)),this.#e.addEventListener("message",r=>this.#w(r)),this.#h({type:"hello",jwt:s})}#h(e){if(this.#r!==void 0)throw new re("Trying to send a message on a closed client");if(this.#s)this.#d(e);else{const s=()=>this.#d(e),r=()=>{};this.#t.push({openCallback:s,errorCallback:r})}}#p(){const e=this.#e.protocol;if(e===void 0){this.#c(new N("The `WebSocket.protocol` property is undefined. This most likely means that the WebSocket implementation provided by the environment is broken. If you are using Miniflare 2, please update to Miniflare 3, which fixes this problem."));return}else if(e==="")this.#n={version:1,encoding:"json"};else if(this.#n=sr.get(e),this.#n===void 0){this.#c(new b(`Unrecognized WebSocket subprotocol: ${JSON.stringify(e)}`));return}for(const s of this.#t)s.openCallback();this.#t.length=0,this.#s=!0}#d(e){const s=this.#n.encoding;if(s==="json"){const r=Qs(e,cn);this.#e.send(r)}else if(s==="protobuf"){const r=Bs(e,pn);this.#e.send(r)}else throw C(s,"Impossible encoding")}getVersion(){return new Promise((e,s)=>{if(this.#o=!0,this.#r!==void 0)s(this.#r);else if(this.#s)e(this.#n.version);else{const r=()=>e(this.#n.version);this.#t.push({openCallback:r,errorCallback:s})}})}_ensureVersion(e,s){if(this.#n===void 0||!this.#o)throw new ge(`${s} is supported only on protocol version ${e} and higher, but the version supported by the WebSocket server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this.#n.version<e)throw new ge(`${s} is supported on protocol version ${e} and higher, but the WebSocket server only supports version ${this.#n.version}`)}_sendRequest(e,s){if(this.#r!==void 0){s.errorCallback(new K("Client is closed",this.#r));return}const r=this.#l.alloc();this.#a.set(r,{...s,type:e.type}),this.#h({type:"request",requestId:r,request:e})}#m(e){const r=e.message??"WebSocket was closed due to an error";this.#c(new mt(r))}#f(e){let s=`WebSocket was closed with code ${e.code}`;e.reason&&(s+=`: ${e.reason}`),this.#c(new mt(s))}#c(e){if(this.#r===void 0){this.#r=e;for(const s of this.#t)s.errorCallback(e);this.#t.length=0;for(const[s,r]of this.#a.entries())r.errorCallback(e),this.#l.free(s);this.#a.clear(),this.#e.close()}}#w(e){if(this.#r===void 0)try{let s;const r=this.#n.encoding;if(r==="json"){if(typeof e.data!="string"){this.#e.close(3003,"Only text messages are accepted with JSON encoding"),this.#c(new b("Received non-text message from server with JSON encoding"));return}s=At(JSON.parse(e.data),An)}else if(r==="protobuf"){if(!(e.data instanceof ArrayBuffer)){this.#e.close(3003,"Only binary messages are accepted with Protobuf encoding"),this.#c(new b("Received non-binary message from server with Protobuf encoding"));return}s=Ze(new Uint8Array(e.data),Mn)}else throw C(r,"Impossible encoding");this.#y(s)}catch(s){this.#e.close(3007,"Could not handle message"),this.#c(s)}}#y(e){if(e.type==="none")throw new b("Received an unrecognized ServerMsg");if(e.type==="hello_ok"||e.type==="hello_error"){if(this.#i)throw new b("Received a duplicated hello response");if(this.#i=!0,e.type==="hello_error")throw Se(e.error);return}else if(!this.#i)throw new b("Received a non-hello message before a hello response");if(e.type==="response_ok"){const s=e.requestId,r=this.#a.get(s);if(this.#a.delete(s),r===void 0)throw new b("Received unexpected OK response");this.#l.free(s);try{if(r.type!==e.response.type)throw console.dir({responseState:r,msg:e}),new b("Received unexpected type of response");r.responseCallback(e.response)}catch(n){throw r.errorCallback(n),n}}else if(e.type==="response_error"){const s=e.requestId,r=this.#a.get(s);if(this.#a.delete(s),r===void 0)throw new b("Received unexpected error response");this.#l.free(s),r.errorCallback(Se(e.error))}else throw C(e,"Impossible ServerMsg type")}openStream(){return vt.open(this)}storeSql(e){this._ensureVersion(2,"storeSql()");const s=this.#u.alloc(),r=new Ot(this,s),n=()=>{},i=a=>r._setClosed(a),o={type:"store_sql",sqlId:s,sql:e};return this._sendRequest(o,{responseCallback:n,errorCallback:i}),r}_closeSql(e){if(this.#r!==void 0)return;const s=()=>this.#u.free(e),r=i=>this.#c(i),n={type:"close_sql",sqlId:e};this._sendRequest(n,{responseCallback:s,errorCallback:r})}close(){this.#c(new N("Client was manually closed"))}get closed(){return this.#r!==void 0}};const Xn=fetch,rr=Request,Zn=Headers;let me;if(typeof queueMicrotask<"u")me=queueMicrotask;else{const t=Promise.resolve();me=e=>{t.then(e)}}class ei{#e;#t;#s;constructor(e){this.#e=new Uint8Array(new ArrayBuffer(e)),this.#t=0,this.#s=0}get length(){return this.#s-this.#t}data(){return this.#e.slice(this.#t,this.#s)}push(e){this.#r(e.byteLength),this.#e.set(e,this.#s),this.#s+=e.byteLength}#r(e){if(this.#s+e<=this.#e.byteLength)return;const s=this.#s-this.#t;if(s+e<=this.#e.byteLength&&2*this.#s>=this.#e.byteLength)this.#e.copyWithin(0,this.#t,this.#s);else{let r=this.#e.byteLength;do r*=2;while(s+e>r);const n=new Uint8Array(new ArrayBuffer(r));n.set(this.#e.slice(this.#t,this.#s),0),this.#e=n}this.#s=s,this.#t=0}shift(e){this.#t+=e}}function ti(t){const e=G(t.baton),s=G(t.base_url),r=ne(t.results,si);return{baton:e,baseUrl:s,results:r}}function si(t){const e=W(t.type);if(e==="ok")return{type:"ok",response:ri(P(t.response))};if(e==="error")return{type:"error",error:_e(P(t.error))};throw new b("Unexpected type of StreamResult")}function ri(t){const e=W(t.type);if(e==="close")return{type:"close"};if(e==="execute")return{type:"execute",result:Ut(P(t.result))};if(e==="batch")return{type:"batch",result:Ws(P(t.result))};if(e==="sequence")return{type:"sequence"};if(e==="describe")return{type:"describe",result:Ys(P(t.result))};if(e==="store_sql")return{type:"store_sql"};if(e==="close_sql")return{type:"close_sql"};if(e==="get_autocommit")return{type:"get_autocommit",isAutocommit:Oe(t.is_autocommit)};throw new b("Unexpected type of StreamResponse")}function ni(t){const e=G(t.baton),s=G(t.base_url);return{baton:e,baseUrl:s}}const ii={default(){return{baton:void 0,baseUrl:void 0,results:[]}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()},3(t,e){e.results.push(t.message(oi))}},oi={default(){return{type:"none"}},1(t){return{type:"ok",response:t.message(ai)}},2(t){return{type:"error",error:t.message(Y)}}},ai={default(){return{type:"none"}},1(t){return{type:"close"}},2(t){return t.message(li)},3(t){return t.message(ui)},4(t){return{type:"sequence"}},5(t){return t.message(ci)},6(t){return{type:"store_sql"}},7(t){return{type:"close_sql"}},8(t){return t.message(hi)}},li={default(){return{type:"execute",result:qe.default()}},1(t,e){e.result=t.message(qe)}},ui={default(){return{type:"batch",result:We.default()}},1(t,e){e.result=t.message(We)}},ci={default(){return{type:"describe",result:Ge.default()}},1(t,e){e.result=t.message(Ge)}},hi={default(){return{type:"get_autocommit",isAutocommit:!1}},1(t,e){e.isAutocommit=t.bool()}},di={default(){return{baton:void 0,baseUrl:void 0}},1(t,e){e.baton=t.string()},2(t,e){e.baseUrl=t.string()}};class fi extends Vs{#e;#t;#s;#r;#i;#n;constructor(e,s){super(),this.#e=e,this.#t=s,this.#s=void 0,this.#r=new ei(16*1024),this.#i=void 0,this.#n=!1}async open(e){if(e.body===null)throw new b("No response body for cursor request");this.#s=e.body.getReader();const s=await this.#o(ni,di);if(s===void 0)throw new b("Empty response to cursor request");return s}next(){return this.#o(Gs,tr)}close(){this._setClosed(new N("Cursor was manually closed"))}_setClosed(e){this.#i===void 0&&(this.#i=e,this.#e._cursorClosed(this),this.#s!==void 0&&this.#s.cancel())}get closed(){return this.#i!==void 0}async#o(e,s){for(;;){if(this.#n)return;if(this.#i!==void 0)throw new K("Cursor is closed",this.#i);if(this.#t==="json"){const i=this.#a();if(i!==void 0){const o=new TextDecoder().decode(i),a=JSON.parse(o);return At(a,e)}}else if(this.#t==="protobuf"){const i=this.#l();if(i!==void 0)return Ze(i,s)}else throw C(this.#t,"Impossible encoding");if(this.#s===void 0)throw new re("Attempted to read from HTTP cursor before it was opened");const{value:r,done:n}=await this.#s.read();if(n&&this.#r.length===0)this.#n=!0;else{if(n)throw new b("Unexpected end of cursor stream");this.#r.push(r)}}}#a(){const e=this.#r.data(),r=e.indexOf(10);if(r<0)return;const n=e.slice(0,r);return this.#r.shift(r+1),n}#l(){const e=this.#r.data();let s=0,r=0;for(;;){if(r>=e.byteLength)return;const i=e[r];if(s|=(i&127)<<7*r,r+=1,!(i&128))break}if(e.byteLength<r+s)return;const n=e.slice(r,r+s);return this.#r.shift(r+s),n}}function pi(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.arrayObjects("requests",e.requests,mi)}function mi(t,e){if(t.stringRaw("type",e.type),e.type!=="close"){if(e.type==="execute")t.object("stmt",e.stmt,Qt);else if(e.type==="batch")t.object("batch",e.batch,He);else if(e.type==="sequence")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="describe")e.sql!==void 0&&t.string("sql",e.sql),e.sqlId!==void 0&&t.number("sql_id",e.sqlId);else if(e.type==="store_sql")t.number("sql_id",e.sqlId),t.string("sql",e.sql);else if(e.type==="close_sql")t.number("sql_id",e.sqlId);else if(e.type!=="get_autocommit")throw C(e,"Impossible type of StreamRequest")}}function yi(t,e){e.baton!==void 0&&t.string("baton",e.baton),t.object("batch",e.batch,He)}function wi(t,e){e.baton!==void 0&&t.string(1,e.baton);for(const s of e.requests)t.message(2,s,bi)}function bi(t,e){if(e.type==="close")t.message(1,e,gi);else if(e.type==="execute")t.message(2,e,Si);else if(e.type==="batch")t.message(3,e,_i);else if(e.type==="sequence")t.message(4,e,qi);else if(e.type==="describe")t.message(5,e,Ri);else if(e.type==="store_sql")t.message(6,e,Ti);else if(e.type==="close_sql")t.message(7,e,xi);else if(e.type==="get_autocommit")t.message(8,e,Ni);else throw C(e,"Impossible type of StreamRequest")}function gi(t,e){}function Si(t,e){t.message(1,e.stmt,Bt)}function _i(t,e){t.message(1,e.batch,et)}function qi(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function Ri(t,e){e.sql!==void 0&&t.string(1,e.sql),e.sqlId!==void 0&&t.int32(2,e.sqlId)}function Ti(t,e){t.int32(1,e.sqlId),t.string(2,e.sql)}function xi(t,e){t.int32(1,e.sqlId)}function Ni(t,e){}function Ci(t,e){e.baton!==void 0&&t.string(1,e.baton),t.message(2,e.batch,et)}class Ii extends Fs{#e;#t;#s;#r;#i;#n;#o;#a;#l;#u;#h;#p;constructor(e,s,r,n){super(e.intMode),this.#e=e,this.#t=s.toString(),this.#s=r,this.#r=n,this.#i=void 0,this.#n=new Je,this.#o=!1,this.#l=!1,this.#u=!1,this.#h=void 0,this.#p=new Ee}client(){return this.#e}_sqlOwner(){return this}storeSql(e){const s=this.#p.alloc();return this.#d({type:"store_sql",sqlId:s,sql:e}).then(()=>{},r=>this._setClosed(r)),new Ot(this,s)}_closeSql(e){this.#h===void 0&&this.#d({type:"close_sql",sqlId:e}).then(()=>this.#p.free(e),s=>this._setClosed(s))}_execute(e){return this.#d({type:"execute",stmt:e}).then(s=>s.result)}_batch(e){return this.#d({type:"batch",batch:e}).then(s=>s.result)}_describe(e){return this.#d({type:"describe",sql:e.sql,sqlId:e.sqlId}).then(s=>s.result)}_sequence(e){return this.#d({type:"sequence",sql:e.sql,sqlId:e.sqlId}).then(s=>{})}getAutocommit(){return this.#e._ensureVersion(3,"getAutocommit()"),this.#d({type:"get_autocommit"}).then(e=>e.isAutocommit)}#d(e){return new Promise((s,r)=>{this.#m({type:"pipeline",request:e,responseCallback:s,errorCallback:r})})}_openCursor(e){return new Promise((s,r)=>{this.#m({type:"cursor",batch:e,cursorCallback:s,errorCallback:r})})}_cursorClosed(e){if(e!==this.#a)throw new re("Cursor was closed, but it was not associated with the stream");this.#a=void 0,me(()=>this.#f())}close(){this._setClosed(new N("Stream was manually closed"))}closeGracefully(){this.#l=!0,me(()=>this.#f())}get closed(){return this.#h!==void 0||this.#l}_setClosed(e){if(this.#h===void 0){for(this.#h=e,this.#a!==void 0&&this.#a._setClosed(e),this.#e._streamClosed(this);;){const s=this.#n.shift();if(s!==void 0)s.errorCallback(e);else break}(this.#i!==void 0||this.#o)&&!this.#u&&(this.#n.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0,me(()=>this.#f()))}}#m(e){if(this.#h!==void 0)throw new K("Stream is closed",this.#h);if(this.#l)throw new K("Stream is closing",void 0);this.#n.push(e),me(()=>this.#f())}#f(){if(this.#o||this.#a!==void 0)return;if(this.#l&&this.#n.length===0){this._setClosed(new N("Stream was gracefully closed"));return}const e=this.#e._endpoint;if(e===void 0){this.#e._endpointPromise.then(()=>this.#f(),r=>this._setClosed(r));return}const s=this.#n.shift();if(s!==void 0)if(s.type==="pipeline"){const r=[s];for(;;){const n=this.#n.first();if(n!==void 0&&n.type==="pipeline")r.push(n),this.#n.shift();else if(n===void 0&&this.#l&&!this.#u){r.push({type:"pipeline",request:{type:"close"},responseCallback:()=>{},errorCallback:()=>{}}),this.#u=!0;break}else break}this.#c(e,r)}else if(s.type==="cursor")this.#w(e,s);else throw C(s,"Impossible type of QueueEntry")}#c(e,s){this.#y(()=>this.#g(s,e),r=>Li(r,e.encoding),r=>r.baton,r=>r.baseUrl,r=>Ei(s,r),r=>s.forEach(n=>n.errorCallback(r)))}#w(e,s){const r=new fi(this,e.encoding);this.#a=r,this.#y(()=>this.#S(s,e),n=>r.open(n),n=>n.baton,n=>n.baseUrl,n=>s.cursorCallback(r),n=>s.errorCallback(n))}#y(e,s,r,n,i,o){let a;try{const l=e(),c=this.#r;a=c(l)}catch(l){a=Promise.reject(l)}this.#o=!0,a.then(l=>l.ok?s(l):Ai(l).then(c=>{throw c})).then(l=>{this.#i=r(l),this.#t=n(l)??this.#t,i(l)}).catch(l=>{this._setClosed(l),o(l)}).finally(()=>{this.#o=!1,this.#f()})}#g(e,s){return this.#b(new URL(s.pipelinePath,this.#t),{baton:this.#i,requests:e.map(r=>r.request)},s.encoding,pi,wi)}#S(e,s){if(s.cursorPath===void 0)throw new ge(`Cursors are supported only on protocol version 3 and higher, but the HTTP server only supports version ${s.version}.`);return this.#b(new URL(s.cursorPath,this.#t),{baton:this.#i,batch:e.batch},s.encoding,yi,Ci)}#b(e,s,r,n,i){let o,a;if(r==="json")o=Qs(s,n),a="application/json";else if(r==="protobuf")o=Bs(s,i),a="application/x-protobuf";else throw C(r,"Impossible encoding");const l=new Zn;return l.set("content-type",a),this.#s!==void 0&&l.set("authorization",`Bearer ${this.#s}`),new rr(e.toString(),{method:"POST",headers:l,body:o})}}function Ei(t,e){if(e.results.length!==t.length)throw new b("Server returned unexpected number of pipeline results");for(let s=0;s<t.length;++s){const r=e.results[s],n=t[s];if(r.type==="ok"){if(r.response.type!==n.request.type)throw new b("Received unexpected type of response");n.responseCallback(r.response)}else if(r.type==="error")n.errorCallback(Se(r.error));else throw r.type==="none"?new b("Received unrecognized type of StreamResult"):C(r,"Received impossible type of StreamResult")}}async function Li(t,e){if(e==="json"){const s=await t.json();return At(s,ti)}else if(e==="protobuf"){const s=await t.arrayBuffer();return Ze(new Uint8Array(s),ii)}else throw C(e,"Impossible encoding")}async function Ai(t){const e=t.headers.get("content-type")??"text/plain";if(e==="application/json"){const r=await t.json();if("message"in r)return Se(r)}let s=`Server returned HTTP status ${t.status}`;if(e==="text/plain"){const r=(await t.text()).trim();r!==""&&(s+=`: ${r}`)}return t.status===404&&(s+=". It seems that the libsql server is outdated, please try updating the database."),new vs(s,t.status)}const $i=[{versionPath:"v3-protobuf",pipelinePath:"v3-protobuf/pipeline",cursorPath:"v3-protobuf/cursor",version:3,encoding:"protobuf"}],_t={versionPath:"v2",pipelinePath:"v2/pipeline",cursorPath:void 0,version:2,encoding:"json"};let Oi=class extends As{#e;#t;#s;#r;#i;_endpointPromise;_endpoint;constructor(e,s,r,n=2){super(),this.#e=e,this.#t=s,this.#s=r??Xn,this.#r=void 0,this.#i=new Set,n==3?(this._endpointPromise=vi(this.#s,this.#e),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i))):(this._endpointPromise=Promise.resolve(_t),this._endpointPromise.then(i=>this._endpoint=i,i=>this.#n(i)))}async getVersion(){return this._endpoint!==void 0?this._endpoint.version:(await this._endpointPromise).version}_ensureVersion(e,s){if(!(e<=_t.version)){if(this._endpoint===void 0)throw new ge(`${s} is supported only on protocol version ${e} and higher, but the version supported by the HTTP server is not yet known. Use Client.getVersion() to wait until the version is available.`);if(this._endpoint.version<e)throw new ge(`${s} is supported only on protocol version ${e} and higher, but the HTTP server only supports version ${this._endpoint.version}.`)}}openStream(){if(this.#r!==void 0)throw new K("Client is closed",this.#r);const e=new Ii(this,this.#e,this.#t,this.#s);return this.#i.add(e),e}_streamClosed(e){this.#i.delete(e)}close(){this.#n(new N("Client was manually closed"))}get closed(){return this.#r!==void 0}#n(e){if(this.#r===void 0){this.#r=e;for(const s of Array.from(this.#i))s._setClosed(new K("Client was closed",e))}}};async function vi(t,e){const s=t;for(const r of $i){const n=new URL(r.versionPath,e),i=new rr(n.toString(),{method:"GET"}),o=await s(i);if(await o.arrayBuffer(),o.ok)return r}return _t}function nr(t,e,s=2){if(typeof pe>"u")throw new Os("WebSockets are not supported in this environment");var r=void 0;s==3?r=Array.from(sr.keys()):r=Array.from(Gn.keys());const n=new pe(t,r);return new Yn(n,e)}function Qi(t,e,s,r=2){return new Oi(t instanceof URL?t:new URL(t),e,s,r)}class ir{#e;#t;#s;constructor(e,s){this.#e=e,this.#t=s,this.#s=void 0}execute(e){return this.batch([e]).then(s=>s[0])}async batch(e){const s=this._getStream();if(s.closed)throw new _("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{const r=e.map(ve);let n;if(this.#s===void 0){this._getSqlCache().apply(r);const o=s.batch(this.#t>=3),a=o.step(),l=a.run(pt(this.#e));let c=a;n=r.map(h=>{const p=o.step().condition(D.ok(c));this.#t>=3&&p.condition(D.not(D.isAutocommit(o)));const w=p.query(h);return w.catch(()=>{}),c=p,w}),this.#s=o.execute().then(()=>l).then(()=>{});try{await this.#s}catch(h){throw this.close(),h}}else{this.#t<3&&await this.#s,this._getSqlCache().apply(r);const o=s.batch(this.#t>=3);let a;n=r.map(l=>{const c=o.step();a!==void 0&&c.condition(D.ok(a)),this.#t>=3&&c.condition(D.not(D.isAutocommit(o)));const h=c.query(l);return h.catch(()=>{}),a=c,h}),await o.execute()}const i=[];for(const o of n){const a=await o;if(a===void 0)throw new _("Statement in a transaction was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");i.push(tt(a))}return i}catch(r){throw O(r)}}async executeMultiple(e){const s=this._getStream();if(s.closed)throw new _("Cannot execute statements because the transaction is closed","TRANSACTION_CLOSED");try{if(this.#s===void 0){this.#s=s.run(pt(this.#e)).then(()=>{});try{await this.#s}catch(r){throw this.close(),r}}else await this.#s;await s.sequence(e)}catch(r){throw O(r)}}async rollback(){try{const e=this._getStream();if(e.closed||this.#s===void 0)return;const s=e.run("ROLLBACK").catch(r=>{throw O(r)});e.closeGracefully(),await s}catch(e){throw O(e)}finally{this.close()}}async commit(){try{const e=this._getStream();if(e.closed)throw new _("Cannot commit the transaction because it is already closed","TRANSACTION_CLOSED");if(this.#s!==void 0)await this.#s;else return;const s=e.run("COMMIT").catch(r=>{throw O(r)});e.closeGracefully(),await s}catch(e){throw O(e)}finally{this.close()}}}async function or(t,e,s,r){const n=s.step(),i=n.run(pt(t));let o=n;const a=r.map(w=>{const q=s.step().condition(D.ok(o));e>=3&&q.condition(D.not(D.isAutocommit(s)));const R=q.query(w);return o=q,R}),l=s.step().condition(D.ok(o));e>=3&&l.condition(D.not(D.isAutocommit(s)));const c=l.run("COMMIT");s.step().condition(D.not(D.ok(l))).run("ROLLBACK").catch(w=>{}),await s.execute();const p=[];await i;for(const w of a){const q=await w;if(q===void 0)throw new _("Statement in a batch was not executed, probably because the transaction has been rolled back","TRANSACTION_CLOSED");p.push(tt(q))}return await c,p}function ve(t){if(typeof t=="string")return new gt(t);const e=new gt(t.sql);if(Array.isArray(t.args))e.bindIndexes(t.args);else for(const[s,r]of Object.entries(t.args))e.bindName(s,r);return e}function tt(t){const e=t.columnNames.map(o=>o??""),s=t.columnDecltypes.map(o=>o??""),r=t.rows,n=t.affectedRowCount,i=t.lastInsertRowid!==void 0?t.lastInsertRowid:void 0;return new Fr(e,s,r,n,i)}function O(t){if(t instanceof N){const e=ar(t);return new _(t.message,e,void 0,t)}return t}function ar(t){return t instanceof $s&&t.code!==void 0?t.code:t instanceof b?"HRANA_PROTO_ERROR":t instanceof K?t.cause instanceof N?ar(t.cause):"HRANA_CLOSED_ERROR":t instanceof mt?"HRANA_WEBSOCKET_ERROR":t instanceof vs?"SERVER_ERROR":t instanceof ge?"PROTOCOL_VERSION_ERROR":t instanceof re?"INTERNAL_ERROR":"UNKNOWN"}class kt{#e;#t;capacity;constructor(e,s){this.#e=e,this.#t=new Bi,this.capacity=s}apply(e){if(this.capacity<=0)return;const s=new Set;for(const r of e){if(typeof r.sql!="string")continue;const n=r.sql;let i=this.#t.get(n);if(i===void 0){for(;this.#t.size+1>this.capacity;){const[o,a]=this.#t.peekLru();if(s.has(a))break;a.close(),this.#t.delete(o)}this.#t.size+1<=this.capacity&&(i=this.#e.storeSql(n),this.#t.set(n,i))}i!==void 0&&(r.sql=i,s.add(i))}}}class Bi{#e;constructor(){this.#e=new Map}get(e){const s=this.#e.get(e);return s!==void 0&&(this.#e.delete(e),this.#e.set(e,s)),s}set(e,s){this.#e.set(e,s)}peekLru(){for(const e of this.#e.entries())return e}delete(e){this.#e.delete(e)}get size(){return this.#e.size}}function Pi(t){if(t.scheme!=="wss"&&t.scheme!=="ws")throw new _(`The WebSocket client supports only "libsql:", "wss:" and "ws:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${$e}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new _("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="ws"&&t.tls)throw new _('A "ws:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="wss"&&!t.tls)throw new _('A "wss:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=ht(t.scheme,t.authority,t.path);let s;try{s=nr(e,t.authToken)}catch(r){if(r instanceof Os){const n=t.scheme==="wss"?"https":"http",i=ht(n,t.authority,t.path);throw new _(`This environment does not support WebSockets, please switch to the HTTP client by using a "${n}:" URL (${JSON.stringify(i)}). For more information, please read ${$e}`,"WEBSOCKETS_NOT_SUPPORTED")}throw O(r)}return new Di(s,e,t.authToken,t.intMode)}const Ui=60*1e3,ki=100;class Di{#e;#t;#s;#r;#i;closed;protocol;constructor(e,s,r,n){this.#e=s,this.#t=r,this.#s=n,this.#r=this.#o(e),this.#i=void 0,this.closed=!1,this.protocol="ws"}async execute(e){const s=await this.#n();try{const r=ve(e);s.conn.sqlCache.apply([r]);const n=s.stream.query(r);return s.stream.closeGracefully(),tt(await n)}catch(r){throw O(r)}finally{this._closeStream(s)}}async batch(e,s="deferred"){const r=await this.#n();try{const n=e.map(ve),i=await r.conn.client.getVersion();r.conn.sqlCache.apply(n);const o=r.stream.batch(i>=3);return await or(s,i,o,n)}catch(n){throw O(n)}finally{this._closeStream(r)}}async transaction(e="write"){const s=await this.#n();try{const r=await s.conn.client.getVersion();return new Mi(this,s,e,r)}catch(r){throw this._closeStream(s),O(r)}}async executeMultiple(e){const s=await this.#n();try{const r=s.stream.sequence(e);s.stream.closeGracefully(),await r}catch(r){throw O(r)}finally{this._closeStream(s)}}sync(){return Promise.resolve()}async#n(){if(this.closed)throw new _("The client is closed","CLIENT_CLOSED");if(new Date().valueOf()-this.#r.openTime.valueOf()>Ui&&this.#i===void 0){const n=this.#o();this.#i=n,n.client.getVersion().then(i=>{this.#r!==n&&this.#r.streamStates.size===0&&this.#r.client.close(),this.#r=n,this.#i=void 0},i=>{this.#i=void 0})}if(this.#r.client.closed)try{this.#i!==void 0?this.#r=this.#i:this.#r=this.#o()}catch(n){throw O(n)}const r=this.#r;try{r.useSqlCache===void 0&&(r.useSqlCache=await r.client.getVersion()>=2,r.useSqlCache&&(r.sqlCache.capacity=ki));const n=r.client.openStream();n.intMode=this.#s;const i={conn:r,stream:n};return r.streamStates.add(i),i}catch(n){throw O(n)}}#o(e){try{return e??=nr(this.#e,this.#t),{client:e,useSqlCache:void 0,sqlCache:new kt(e,0),openTime:new Date,streamStates:new Set}}catch(s){throw O(s)}}_closeStream(e){e.stream.close();const s=e.conn;s.streamStates.delete(e),s.streamStates.size===0&&s!==this.#r&&s.client.close()}close(){this.#r.client.close(),this.closed=!0}}class Mi extends ir{#e;#t;constructor(e,s,r,n){super(r,n),this.#e=e,this.#t=s}_getStream(){return this.#t.stream}_getSqlCache(){return this.#t.conn.sqlCache}close(){this.#e._closeStream(this.#t)}get closed(){return this.#t.stream.closed}}function ji(t){if(t.scheme!=="https"&&t.scheme!=="http")throw new _(`The HTTP client supports only "libsql:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${$e}`,"URL_SCHEME_NOT_SUPPORTED");if(t.encryptionKey!==void 0)throw new _("Encryption key is not supported by the remote client.","ENCRYPTION_KEY_NOT_SUPPORTED");if(t.scheme==="http"&&t.tls)throw new _('A "http:" URL cannot opt into TLS by using ?tls=1',"URL_INVALID");if(t.scheme==="https"&&!t.tls)throw new _('A "https:" URL cannot opt out of TLS by using ?tls=0',"URL_INVALID");const e=ht(t.scheme,t.authority,t.path);return new Fi(e,t.authToken,t.intMode,t.fetch)}const lr=30;class Fi{#e;protocol;constructor(e,s,r,n){this.#e=Qi(e,s,n),this.#e.intMode=r,this.protocol="http"}async execute(e){try{const s=ve(e);let r;const n=this.#e.openStream();try{r=n.query(s)}finally{n.closeGracefully()}return tt(await r)}catch(s){throw O(s)}}async batch(e,s="deferred"){try{const r=e.map(ve),n=await this.#e.getVersion();let i;const o=this.#e.openStream();try{new kt(o,lr).apply(r);const l=o.batch(!1);i=or(s,n,l,r)}finally{o.closeGracefully()}return await i}catch(r){throw O(r)}}async transaction(e="write"){try{const s=await this.#e.getVersion();return new Vi(this.#e.openStream(),e,s)}catch(s){throw O(s)}}async executeMultiple(e){try{let s;const r=this.#e.openStream();try{s=r.sequence(e)}finally{r.closeGracefully()}await s}catch(s){throw O(s)}}sync(){throw new _("sync not supported in http mode","SYNC_NOT_SUPPORTED")}close(){this.#e.close()}get closed(){return this.#e.closed}}class Vi extends ir{#e;#t;constructor(e,s,r){super(s,r),this.#e=e,this.#t=new kt(e,lr)}_getStream(){return this.#e}_getSqlCache(){return this.#t}close(){this.#e.close()}get closed(){return this.#e.closed}}function zi(t){return Ki(Kr(t))}function Ki(t){if(t.scheme==="ws"||t.scheme==="wss")return Pi(t);if(t.scheme==="http"||t.scheme==="https")return ji(t);throw new _(`The client that uses Web standard APIs supports only "libsql:", "wss:", "ws:", "https:" and "http:" URLs, got ${JSON.stringify(t.scheme+":")}. For more information, please read ${$e}`,"URL_SCHEME_NOT_SUPPORTED")}const Ji="libsql://metrics-nps-gastongithubb.turso.io",Hi="eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3MjA0MzM2MDEsImlkIjoiYjI2MjM2YmUtYWExYS00YzY4LTk2MDktZDg3NDNhZGUxODViIn0.U3AVybGtI0-CuzB0daVpbDgEw8b3ijc9n2HhK_yvJwx5jtD_ViAqOsUJP2shasHbyqeFT0ATBASmA5RDHdihDA",Ve=zi({url:Ji,authToken:Hi}),f=Symbol.for("drizzle:entityKind");function d(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,f))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let s=t.constructor;if(s)for(;s;){if(f in s&&s[f]===e[f])return!0;s=Object.getPrototypeOf(s)}return!1}class Wi{static[f]="ConsoleLogWriter";write(e){console.log(e)}}class Gi{static[f]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new Wi}logQuery(e,s){const r=s.map(i=>{try{return JSON.stringify(i)}catch{return String(i)}}),n=r.length?` -- params: [${r.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}}class Yi{static[f]="NoopLogger";logQuery(){}}const ze=Symbol.for("drizzle:Name"),at=Symbol.for("drizzle:Schema"),os=Symbol.for("drizzle:Columns"),lt=Symbol.for("drizzle:OriginalName"),ut=Symbol.for("drizzle:BaseName"),as=Symbol.for("drizzle:IsAlias"),ls=Symbol.for("drizzle:ExtraConfigBuilder"),ur=Symbol.for("drizzle:IsDrizzleTable");class m{static[f]="Table";static Symbol={Name:ze,Schema:at,OriginalName:lt,Columns:os,BaseName:ut,IsAlias:as,ExtraConfigBuilder:ls};[ze];[lt];[at];[os];[ut];[as]=!1;[ls]=void 0;[ur]=!0;constructor(e,s,r){this[ze]=this[lt]=e,this[at]=s,this[ut]=r}}function Xi(t){return typeof t=="object"&&t!==null&&ur in t}function ye(t){return t[ze]}class v{constructor(e,s){this.table=e,this.config=s,this.name=s.name,this.notNull=s.notNull,this.default=s.default,this.defaultFn=s.defaultFn,this.hasDefault=s.hasDefault,this.primary=s.primaryKey,this.isUnique=s.isUnique,this.uniqueName=s.uniqueName,this.uniqueType=s.uniqueType,this.dataType=s.dataType,this.columnType=s.columnType}static[f]="Column";name;primary;notNull;default;defaultFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}}const us=Symbol.for("drizzle:PgInlineForeignKeys");class Zi extends m{static[f]="PgTable";static Symbol=Object.assign({},m.Symbol,{InlineForeignKeys:us});[us]=[];[m.Symbol.ExtraConfigBuilder]=void 0}let eo=class{static[f]="PgPrimaryKeyBuilder";columns;name;constructor(e,s){this.columns=e,this.name=s}build(e){return new to(e,this.columns,this.name)}},to=class{constructor(e,s,r){this.table=e,this.columns=s,this.name=r}static[f]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[Zi.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};const k=Symbol.for("drizzle:SubqueryConfig");class X{static[f]="Subquery";[k];constructor(e,s,r,n=!1){this[k]={sql:e,selection:s,alias:r,isWith:n}}}class cr extends X{static[f]="WithSubquery"}const so={startActiveSpan(t,e){return e()}},j=Symbol.for("drizzle:ViewBaseConfig");function hr(t){return typeof t=="object"&&t!==null&&"getSQL"in t&&typeof t.getSQL=="function"}function ro(t){const e={sql:"",params:[]};for(const s of t)e.sql+=s.sql,e.params.push(...s.params),s.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...s.typings));return e}class B{static[f]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new y([this])}}class y{constructor(e){this.queryChunks=e}static[f]="SQL";decoder=dr;shouldInlineParams=!1;append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return so.startActiveSpan("drizzle.buildSQL",s=>{const r=this.buildQueryFromSourceParams(this.queryChunks,e);return s?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(e,s){const r=Object.assign({},s,{inlineParams:s.inlineParams||this.shouldInlineParams,paramStartIndex:s.paramStartIndex||{value:0}}),{escapeName:n,escapeParam:i,prepareTyping:o,inlineParams:a,paramStartIndex:l}=r;return ro(e.map(c=>{if(d(c,B))return{sql:c.value.join(""),params:[]};if(d(c,qt))return{sql:n(c.value),params:[]};if(c===void 0)return{sql:"",params:[]};if(Array.isArray(c)){const h=[new B("(")];for(const[p,w]of c.entries())h.push(w),p<c.length-1&&h.push(new B(", "));return h.push(new B(")")),this.buildQueryFromSourceParams(h,r)}if(d(c,y))return this.buildQueryFromSourceParams(c.queryChunks,{...r,inlineParams:a||c.shouldInlineParams});if(d(c,m)){const h=c[m.Symbol.Schema],p=c[m.Symbol.Name];return{sql:h===void 0?n(p):n(h)+"."+n(p),params:[]}}if(d(c,v))return{sql:n(c.table[m.Symbol.Name])+"."+n(c.name),params:[]};if(d(c,Ne)){const h=c[j].schema,p=c[j].name;return{sql:h===void 0?n(p):n(h)+"."+n(p),params:[]}}if(d(c,le)){const h=c.value===null?null:c.encoder.mapToDriverValue(c.value);if(d(h,y))return this.buildQueryFromSourceParams([h],r);if(a)return{sql:this.mapInlineParam(h,r),params:[]};let p;return o!==void 0&&(p=[o(c.encoder)]),{sql:i(l.value++,h),params:[h],typings:p}}return d(c,st)?{sql:i(l.value++,c),params:[c]}:d(c,y.Aliased)&&c.fieldAlias!==void 0?{sql:n(c.fieldAlias),params:[]}:d(c,X)?c[k].isWith?{sql:n(c[k].alias),params:[]}:this.buildQueryFromSourceParams([new B("("),c[k].sql,new B(") "),new qt(c[k].alias)],r):hr(c)?this.buildQueryFromSourceParams([new B("("),c.getSQL(),new B(")")],r):a?{sql:this.mapInlineParam(c,r),params:[]}:{sql:i(l.value++,c),params:[c]}}))}mapInlineParam(e,{escapeString:s}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return s(e);if(typeof e=="object"){const r=e.toString();return s(r==="[object Object]"?JSON.stringify(e):r)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new y.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}}class qt{constructor(e){this.value=e}static[f]="Name";brand;getSQL(){return new y([this])}}function no(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}const dr={mapFromDriverValue:t=>t},fr={mapToDriverValue:t=>t};({...dr,...fr});class le{constructor(e,s=fr){this.value=e,this.encoder=s}static[f]="Param";brand;getSQL(){return new y([this])}}function u(t,...e){const s=[];(e.length>0||t.length>0&&t[0]!=="")&&s.push(new B(t[0]));for(const[r,n]of e.entries())s.push(n,new B(t[r+1]));return new y(s)}(t=>{function e(){return new y([])}t.empty=e;function s(l){return new y(l)}t.fromList=s;function r(l){return new y([new B(l)])}t.raw=r;function n(l,c){const h=[];for(const[p,w]of l.entries())p>0&&c!==void 0&&h.push(c),h.push(w);return new y(h)}t.join=n;function i(l){return new qt(l)}t.identifier=i;function o(l){return new st(l)}t.placeholder=o;function a(l,c){return new le(l,c)}t.param=a})(u||(u={}));(t=>{class e{constructor(r,n){this.sql=r,this.fieldAlias=n}static[f]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(y||(y={}));class st{constructor(e){this.name=e}static[f]="Placeholder";getSQL(){return new y([this])}}function De(t,e){return t.map(s=>{if(d(s,st)){if(!(s.name in e))throw new Error(`No value for placeholder "${s.name}" was provided`);return e[s.name]}return s})}class Ne{static[f]="View";[j];constructor({name:e,schema:s,selectedFields:r,query:n}){this[j]={name:e,originalName:e,schema:s,selectedFields:r,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new y([this])}}v.prototype.getSQL=function(){return new y([this])};m.prototype.getSQL=function(){return new y([this])};X.prototype.getSQL=function(){return new y([this])};function F(t,e){return no(e)&&!hr(t)&&!d(t,le)&&!d(t,st)&&!d(t,v)&&!d(t,m)&&!d(t,Ne)?new le(t,e):t}const pr=(t,e)=>u`${t} = ${F(e,t)}`,io=(t,e)=>u`${t} <> ${F(e,t)}`;function Rt(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new y(e):new y([new B("("),u.join(e,new B(" and ")),new B(")")])}function oo(...t){const e=t.filter(s=>s!==void 0);if(e.length!==0)return e.length===1?new y(e):new y([new B("("),u.join(e,new B(" or ")),new B(")")])}function ao(t){return u`not ${t}`}const lo=(t,e)=>u`${t} > ${F(e,t)}`,uo=(t,e)=>u`${t} >= ${F(e,t)}`,co=(t,e)=>u`${t} < ${F(e,t)}`,ho=(t,e)=>u`${t} <= ${F(e,t)}`;function fo(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("inArray requires at least one value");return u`${t} in ${e.map(s=>F(s,t))}`}return u`${t} in ${F(e,t)}`}function po(t,e){if(Array.isArray(e)){if(e.length===0)throw new Error("notInArray requires at least one value");return u`${t} not in ${e.map(s=>F(s,t))}`}return u`${t} not in ${F(e,t)}`}function mo(t){return u`${t} is null`}function yo(t){return u`${t} is not null`}function wo(t){return u`exists ${t}`}function bo(t){return u`not exists ${t}`}function go(t,e,s){return u`${t} between ${F(e,t)} and ${F(s,t)}`}function So(t,e,s){return u`${t} not between ${F(e,t)} and ${F(s,t)}`}function _o(t,e){return u`${t} like ${e}`}function qo(t,e){return u`${t} not like ${e}`}function Ro(t,e){return u`${t} ilike ${e}`}function To(t,e){return u`${t} not ilike ${e}`}function xo(t){return u`${t} asc`}function No(t){return u`${t} desc`}class mr{constructor(e,s,r){this.sourceTable=e,this.referencedTable=s,this.relationName=r,this.referencedTableName=s[m.Symbol.Name]}static[f]="Relation";referencedTableName;fieldName}class Co{constructor(e,s){this.table=e,this.config=s}static[f]="Relations"}class ue extends mr{constructor(e,s,r,n){super(e,s,r?.relationName),this.config=r,this.isNullable=n}static[f]="One";withFieldName(e){const s=new ue(this.sourceTable,this.referencedTable,this.config,this.isNullable);return s.fieldName=e,s}}class rt extends mr{constructor(e,s,r){super(e,s,r?.relationName),this.config=r}static[f]="Many";withFieldName(e){const s=new rt(this.sourceTable,this.referencedTable,this.config);return s.fieldName=e,s}}function Io(){return{and:Rt,between:go,eq:pr,exists:wo,gt:lo,gte:uo,ilike:Ro,inArray:fo,isNull:mo,isNotNull:yo,like:_o,lt:co,lte:ho,ne:io,not:ao,notBetween:So,notExists:bo,notLike:qo,notIlike:To,notInArray:po,or:oo,sql:u}}function Eo(){return{sql:u,asc:xo,desc:No}}function Lo(t,e){Object.keys(t).length===1&&"default"in t&&!d(t.default,m)&&(t=t.default);const s={},r={},n={};for(const[i,o]of Object.entries(t))if(Xi(o)){const a=o[m.Symbol.Name],l=r[a];s[a]=i,n[i]={tsName:i,dbName:o[m.Symbol.Name],schema:o[m.Symbol.Schema],columns:o[m.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(const h of Object.values(o[m.Symbol.Columns]))h.primary&&n[i].primaryKey.push(h);const c=o[m.Symbol.ExtraConfigBuilder]?.(o);if(c)for(const h of Object.values(c))d(h,eo)&&n[i].primaryKey.push(...h.columns)}else if(d(o,Co)){const a=o.table[m.Symbol.Name],l=s[a],c=o.config(e(o.table));let h;for(const[p,w]of Object.entries(c))if(l){const q=n[l];q.relations[p]=w}else a in r||(r[a]={relations:{},primaryKey:h}),r[a].relations[p]=w}return{tables:n,tableNamesMap:s}}function Ao(t){return function(s,r){return new ue(t,s,r,r?.fields.reduce((n,i)=>n&&i.notNull,!0)??!1)}}function $o(t){return function(s,r){return new rt(t,s,r)}}function Oo(t,e,s){if(d(s,ue)&&s.config)return{fields:s.config.fields,references:s.config.references};const r=e[s.referencedTable[m.Symbol.Name]];if(!r)throw new Error(`Table "${s.referencedTable[m.Symbol.Name]}" not found in schema`);const n=t[r];if(!n)throw new Error(`Table "${r}" not found in schema`);const i=s.sourceTable,o=e[i[m.Symbol.Name]];if(!o)throw new Error(`Table "${i[m.Symbol.Name]}" not found in schema`);const a=[];for(const l of Object.values(n.relations))(s.relationName&&s!==l&&l.relationName===s.relationName||!s.relationName&&l.referencedTable===s.sourceTable)&&a.push(l);if(a.length>1)throw s.relationName?new Error(`There are multiple relations with name "${s.relationName}" in table "${r}"`):new Error(`There are multiple relations between "${r}" and "${s.sourceTable[m.Symbol.Name]}". Please specify relation name`);if(a[0]&&d(a[0],ue)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${s.fieldName}"`)}function vo(t){return{one:Ao(t),many:$o(t)}}function Tt(t,e,s,r,n=i=>i){const i={};for(const[o,a]of r.entries())if(a.isJson){const l=e.relations[a.tsKey],c=s[o],h=typeof c=="string"?JSON.parse(c):c;i[a.tsKey]=d(l,ue)?h&&Tt(t,t[a.relationTableTsKey],h,a.selection,n):h.map(p=>Tt(t,t[a.relationTableTsKey],p,a.selection,n))}else{const l=n(s[o]),c=a.field;let h;d(c,v)?h=c:d(c,y)?h=c.decoder:h=c.sql.decoder,i[a.tsKey]=l===null?null:h.mapFromDriverValue(l)}return i}class Ye{constructor(e){this.table=e}static[f]="ColumnAliasProxyHandler";get(e,s){return s==="table"?this.table:e[s]}}class Dt{constructor(e,s){this.alias=e,this.replaceOriginalName=s}static[f]="TableAliasProxyHandler";get(e,s){if(s===m.Symbol.IsAlias)return!0;if(s===m.Symbol.Name)return this.alias;if(this.replaceOriginalName&&s===m.Symbol.OriginalName)return this.alias;if(s===j)return{...e[j],name:this.alias,isAlias:!0};if(s===m.Symbol.Columns){const n=e[m.Symbol.Columns];if(!n)return n;const i={};return Object.keys(n).map(o=>{i[o]=new Proxy(n[o],new Ye(new Proxy(e,this)))}),i}const r=e[s];return d(r,v)?new Proxy(r,new Ye(new Proxy(e,this))):r}}function ct(t,e){return new Proxy(t,new Dt(e,!1))}function ee(t,e){return new Proxy(t,new Ye(new Proxy(t.table,new Dt(e,!1))))}function yr(t,e){return new y.Aliased(Xe(t.sql,e),t.fieldAlias)}function Xe(t,e){return u.join(t.queryChunks.map(s=>d(s,v)?ee(s,e):d(s,y)?Xe(s,e):d(s,y.Aliased)?yr(s,e):s))}class J{static[f]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,s){if(s===k)return{...e[k],selection:new Proxy(e[k].selection,this)};if(s===j)return{...e[j],selectedFields:new Proxy(e[j].selectedFields,this)};if(typeof s=="symbol")return e[s];const n=(d(e,X)?e[k].selection:d(e,Ne)?e[j].selectedFields:e)[s];if(d(n,y.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!n.isSelectionField)return n.sql;const i=n.clone();return i.isSelectionField=!0,i}if(d(n,y)){if(this.config.sqlBehavior==="sql")return n;throw new Error(`You tried to reference "${s}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return d(n,v)?this.config.alias?new Proxy(n,new Ye(new Proxy(n.table,new Dt(this.config.alias,this.config.replaceOriginalName??!1)))):n:typeof n!="object"||n===null?n:new Proxy(n,new J(this.config))}}class de{static[f]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(s=>(e?.(),s),s=>{throw e?.(),s})}then(e,s){return this.execute().then(e,s)}}const xt=Symbol.for("drizzle:SQLiteInlineForeignKeys");class M extends m{static[f]="SQLiteTable";static Symbol=Object.assign({},m.Symbol,{InlineForeignKeys:xt});[m.Symbol.Columns];[xt]=[];[m.Symbol.ExtraConfigBuilder]=void 0}function Qo(t,e,s,r,n=t){const i=new M(t,r,n),o=Object.fromEntries(Object.entries(e).map(([l,c])=>{const h=c,p=h.build(i);return i[xt].push(...h.buildForeignKeys(p,i)),[l,p]})),a=Object.assign(i,o);return a[m.Symbol.Columns]=o,s&&(a[M.Symbol.ExtraConfigBuilder]=s),a}const Mt=(t,e,s)=>Qo(t,e,s);function cs(t,e,s){const r={},n=t.reduce((i,{path:o,field:a},l)=>{let c;d(a,v)?c=a:d(a,y)?c=a.decoder:c=a.sql.decoder;let h=i;for(const[p,w]of o.entries())if(p<o.length-1)w in h||(h[w]={}),h=h[w];else{const q=e[l],R=h[w]=q===null?null:c.mapFromDriverValue(q);if(s&&d(a,v)&&o.length===2){const x=o[0];x in r?typeof r[x]=="string"&&r[x]!==ye(a.table)&&(r[x]=!1):r[x]=R===null?ye(a.table):!1}}return i},{});if(s&&Object.keys(r).length>0)for(const[i,o]of Object.entries(r))typeof o=="string"&&!s[o]&&(n[i]=null);return n}function ce(t,e){return Object.entries(t).reduce((s,[r,n])=>{if(typeof r!="string")return s;const i=e?[...e,r]:[r];return d(n,v)||d(n,y)||d(n,y.Aliased)?s.push({path:i,field:n}):d(n,m)?s.push(...ce(n[m.Symbol.Columns],i)):s.push(...ce(n,i)),s},[])}function wr(t,e){const s=Object.keys(t),r=Object.keys(e);if(s.length!==r.length)return!1;for(const[n,i]of s.entries())if(i!==r[n])return!1;return!0}function br(t,e){const s=Object.entries(e).filter(([,r])=>r!==void 0).map(([r,n])=>d(n,y)?[r,n]:[r,new le(n,t[m.Symbol.Columns][r])]);if(s.length===0)throw new Error("No values to set");return Object.fromEntries(s)}function Bo(t,e){for(const s of e)for(const r of Object.getOwnPropertyNames(s.prototype))r!=="constructor"&&Object.defineProperty(t.prototype,r,Object.getOwnPropertyDescriptor(s.prototype,r)||Object.create(null))}function Po(t){return t[m.Symbol.Columns]}function hs(t){return d(t,X)?t[k].alias:d(t,Ne)?t[j].name:d(t,y)?void 0:t[m.Symbol.IsAlias]?t[m.Symbol.Name]:t[m.Symbol.BaseName]}class ds extends de{constructor(e,s,r,n){super(),this.table=e,this.session=s,this.dialect=r,this.config={table:e,withList:n}}static[f]="SQLiteDelete";config;where(e){return this.config.where=e,this}returning(e=this.table[M.Symbol.Columns]){return this.config.returning=ce(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}}class fs{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[f]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");const s=e.map(r=>{const n={},i=this.table[m.Symbol.Columns];for(const o of Object.keys(r)){const a=r[o];n[o]=d(a,y)?a:new le(a,i[o])}return n});return new Uo(this.table,s,this.session,this.dialect,this.withList)}}class Uo extends de{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={table:e,values:s,withList:i}}static[f]="SQLiteInsert";config;returning(e=this.config.table[M.Symbol.Columns]){return this.config.returning=ce(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=u`do nothing`;else{const s=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,r=e.where?u` where ${e.where}`:u``;this.config.onConflict=u`${s} do nothing${r}`}return this}onConflictDoUpdate(e){const s=Array.isArray(e.target)?u`${e.target}`:u`${[e.target]}`,r=e.where?u` where ${e.where}`:u``,n=this.dialect.buildUpdateSet(this.config.table,br(this.config.table,e.set));return this.config.onConflict=u`${s} do update set ${n}${r}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class jt extends Error{static[f]="DrizzleError";constructor({message:e,cause:s}){super(e),this.name="DrizzleError",this.cause=s}}class ko extends jt{static[f]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class Do{static[f]="ColumnBuilder";config;constructor(e,s,r){this.config={name:e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:s,columnType:r}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}}class Mo{static[f]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,s){this.reference=()=>{const{name:r,columns:n,foreignColumns:i}=e();return{name:r,columns:n,foreignTable:i[0].table,foreignColumns:i}},s&&(this._onUpdate=s.onUpdate,this._onDelete=s.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new jo(e,this)}}class jo{constructor(e,s){this.table=e,this.reference=s.reference,this.onUpdate=s._onUpdate,this.onDelete=s._onDelete}static[f]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){const{name:e,columns:s,foreignColumns:r}=this.reference(),n=s.map(a=>a.name),i=r.map(a=>a.name),o=[this.table[M.Symbol.Name],...n,r[0].table[M.Symbol.Name],...i];return e??`${o.join("_")}_fk`}}function Fo(t,e){return`${t[M.Symbol.Name]}_${e.join("_")}_unique`}class Ft extends Do{static[f]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,s={}){return this.foreignKeyConfigs.push({ref:e,actions:s}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}buildForeignKeys(e,s){return this.foreignKeyConfigs.map(({ref:r,actions:n})=>((i,o)=>{const a=new Mo(()=>{const l=i();return{columns:[e],foreignColumns:[l]}});return o.onUpdate&&a.onUpdate(o.onUpdate),o.onDelete&&a.onDelete(o.onDelete),a.build(s)})(r,n))}}class be extends v{constructor(e,s){s.uniqueName||(s.uniqueName=Fo(e,[s.name])),super(e,s),this.table=e}static[f]="SQLiteColumn"}class Vt extends Ft{static[f]="SQLiteBaseIntegerBuilder";constructor(e,s,r){super(e,s,r),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}}class zt extends be{static[f]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}}class Vo extends Vt{static[f]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new zo(e,this.config)}}class zo extends zt{static[f]="SQLiteInteger"}class Ko extends Vt{static[f]="SQLiteTimestampBuilder";constructor(e,s){super(e,"date","SQLiteTimestamp"),this.config.mode=s}defaultNow(){return this.default(u`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new Jo(e,this.config)}}class Jo extends zt{static[f]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){const s=e.getTime();return this.config.mode==="timestamp"?Math.floor(s/1e3):s}}class Ho extends Vt{static[f]="SQLiteBooleanBuilder";constructor(e,s){super(e,"boolean","SQLiteBoolean"),this.config.mode=s}build(e){return new Wo(e,this.config)}}class Wo extends zt{static[f]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}}function z(t,e){return e?.mode==="timestamp"||e?.mode==="timestamp_ms"?new Ko(t,e.mode):e?.mode==="boolean"?new Ho(t,e.mode):new Vo(t)}class Go extends Ft{static[f]="SQLiteTextBuilder";constructor(e,s){super(e,"string","SQLiteText"),this.config.enumValues=s.enum,this.config.length=s.length}build(e){return new Yo(e,this.config)}}class Yo extends be{static[f]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,s){super(e,s)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}}class Xo extends Ft{static[f]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new Zo(e,this.config)}}class Zo extends be{static[f]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}}function H(t,e={}){return e.mode==="json"?new Xo(t):new Go(t,e)}class gr extends Ne{static[f]="SQLiteViewBase"}class Sr{static[f]="SQLiteDialect";escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;const s=[u`with `];for(const[r,n]of e.entries())s.push(u`${u.identifier(n[k].alias)} as (${n[k].sql})`),r<e.length-1&&s.push(u`, `);return s.push(u` `),u.join(s)}buildDeleteQuery({table:e,where:s,returning:r,withList:n}){const i=this.buildWithCTE(n),o=r?u` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,a=s?u` where ${s}`:void 0;return u`${i}delete from ${e}${a}${o}`}buildUpdateSet(e,s){const r=Object.entries(s),n=r.length;return u.join(r.flatMap(([i,o],a)=>{const l=e[m.Symbol.Columns][i],c=u`${u.identifier(l.name)} = ${o}`;return a<n-1?[c,u.raw(", ")]:[c]}))}buildUpdateQuery({table:e,set:s,where:r,returning:n,withList:i}){const o=this.buildWithCTE(i),a=this.buildUpdateSet(e,s),l=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,c=r?u` where ${r}`:void 0;return u`${o}update ${e} set ${a}${c}${l}`}buildSelection(e,{isSingleTable:s=!1}={}){const r=e.length,n=e.flatMap(({field:i},o)=>{const a=[];if(d(i,y.Aliased)&&i.isSelectionField)a.push(u.identifier(i.fieldAlias));else if(d(i,y.Aliased)||d(i,y)){const l=d(i,y.Aliased)?i.sql:i;s?a.push(new y(l.queryChunks.map(c=>d(c,v)?u.identifier(c.name):c))):a.push(l),d(i,y.Aliased)&&a.push(u` as ${u.identifier(i.fieldAlias)}`)}else if(d(i,v)){const l=i.table[m.Symbol.Name],c=i.name;s?a.push(u.identifier(c)):a.push(u`${u.identifier(l)}.${u.identifier(c)}`)}return o<r-1&&a.push(u`, `),a});return u.join(n)}buildSelectQuery({withList:e,fields:s,fieldsFlat:r,where:n,having:i,table:o,joins:a,orderBy:l,groupBy:c,limit:h,offset:p,distinct:w,setOperators:q}){const R=r??ce(s);for(const U of R)if(d(U.field,v)&&ye(U.field.table)!==(d(o,X)?o[k].alias:d(o,gr)?o[j].name:d(o,y)?void 0:ye(o))&&!(A=>a?.some(({alias:Z})=>Z===(A[m.Symbol.IsAlias]?ye(A):A[m.Symbol.BaseName])))(U.field.table)){const A=ye(U.field.table);throw new Error(`Your "${U.path.join("->")}" field references a column "${A}"."${U.field.name}", but the table "${A}" is not part of the query! Did you forget to join it?`)}const x=!a||a.length===0,I=this.buildWithCTE(e),E=w?u` distinct`:void 0,L=this.buildSelection(R,{isSingleTable:x}),$=d(o,m)&&o[m.Symbol.OriginalName]!==o[m.Symbol.Name]?u`${u.identifier(o[m.Symbol.OriginalName])} ${u.identifier(o[m.Symbol.Name])}`:o,T=[];if(a)for(const[U,A]of a.entries()){U===0&&T.push(u` `);const Z=A.table;if(d(Z,M)){const ot=Z[M.Symbol.Name],Wt=Z[M.Symbol.Schema],Gt=Z[M.Symbol.OriginalName],Yt=ot===Gt?void 0:A.alias;T.push(u`${u.raw(A.joinType)} join ${Wt?u`${u.identifier(Wt)}.`:void 0}${u.identifier(Gt)}${Yt&&u` ${u.identifier(Yt)}`} on ${A.on}`)}else T.push(u`${u.raw(A.joinType)} join ${Z} on ${A.on}`);U<a.length-1&&T.push(u` `)}const te=u.join(T),fe=n?u` where ${n}`:void 0,g=i?u` having ${i}`:void 0,S=[];if(l)for(const[U,A]of l.entries())S.push(A),U<l.length-1&&S.push(u`, `);const V=[];if(c)for(const[U,A]of c.entries())V.push(A),U<c.length-1&&V.push(u`, `);const Be=V.length>0?u` group by ${u.join(V)}`:void 0,it=S.length>0?u` order by ${u.join(S)}`:void 0,Ce=h?u` limit ${h}`:void 0,Pe=p?u` offset ${p}`:void 0,Ue=u`${I}select${E} ${L} from ${$}${te}${fe}${Be}${g}${it}${Ce}${Pe}`;return q.length>0?this.buildSetOperations(Ue,q):Ue}buildSetOperations(e,s){const[r,...n]=s;if(!r)throw new Error("Cannot pass undefined values to any set operator");return n.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:r}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:r}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:s,isAll:r,rightSelect:n,limit:i,orderBy:o,offset:a}}){const l=u`${e.getSQL()} `,c=u`${n.getSQL()}`;let h;if(o&&o.length>0){const R=[];for(const x of o)if(d(x,be))R.push(u.identifier(x.name));else if(d(x,y)){for(let I=0;I<x.queryChunks.length;I++){const E=x.queryChunks[I];d(E,be)&&(x.queryChunks[I]=u.identifier(E.name))}R.push(u`${x}`)}else R.push(u`${x}`);h=u` order by ${u.join(R,u`, `)}`}const p=i?u` limit ${i}`:void 0,w=u.raw(`${s} ${r?"all ":""}`),q=a?u` offset ${a}`:void 0;return u`${l}${w}${c}${h}${p}${q}`}buildInsertQuery({table:e,values:s,onConflict:r,returning:n,withList:i}){const o=[],a=e[m.Symbol.Columns],l=Object.entries(a),c=l.map(([,R])=>u.identifier(R.name));for(const[R,x]of s.entries()){const I=[];for(const[E,L]of l){const $=x[E];if($===void 0||d($,le)&&$.value===void 0){let T;if(L.default!==null&&L.default!==void 0)T=d(L.default,y)?L.default:u.param(L.default,L);else if(L.defaultFn!==void 0){const te=L.defaultFn();T=d(te,y)?te:u.param(te,L)}else T=u`null`;I.push(T)}else I.push($)}o.push(I),R<s.length-1&&o.push(u`, `)}const h=this.buildWithCTE(i),p=u.join(o),w=n?u` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,q=r?u` on conflict ${r}`:void 0;return u`${h}insert into ${e} ${c} values ${p}${q}${w}`}sqlToQuery(e){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString})}buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:n,tableConfig:i,queryConfig:o,tableAlias:a,nestedQueryRelation:l,joinOn:c}){let h=[],p,w,q=[],R;const x=[];if(o===!0)h=Object.entries(i.columns).map(([L,$])=>({dbKey:$.name,tsKey:L,field:ee($,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{const E=Object.fromEntries(Object.entries(i.columns).map(([g,S])=>[g,ee(S,a)]));if(o.where){const g=typeof o.where=="function"?o.where(E,Io()):o.where;R=g&&Xe(g,a)}const L=[];let $=[];if(o.columns){let g=!1;for(const[S,V]of Object.entries(o.columns))V!==void 0&&S in i.columns&&(!g&&V===!0&&(g=!0),$.push(S));$.length>0&&($=g?$.filter(S=>o.columns?.[S]===!0):Object.keys(i.columns).filter(S=>!$.includes(S)))}else $=Object.keys(i.columns);for(const g of $){const S=i.columns[g];L.push({tsKey:g,value:S})}let T=[];o.with&&(T=Object.entries(o.with).filter(g=>!!g[1]).map(([g,S])=>({tsKey:g,queryConfig:S,relation:i.relations[g]})));let te;if(o.extras){te=typeof o.extras=="function"?o.extras(E,{sql:u}):o.extras;for(const[g,S]of Object.entries(te))L.push({tsKey:g,value:yr(S,a)})}for(const{tsKey:g,value:S}of L)h.push({dbKey:d(S,y.Aliased)?S.fieldAlias:i.columns[g].name,tsKey:g,field:d(S,v)?ee(S,a):S,relationTableTsKey:void 0,isJson:!1,selection:[]});let fe=typeof o.orderBy=="function"?o.orderBy(E,Eo()):o.orderBy??[];Array.isArray(fe)||(fe=[fe]),q=fe.map(g=>d(g,v)?ee(g,a):Xe(g,a)),p=o.limit,w=o.offset;for(const{tsKey:g,queryConfig:S,relation:V}of T){const Be=Oo(s,r,V),it=V.referencedTable[m.Symbol.Name],Ce=r[it],Pe=`${a}_${g}`,Ue=Rt(...Be.fields.map((Z,ot)=>pr(ee(Be.references[ot],Pe),ee(Z,a)))),U=this.buildRelationalQuery({fullSchema:e,schema:s,tableNamesMap:r,table:e[Ce],tableConfig:s[Ce],queryConfig:d(V,ue)?S===!0?{limit:1}:{...S,limit:1}:S,tableAlias:Pe,joinOn:Ue,nestedQueryRelation:V}),A=u`(${U.sql})`.as(g);h.push({dbKey:g,tsKey:g,field:A,relationTableTsKey:Ce,isJson:!0,selection:U.selection})}}if(h.length===0)throw new jt({message:`No fields selected for table "${i.tsName}" ("${a}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let I;if(R=Rt(c,R),l){let E=u`json_array(${u.join(h.map(({field:T})=>d(T,be)?u.identifier(T.name):d(T,y.Aliased)?T.sql:T),u`, `)})`;d(l,rt)&&(E=u`coalesce(json_group_array(${E}), json_array())`);const L=[{dbKey:"data",tsKey:"data",field:E.as("data"),isJson:!0,relationTableTsKey:i.tsName,selection:h}];p!==void 0||w!==void 0||q.length>0?(I=this.buildSelectQuery({table:ct(n,a),fields:{},fieldsFlat:[{path:[],field:u.raw("*")}],where:R,limit:p,offset:w,orderBy:q,setOperators:[]}),R=void 0,p=void 0,w=void 0,q=void 0):I=ct(n,a),I=this.buildSelectQuery({table:d(I,M)?I:new X(I,{},a),fields:{},fieldsFlat:L.map(({field:T})=>({path:[],field:d(T,v)?ee(T,a):T})),joins:x,where:R,limit:p,offset:w,orderBy:q,setOperators:[]})}else I=this.buildSelectQuery({table:ct(n,a),fields:{},fieldsFlat:h.map(({field:E})=>({path:[],field:d(E,v)?ee(E,a):E})),joins:x,where:R,limit:p,offset:w,orderBy:q,setOperators:[]});return{tableTsKey:i.tsName,sql:I,selection:h}}}class ea extends Sr{static[f]="SQLiteSyncDialect";migrate(e,s,r){const n=r===void 0||typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;s.run(i);const a=s.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;s.run(u`BEGIN`);try{for(const l of e)if(!a||Number(a[2])<l.folderMillis){for(const c of l.sql)s.run(u.raw(c));s.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${l.hash}, ${l.folderMillis})`)}s.run(u`COMMIT`)}catch(l){throw s.run(u`ROLLBACK`),l}}}class ta extends Sr{static[f]="SQLiteAsyncDialect";async migrate(e,s,r){const n=typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i=u`
			CREATE TABLE IF NOT EXISTS ${u.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await s.run(i);const a=(await s.values(u`SELECT id, hash, created_at FROM ${u.identifier(n)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await s.transaction(async l=>{for(const c of e)if(!a||Number(a[2])<c.folderMillis){for(const h of c.sql)await l.run(u.raw(h));await l.run(u`INSERT INTO ${u.identifier(n)} ("hash", "created_at") VALUES(${c.hash}, ${c.folderMillis})`)}})}}class sa{static[f]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class se{static[f]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){const s=!!this.fields;let r;return this.fields?r=this.fields:d(e,X)?r=Object.fromEntries(Object.keys(e[k].selection).map(n=>[n,e[n]])):d(e,gr)?r=e[j].selectedFields:d(e,y)?r={}:r=Po(e),new _r({table:e,fields:r,isPartialSelect:s,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}}class ra extends sa{static[f]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:s,isPartialSelect:r,session:n,dialect:i,withList:o,distinct:a}){super(),this.config={withList:o,table:e,fields:{...s},distinct:a,setOperators:[]},this.isPartialSelect=r,this.session=n,this.dialect=i,this._={selectedFields:s},this.tableName=hs(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}createJoin(e){return(s,r)=>{const n=this.tableName,i=hs(s);if(typeof i=="string"&&this.config.joins?.some(o=>o.alias===i))throw new Error(`Alias "${i}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof i=="string"&&!d(s,y))){const o=d(s,X)?s[k].selection:d(s,Ne)?s[j].selectedFields:s[m.Symbol.Columns];this.config.fields[i]=o}if(typeof r=="function"&&(r=r(new Proxy(this.config.fields,new J({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:r,table:s,joinType:e,alias:i}),typeof i=="string")switch(e){case"left":{this.joinsNotNullableMap[i]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!0;break}case"inner":{this.joinsNotNullableMap[i]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");createSetOperator(e,s){return r=>{const n=typeof r=="function"?r(na()):r;if(!wr(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:s,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new J({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new J({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new J({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(s)?s:[s]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){const s=e[0](new Proxy(this.config.fields,new J({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),r=Array.isArray(s)?s:[s];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}else{const s=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}as(e){return new Proxy(new X(this.getSQL(),this.config.fields,e),new J({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new J({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class _r extends ra{static[f]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const s=ce(this.config.fields),r=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),s,"all");return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}}Bo(_r,[de]);function nt(t,e){return(s,r,...n)=>{const i=[r,...n].map(o=>({type:t,isAll:e,rightSelect:o}));for(const o of i)if(!wr(s.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return s.addSetOperators(i)}}const na=()=>({union:ia,unionAll:oa,intersect:aa,except:la}),ia=nt("union",!1),oa=nt("union",!0),aa=nt("intersect",!1),la=nt("except",!1);class ua{static[f]="SQLiteQueryBuilder";dialect;$with(e){const s=this;return{as(r){return typeof r=="function"&&(r=r(s)),new Proxy(new cr(r.getSQL(),r.getSelectedFields(),e,!0),new J({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(i){return new se({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e})}function n(i){return new se({fields:i??void 0,session:void 0,dialect:s.getDialect(),withList:e,distinct:!0})}return{select:r,selectDistinct:n}}select(e){return new se({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new se({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new ea),this.dialect}}class ps{constructor(e,s,r,n){this.table=e,this.session=s,this.dialect=r,this.withList=n}static[f]="SQLiteUpdateBuilder";set(e){return new ca(this.table,br(this.table,e),this.session,this.dialect,this.withList)}}class ca extends de{constructor(e,s,r,n,i){super(),this.session=r,this.dialect=n,this.config={set:s,table:e,withList:i}}static[f]="SQLiteUpdate";config;where(e){return this.config.where=e,this}returning(e=this.config.table[M.Symbol.Columns]){return this.config.returning=ce(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...s}=this.dialect.sqlToQuery(this.getSQL());return s}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run")}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class ha{constructor(e,s,r,n,i,o,a,l){this.mode=e,this.fullSchema=s,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=o,this.dialect=a,this.session=l}static[f]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new ms(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new Nt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new ms(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new Nt(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}}class Nt extends de{constructor(e,s,r,n,i,o,a,l,c){super(),this.fullSchema=e,this.schema=s,this.tableNamesMap=r,this.table=n,this.tableConfig=i,this.dialect=o,this.session=a,this.config=l,this.mode=c}static[f]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){const{query:s,builtQuery:r}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](r,void 0,this.mode==="first"?"get":"all",(n,i)=>{const o=n.map(a=>Tt(this.schema,this.tableConfig,a,s.selection,i));return this.mode==="first"?o[0]:o})}prepare(){return this._prepare(!1)}_toSQL(){const e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),s=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:s}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}}class ms extends Nt{static[f]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}}class Me extends de{constructor(e,s,r,n,i){super(),this.execute=e,this.getSQL=s,this.dialect=n,this.mapBatchResult=i,this.config={action:r}}static[f]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,s){return s?this.mapBatchResult(e):e}_prepare(){return this}}class qr{constructor(e,s,r,n){this.resultKind=e,this.dialect=s,this.session=r,this._=n?{schema:n.schema,tableNamesMap:n.tableNamesMap}:{schema:void 0,tableNamesMap:{}},this.query={};const i=this.query;if(this._.schema)for(const[o,a]of Object.entries(this._.schema))i[o]=new ha(e,n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[o],a,s,r)}static[f]="BaseSQLiteDatabase";query;$with(e){return{as(s){return typeof s=="function"&&(s=s(new ua)),new Proxy(new cr(s.getSQL(),s.getSelectedFields(),e,!0),new J({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}}with(...e){const s=this;function r(l){return new se({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e})}function n(l){return new se({fields:l??void 0,session:s.session,dialect:s.dialect,withList:e,distinct:!0})}function i(l){return new ps(l,s.session,s.dialect,e)}function o(l){return new fs(l,s.session,s.dialect,e)}function a(l){return new ds(l,s.session,s.dialect,e)}return{select:r,selectDistinct:n,update:i,insert:o,delete:a}}select(e){return new se({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new se({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new ps(e,this.session,this.dialect)}insert(e){return new fs(e,this.session,this.dialect)}delete(e){return new ds(e,this.session,this.dialect)}run(e){const s=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.run(s),()=>s,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(s)}all(e){const s=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.all(s),()=>s,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(s)}get(e){const s=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.get(s),()=>s,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(s)}values(e){const s=e.getSQL();return this.resultKind==="async"?new Me(async()=>this.session.values(s),()=>s,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(s)}transaction(e,s){return this.session.transaction(e,s)}}function da(...t){return t[0].columns?new ys(t[0].columns,t[0].name):new ys(t)}class ys{static[f]="SQLitePrimaryKeyBuilder";columns;name;constructor(e,s){this.columns=e,this.name=s}build(e){return new fa(e,this.columns,this.name)}}class fa{constructor(e,s,r){this.table=e,this.columns=s,this.name=r}static[f]="SQLitePrimaryKey";columns;name;getName(){return this.name??`${this.table[M.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}}class pa extends de{constructor(e){super(),this.resultCb=e}static[f]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}}class ma{constructor(e,s,r){this.mode=e,this.executeMethod=s,this.query=r}static[f]="PreparedQuery";joinsNotNullableMap;getQuery(){return this.query}mapRunResult(e,s){return e}mapAllResult(e,s){throw new Error("Not implemented")}mapGetResult(e,s){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new pa(()=>this[this.executeMethod](e))}mapResult(e,s){switch(this.executeMethod){case"run":return this.mapRunResult(e,s);case"all":return this.mapAllResult(e,s);case"get":return this.mapGetResult(e,s)}}}class ya{constructor(e){this.dialect=e}static[f]="SQLiteSession";prepareOneTimeQuery(e,s,r){return this.prepareQuery(e,s,r)}run(e){const s=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(s,void 0,"run").run()}catch(r){throw new jt({cause:r,message:`Failed to run the query '${s.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run").values()}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}}class wa extends qr{constructor(e,s,r,n,i=0){super(e,s,r,n),this.schema=n,this.nestedIndex=i}static[f]="SQLiteTransaction";rollback(){throw new ko}}class Kt extends ya{constructor(e,s,r,n,i){super(s),this.client=e,this.schema=r,this.options=n,this.tx=i,this.logger=n.logger??new Yi}static[f]="LibSQLSession";logger;prepareQuery(e,s,r,n){return new ba(this.client,e,this.logger,s,this.tx,r,n)}async batch(e){const s=[],r=[];for(const i of e){const o=i._prepare(),a=o.getQuery();s.push(o),r.push({sql:a.sql,args:a.params})}return(await this.client.batch(r)).map((i,o)=>s[o].mapResult(i,!0))}async transaction(e,s){const r=await this.client.transaction(),n=new Kt(this.client,this.dialect,this.schema,this.options,r),i=new Jt("async",this.dialect,n,this.schema);try{const o=await e(i);return await r.commit(),o}catch(o){throw await r.rollback(),o}}extractRawAllValueFromBatchResult(e){return e.rows}extractRawGetValueFromBatchResult(e){return e.rows[0]}extractRawValuesValueFromBatchResult(e){return e.rows}}class Jt extends wa{static[f]="LibSQLTransaction";async transaction(e){const s=`sp${this.nestedIndex}`,r=new Jt("async",this.dialect,this.session,this.schema,this.nestedIndex+1);await this.session.run(u.raw(`savepoint ${s}`));try{const n=await e(r);return await this.session.run(u.raw(`release savepoint ${s}`)),n}catch(n){throw await this.session.run(u.raw(`rollback to savepoint ${s}`)),n}}}class ba extends ma{constructor(e,s,r,n,i,o,a){super("async",o,s),this.client=e,this.logger=r,this.fields=n,this.tx=i,this.customResultMapper=a,this.customResultMapper=a,this.fields=n}static[f]="LibSQLPreparedQuery";run(e){const s=De(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return this.tx?this.tx.execute(r):this.client.execute(r)}async all(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const c=De(n.params,e??{});r.logQuery(n.sql,c);const h={sql:n.sql,args:c};return(i?i.execute(h):o.execute(h)).then(({rows:p})=>this.mapAllResult(p))}const l=await this.values(e);return this.mapAllResult(l)}mapAllResult(e,s){return s&&(e=e.rows),!this.fields&&!this.customResultMapper?e.map(r=>ws(r)):this.customResultMapper?this.customResultMapper(e,je):e.map(r=>cs(this.fields,Array.prototype.slice.call(r).map(n=>je(n)),this.joinsNotNullableMap))}async get(e){const{fields:s,logger:r,query:n,tx:i,client:o,customResultMapper:a}=this;if(!s&&!a){const c=De(n.params,e??{});r.logQuery(n.sql,c);const h={sql:n.sql,args:c};return(i?i.execute(h):o.execute(h)).then(({rows:p})=>this.mapGetResult(p))}const l=await this.values(e);return this.mapGetResult(l)}mapGetResult(e,s){s&&(e=e.rows);const r=e[0];if(!this.fields&&!this.customResultMapper)return ws(r);if(r)return this.customResultMapper?this.customResultMapper(e,je):cs(this.fields,Array.prototype.slice.call(r).map(n=>je(n)),this.joinsNotNullableMap)}values(e){const s=De(this.query.params,e??{});this.logger.logQuery(this.query.sql,s);const r={sql:this.query.sql,args:s};return(this.tx?this.tx.execute(r):this.client.execute(r)).then(({rows:n})=>n)}}function ws(t){return Object.keys(t).reduce((e,s)=>(Object.prototype.propertyIsEnumerable.call(t,s)&&(e[s]=t[s]),e),{})}function je(t){if(typeof ArrayBuffer<"u"&&t instanceof ArrayBuffer){if(typeof Buffer<"u")return t instanceof Buffer?t:Buffer.from(t);if(typeof TextDecoder<"u")return new TextDecoder().decode(t);throw new Error("TextDecoder is not available. Please provide either Buffer or TextDecoder polyfill.")}return t}class ga extends qr{static[f]="LibSQLDatabase";async batch(e){return this.session.batch(e)}}function Sa(t,e={}){const s=new ta;let r;e.logger===!0?r=new Gi:e.logger!==!1&&(r=e.logger);let n;if(e.schema){const o=Lo(e.schema,vo);n={fullSchema:e.schema,schema:o.tables,tableNamesMap:o.tableNamesMap}}const i=new Kt(t,s,n,{logger:r},void 0);return new ga("async",s,i,n)}const he=Sa(Ve),Rr=Mt("employees",{id:z("id").primaryKey(),firstName:H("first_name").notNull(),lastName:H("last_name").notNull(),email:H("email").notNull(),dni:H("dni").notNull(),entryTime:H("entry_time").notNull(),exitTime:H("exit_time").notNull(),hoursWorked:z("hours_worked").notNull(),xLite:H("x_lite").notNull()}),Ct=Mt("break_schedules",{id:z("id").primaryKey(),employeeId:z("employee_id").notNull(),day:H("day").notNull(),startTime:H("start_time").notNull(),endTime:H("end_time").notNull(),week:z("week").notNull(),month:z("month").notNull(),year:z("year").notNull()},t=>({uniqueSchedule:da(t.employeeId,t.day,t.week,t.month,t.year)})),Tr=Mt("users",{id:z("id").primaryKey(),name:H("name").notNull(),responses:z("responses").notNull().default(0),nps:z("nps").notNull().default(0),csat:z("csat").notNull().default(0),rd:z("rd").notNull().default(0)});async function Ht(){await Ve.execute(`
    CREATE TABLE IF NOT EXISTS employees (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      first_name TEXT NOT NULL,
      last_name TEXT NOT NULL,
      email TEXT NOT NULL,
      dni TEXT NOT NULL,
      entry_time TEXT NOT NULL,
      exit_time TEXT NOT NULL,
      hours_worked INTEGER NOT NULL,
      x_lite TEXT NOT NULL
    )
  `),await Ve.execute(`
    CREATE TABLE IF NOT EXISTS break_schedules (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      day TEXT NOT NULL,
      start_time TEXT NOT NULL,
      end_time TEXT NOT NULL,
      week INTEGER NOT NULL,
      month INTEGER NOT NULL,
      year INTEGER NOT NULL,
      UNIQUE(employee_id, day, week, month, year)
    )
  `),await Ve.execute(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      responses INTEGER NOT NULL DEFAULT 0,
      nps INTEGER NOT NULL DEFAULT 0,
      csat INTEGER NOT NULL DEFAULT 0,
      rd INTEGER NOT NULL DEFAULT 0
    )
  `)}async function Ia(){try{return await Ht(),await he.select().from(Rr).all()}catch(t){throw console.error("Error al obtener empleados:",t),new Error(`No se pudieron obtener los empleados: ${t instanceof Error?t.message:String(t)}`)}}async function Ea(t,e){try{await he.update(Rr).set({xLite:e}).where(u`id = ${t}`).run()}catch(s){throw console.error("Error al actualizar X LITE del empleado:",s),new Error(`No se pudo actualizar X LITE del empleado: ${s instanceof Error?s.message:String(s)}`)}}async function La(t,e,s){try{return await Ht(),await he.select().from(Ct).where(u`employee_id = ${t} AND month = ${e} AND year = ${s}`).all()}catch(r){throw console.error("Error al obtener horarios de break:",r),new Error(`No se pudieron obtener los horarios de break: ${r instanceof Error?r.message:String(r)}`)}}async function Aa(t){try{console.log("Intentando actualizar horario de break:",t),(await he.update(Ct).set({startTime:t.startTime,endTime:t.endTime}).where(u`
        employee_id = ${t.employeeId} AND
        day = ${t.day} AND
        week = ${t.week} AND
        month = ${t.month} AND
        year = ${t.year}
      `).run()).rowsAffected===0&&await he.insert(Ct).values(t).run(),console.log("Horario de break actualizado o insertado con éxito")}catch(e){throw console.error("Error detallado al actualizar horario de break:",e),new Error(`No se pudo actualizar el horario de break: ${e instanceof Error?e.message:String(e)}`)}}async function $a(){try{return await Ht(),await he.select().from(Tr).all()}catch(t){throw console.error("Error al obtener usuarios:",t),new Error(`No se pudieron obtener los usuarios: ${t instanceof Error?t.message:String(t)}`)}}async function Oa(t){try{await he.update(Tr).set(t).where(u`id = ${t.id}`).run()}catch(e){throw console.error("Error al actualizar usuario:",e),new Error(`No se pudo actualizar el usuario: ${e instanceof Error?e.message:String(e)}`)}}export{La as a,Aa as b,$a as c,Oa as d,Ia as g,Ea as u};
